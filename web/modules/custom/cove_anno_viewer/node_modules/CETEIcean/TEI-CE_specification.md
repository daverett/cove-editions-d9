# TEI Custom Elements Specification and Contract

When CETEIcean processes a TEI document, the document structures will by default be converted as follows:

## Elements

All tag names will be converted into [prefix]-[lowercased tagname]. The prefix can be defined in a behaviors object. There must be one prefix defined per XML namespace. There are three predefined prefixes:

```js
  "namespaces": {
    "tei": "http://www.tei-c.org/ns/1.0",
    "teieg": "http://www.tei-c.org/ns/Examples",
    "rng": "http://relaxng.org/ns/structure/1.0"  
  }   
```

These prefixes can be remapped in the behaviors object passed to CETEIcean.

### CETEIcean-created Elements

CETEIcean may add the following elements to markup it processes:

* `<cetei-content>`: holds any content returned from a behavior function call.
* `<cetei-original`: wraps any original content that has been hidden and replaced by the result of a behavior function call.

## Attributes

CETEIcean adds a number of data attributes when it processes an XML element:

* `@data-origname`: contains the original tag name with whatever upper- or lowercasing it used. The HTML DOM normalizes tag names to uppercase.
* `@data-origatts`: contains a list of attribute names on the element before it was processed with whatever upper- or lowercasing they used. The HTML DOM normalizes attribute names to lowercase.
* `@data-processed`: a flag CETEIcean uses to determine whether elements have had behaviors applied. Normally, this will happen upon insertion into the browser DOM.
* `@data-empty`: a flag CETEIcean uses to mark empty elements (these may not remain empty after behaviors have been applied).

### Automatically Converted Attributes

* `@xml:id` is preserved and the value copied to `@id`.
* `@xml:lang` is preserved and the value copied to `@lang`.
* `@xmlns` is removed and its value copied to `@data-xmlns`.
* `@rendition` is preserved and its value copied to `@class`.

## Processing Instructions and Comments

PIs and comments are copied over into the result, so, for example, `<?xml-model?>` PIs pointing to a schema will be present before the root element of the converted document. The XML declaration, if present, is not a PI, and will not be copied over.

## Document Type Declarations

DTDs are not copied over into the result.

## Contract

If a source XML document has been processed into CETEIcean Custom Elements and is then re-serialized into XML using the `CETEI.utilities` instance method `resetAndSerialize()`, then the result will be logically equivalent to the source, provided that additional processing has not altered the document. Note that custom behaviors have direct access to the DOM, and thus are capable of directly manipulating the document in any way. No guarantees can be made as to the consistency of a serialized document if it has been rearranged, fo example.

This contract means that CETEIcean can be used in conjunction with in-browser editing or annotation tools to produce prospectively valid output XML.

For example, the built-in behavior for TEI `<ref>` is to create an HTML anchor tag with the content being the content of the `<ref>` and the `@href` attribute containing the pointer in the `@target` of the `<ref>` (or the first pointer if there are more than one). Given an element like

```xml
<ref target="https://github.com/TEIC/TEI/blob/dev/P5/Source/guidelines-en.xml" mimeType="application/tei+xml">guidelines-en.xml</ref>
```

The structure CETEIcean creates will look like this:

```xml
<tei-ref target="https://github.com/TEIC/TEI/blob/dev/P5/Source/guidelines-en.xml" mimetype="application/tei+xml" data-origname="ref" data-origatts="target mimeType" data-processed="">
  <cetei-original hidden="" data-original="">guidelines-en.xml</cetei-original>
  <a href="https://github.com/TEIC/TEI/blob/dev/P5/Source/guidelines-en.xml">guidelines-en.xml</a>
</tei-ref>
```

If this element is loaded into a variable and then passed to the `CETEI.utilities.copyAndReset()` function, the result will be:

```xml
<tei-ref target="https://github.com/TEIC/TEI/blob/dev/P5/Source/guidelines-en.xml" mimetype="application/tei+xml" data-origname="ref" data-origatts="target mimeType">guidelines-en.xml</tei-ref>
```

that is, the element as it was after CETEIcean has loaded it, but before it was inserted into the document DOM and had behaviors applied to it.

If this result is then passed to the `CETEI.utilities.serialize()` function, the output is

```xml
<ref target="https://github.com/TEIC/TEI/blob/dev/P5/Source/guidelines-en.xml" mimeType="application/tei+xml">guidelines-en.xml</ref>
```

CETEIcean's contract means that 


(function(x,T){typeof exports=="object"&&typeof module<"u"?T(exports):typeof define=="function"&&define.amd?define(["exports"],T):(x=typeof globalThis<"u"?globalThis:x||self,T(x.TEIPlugin={}))})(this,function(x){"use strict";const T="not-annotatable",R=`.${T}`;/mac/i.test(navigator.userAgentData?navigator.userAgentData.platform:navigator.platform);const $=e=>{const t=e.cloneContents();return t.querySelectorAll(R).forEach(n=>n.remove()),t},z=e=>e.every(t=>t.range instanceof Range&&!t.range.collapsed),G=(e,t,n)=>{const o=document.createRange(),r=t;o.setStart(r,0),o.setEnd(e.startContainer,e.startOffset);const s=$(o).textContent,a=e.toString(),c=s.length||0,d=c+a.length;return{quote:a,start:c,end:d,range:e}},J=(e,t)=>{var n,o;const{start:r,end:s}=e,a=e.offsetReference||t,c=document.createNodeIterator(t,NodeFilter.SHOW_TEXT,u=>{var g;return(g=u.parentElement)!=null&&g.closest(R)?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT});let d=0;const i=document.createRange();let l=c.nextNode();l===null&&console.error("Could not revive annotation target. Content missing.");let f=!a;for(;l!==null;){if(f||(f=a==null?void 0:a.contains(l)),f){const u=((n=l.textContent)==null?void 0:n.length)||0;if(d+u>r){i.setStart(l,r-d);break}d+=u}l=c.nextNode()}for(;l!==null;){const u=((o=l.textContent)==null?void 0:o.length)||0;if(d+u>=s){i.setEnd(l,s-d);break}d+=u,l=c.nextNode()}return{...e,range:i}},X=(e,t)=>z(e.selector)?e:{...e,selector:e.selector.map(n=>n.range instanceof Range&&!n.range.collapsed?n:J(n,t))},Q=[];for(let e=0;e<256;++e)Q.push((e+256).toString(16).slice(1));typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const Z=[];for(let e=0;e<256;++e)Z.push((e+256).toString(16).slice(1));typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const ee="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict";((e=21)=>{let t="",n=crypto.getRandomValues(new Uint8Array(e|=0));for(;e--;)t+=ee[n[e]&63];return t})();const K=typeof navigator<"u"?navigator.userAgent.toLowerCase().indexOf("firefox")>0:!1;function L(e,t,n,o){e.addEventListener?e.addEventListener(t,n,o):e.attachEvent&&e.attachEvent("on".concat(t),n)}function C(e,t,n,o){e.removeEventListener?e.removeEventListener(t,n,o):e.detachEvent&&e.detachEvent("on".concat(t),n)}function F(e,t){const n=t.slice(0,t.length-1);for(let o=0;o<n.length;o++)n[o]=e[n[o].toLowerCase()];return n}function M(e){typeof e!="string"&&(e=""),e=e.replace(/\s/g,"");const t=e.split(",");let n=t.lastIndexOf("");for(;n>=0;)t[n-1]+=",",t.splice(n,1),n=t.lastIndexOf("");return t}function te(e,t){const n=e.length>=t.length?e:t,o=e.length>=t.length?t:e;let r=!0;for(let s=0;s<n.length;s++)o.indexOf(n[s])===-1&&(r=!1);return r}const S={backspace:8,"⌫":8,tab:9,clear:12,enter:13,"↩":13,return:13,esc:27,escape:27,space:32,left:37,up:38,right:39,down:40,del:46,delete:46,ins:45,insert:45,home:36,end:35,pageup:33,pagedown:34,capslock:20,num_0:96,num_1:97,num_2:98,num_3:99,num_4:100,num_5:101,num_6:102,num_7:103,num_8:104,num_9:105,num_multiply:106,num_add:107,num_enter:108,num_subtract:109,num_decimal:110,num_divide:111,"⇪":20,",":188,".":190,"/":191,"`":192,"-":K?173:189,"=":K?61:187,";":K?59:186,"'":222,"[":219,"]":221,"\\":220},m={"⇧":16,shift:16,"⌥":18,alt:18,option:18,"⌃":17,ctrl:17,control:17,"⌘":91,cmd:91,command:91},I={16:"shiftKey",18:"altKey",17:"ctrlKey",91:"metaKey",shiftKey:16,ctrlKey:17,altKey:18,metaKey:91},h={16:!1,18:!1,17:!1,91:!1},y={};for(let e=1;e<20;e++)S["f".concat(e)]=111+e;let p=[],A=null,V="all";const E=new Map,N=e=>S[e.toLowerCase()]||m[e.toLowerCase()]||e.toUpperCase().charCodeAt(0),ne=e=>Object.keys(S).find(t=>S[t]===e),oe=e=>Object.keys(m).find(t=>m[t]===e);function Y(e){V=e||"all"}function _(){return V||"all"}function re(){return p.slice(0)}function se(){return p.map(e=>ne(e)||oe(e)||String.fromCharCode(e))}function ce(){const e=[];return Object.keys(y).forEach(t=>{y[t].forEach(n=>{let{key:o,scope:r,mods:s,shortcut:a}=n;e.push({scope:r,shortcut:a,mods:s,keys:o.split("+").map(c=>N(c))})})}),e}function ae(e){const t=e.target||e.srcElement,{tagName:n}=t;let o=!0;const r=n==="INPUT"&&!["checkbox","radio","range","button","file","reset","submit","color"].includes(t.type);return(t.isContentEditable||(r||n==="TEXTAREA"||n==="SELECT")&&!t.readOnly)&&(o=!1),o}function ie(e){return typeof e=="string"&&(e=N(e)),p.indexOf(e)!==-1}function le(e,t){let n,o;e||(e=_());for(const r in y)if(Object.prototype.hasOwnProperty.call(y,r))for(n=y[r],o=0;o<n.length;)n[o].scope===e?n.splice(o,1).forEach(s=>{let{element:a}=s;return j(a)}):o++;_()===e&&Y(t||"all")}function ue(e){let t=e.keyCode||e.which||e.charCode;const n=p.indexOf(t);if(n>=0&&p.splice(n,1),e.key&&e.key.toLowerCase()==="meta"&&p.splice(0,p.length),(t===93||t===224)&&(t=91),t in h){h[t]=!1;for(const o in m)m[o]===t&&(w[o]=!1)}}function q(e){if(typeof e>"u")Object.keys(y).forEach(r=>{Array.isArray(y[r])&&y[r].forEach(s=>P(s)),delete y[r]}),j(null);else if(Array.isArray(e))e.forEach(r=>{r.key&&P(r)});else if(typeof e=="object")e.key&&P(e);else if(typeof e=="string"){for(var t=arguments.length,n=new Array(t>1?t-1:0),o=1;o<t;o++)n[o-1]=arguments[o];let[r,s]=n;typeof r=="function"&&(s=r,r=""),P({key:e,scope:r,method:s,splitKey:"+"})}}const P=e=>{let{key:t,scope:n,method:o,splitKey:r="+"}=e;M(t).forEach(s=>{const a=s.split(r),c=a.length,d=a[c-1],i=d==="*"?"*":N(d);if(!y[i])return;n||(n=_());const l=c>1?F(m,a):[],f=[];y[i]=y[i].filter(u=>{const g=(o?u.method===o:!0)&&u.scope===n&&te(u.mods,l);return g&&f.push(u.element),!g}),f.forEach(u=>j(u))})};function B(e,t,n,o){if(t.element!==o)return;let r;if(t.scope===n||t.scope==="all"){r=t.mods.length>0;for(const s in h)Object.prototype.hasOwnProperty.call(h,s)&&(!h[s]&&t.mods.indexOf(+s)>-1||h[s]&&t.mods.indexOf(+s)===-1)&&(r=!1);(t.mods.length===0&&!h[16]&&!h[18]&&!h[17]&&!h[91]||r||t.shortcut==="*")&&(t.keys=[],t.keys=t.keys.concat(p),t.method(e,t)===!1&&(e.preventDefault?e.preventDefault():e.returnValue=!1,e.stopPropagation&&e.stopPropagation(),e.cancelBubble&&(e.cancelBubble=!0)))}}function H(e,t){const n=y["*"];let o=e.keyCode||e.which||e.charCode;if(!w.filter.call(this,e))return;if((o===93||o===224)&&(o=91),p.indexOf(o)===-1&&o!==229&&p.push(o),["metaKey","ctrlKey","altKey","shiftKey"].forEach(c=>{const d=I[c];e[c]&&p.indexOf(d)===-1?p.push(d):!e[c]&&p.indexOf(d)>-1?p.splice(p.indexOf(d),1):c==="metaKey"&&e[c]&&(p=p.filter(i=>i in I||i===o))}),o in h){h[o]=!0;for(const c in m)m[c]===o&&(w[c]=!0);if(!n)return}for(const c in h)Object.prototype.hasOwnProperty.call(h,c)&&(h[c]=e[I[c]]);e.getModifierState&&!(e.altKey&&!e.ctrlKey)&&e.getModifierState("AltGraph")&&(p.indexOf(17)===-1&&p.push(17),p.indexOf(18)===-1&&p.push(18),h[17]=!0,h[18]=!0);const r=_();if(n)for(let c=0;c<n.length;c++)n[c].scope===r&&(e.type==="keydown"&&n[c].keydown||e.type==="keyup"&&n[c].keyup)&&B(e,n[c],r,t);if(!(o in y))return;const s=y[o],a=s.length;for(let c=0;c<a;c++)if((e.type==="keydown"&&s[c].keydown||e.type==="keyup"&&s[c].keyup)&&s[c].key){const d=s[c],{splitKey:i}=d,l=d.key.split(i),f=[];for(let u=0;u<l.length;u++)f.push(N(l[u]));f.sort().join("")===p.sort().join("")&&B(e,d,r,t)}}function w(e,t,n){p=[];const o=M(e);let r=[],s="all",a=document,c=0,d=!1,i=!0,l="+",f=!1,u=!1;for(n===void 0&&typeof t=="function"&&(n=t),Object.prototype.toString.call(t)==="[object Object]"&&(t.scope&&(s=t.scope),t.element&&(a=t.element),t.keyup&&(d=t.keyup),t.keydown!==void 0&&(i=t.keydown),t.capture!==void 0&&(f=t.capture),typeof t.splitKey=="string"&&(l=t.splitKey),t.single===!0&&(u=!0)),typeof t=="string"&&(s=t),u&&q(e,s);c<o.length;c++)e=o[c].split(l),r=[],e.length>1&&(r=F(m,e)),e=e[e.length-1],e=e==="*"?"*":N(e),e in y||(y[e]=[]),y[e].push({keyup:d,keydown:i,scope:s,mods:r,shortcut:o[c],method:n,key:o[c],splitKey:l,element:a});if(typeof a<"u"&&window){if(!E.has(a)){const g=function(){let b=arguments.length>0&&arguments[0]!==void 0?arguments[0]:window.event;return H(b,a)},O=function(){let b=arguments.length>0&&arguments[0]!==void 0?arguments[0]:window.event;H(b,a),ue(b)};E.set(a,{keydownListener:g,keyupListenr:O,capture:f}),L(a,"keydown",g,f),L(a,"keyup",O,f)}if(!A){const g=()=>{p=[]};A={listener:g,capture:f},L(window,"focus",g,f)}}}function de(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"all";Object.keys(y).forEach(n=>{y[n].filter(o=>o.scope===t&&o.shortcut===e).forEach(o=>{o&&o.method&&o.method()})})}function j(e){const t=Object.values(y).flat();if(t.findIndex(n=>{let{element:o}=n;return o===e})<0){const{keydownListener:n,keyupListenr:o,capture:r}=E.get(e)||{};n&&o&&(C(e,"keyup",o,r),C(e,"keydown",n,r),E.delete(e))}if((t.length<=0||E.size<=0)&&(Object.keys(E).forEach(n=>{const{keydownListener:o,keyupListenr:r,capture:s}=E.get(n)||{};o&&r&&(C(n,"keyup",r,s),C(n,"keydown",o,s),E.delete(n))}),E.clear(),Object.keys(y).forEach(n=>delete y[n]),A)){const{listener:n,capture:o}=A;C(window,"focus",n,o),A=null}}const D={getPressedKeyString:se,setScope:Y,getScope:_,deleteScope:le,getPressedKeyCodes:re,getAllKeyCodes:ce,isPressed:ie,filter:ae,trigger:de,unbind:q,keyMap:S,modifier:m,modifierMap:I};for(const e in D)Object.prototype.hasOwnProperty.call(D,e)&&(w[e]=D[e]);if(typeof window<"u"){const e=window.hotkeys;w.noConflict=t=>(t&&window.hotkeys===w&&(window.hotkeys=e),w),window.hotkeys=w}const fe=(e,t,n)=>{let o=e,r=n;const s=document.createNodeIterator(t,NodeFilter.SHOW_TEXT);let a=s.nextNode(),c=!0;do a instanceof Text&&(a.length<r?r-=a.length:(o=a,c=!1)),a=s.nextNode();while(a&&c);return{node:o,offset:r}},U=(e,t=[])=>{let n,o,r;if(e.nodeType===Node.ELEMENT_NODE&&e.hasAttribute("xml:id")?t.push("/"):e.parentNode&&(t=U(e.parentNode,t)),e.nodeType===Node.ELEMENT_NODE&&e.nodeName.toLowerCase().startsWith("tei-")){const s=e;s.hasAttribute("xml:id")?r=`[@xml:id='${s.getAttribute("xml:id")}']`:(n=`count(preceding-sibling::${s.localName})`,o=document.evaluate(n,e,null,XPathResult.NUMBER_TYPE,null).numberValue+1,r=`[${o}]`),t.push("/"),t.push(s.getAttribute("data-origname")+r)}return t},pe=(e,t,n)=>{const o=i=>i?i.nodeName.toLowerCase().indexOf("tei-")===0?i:o(i.parentNode):null,r=(i,l,f)=>{const u=document.createRange();return u.setStart(i,0),u.setEnd(l,f),u.toString().length},s=r(o(n.startContainer),n.startContainer,n.startOffset),a=r(o(n.endContainer),n.endContainer,n.endOffset),c=e.join("")+"::"+s,d=t.join("")+"::"+a;return{start:c,end:d}},ye=e=>{var a;const{range:t}=e,n=U(t.startContainer),o=U(t.endContainer),{start:r,end:s}=pe(n,o,t);return{start:e.start,startSelector:{type:"XPathSelector",value:r},end:e.end,endSelector:{type:"XPathSelector",value:s},quote:(a=e.quote)==null?void 0:a.replace(/\s+/g," "),range:t}},ge=(e,t)=>{var o,r;const n=Array.isArray(e.selector)?e.selector[0]:e.selector;if("start"in n&&"end"in n)return X(e,t);{const s=(o=n.startSelector)==null?void 0:o.value,a=(r=n.endSelector)==null?void 0:r.value;if(!s||!a)throw console.error(e),"Could not revive TEI target.";const c=k=>{const v=k.indexOf("::");if(v<0)return;const ke=k.substring(0,v).replace(/\/([^[/]+)/g,(xe,be)=>"/tei-"+be.toLowerCase()).replace(/xml:/g,""),we=document.evaluate("."+ke,t,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue,Oe=parseInt(k.substring(v+2));return[we,Oe]},[d,i]=c(s),[l,f]=c(a),u=document.createRange(),g=(k,v)=>k.firstChild instanceof Text&&k.firstChild.length>=v?{node:k.firstChild,offset:v}:fe(k.firstChild,k,v),O=g(d,i);u.setStart(O.node,O.offset);const b=g(l,f);u.setEnd(b.node,b.offset);const Ee=G(u,t);return X({...e,selector:[{...Ee,...n,range:u}]},t)}},W=e=>t=>{const n=ge(t,e);return{...t,selector:n.selector.map(ye)}},he=e=>t=>({...t,target:W(e)(t.target)}),me=e=>{const t=e.element,n=he(t),o=W(t),r=e.state.store,s=r.addAnnotation;r.addAnnotation=(i,l)=>{const{selector:f}=i.target;return"startSelector"in f&&"start"in f?s(i,l):s(n(i),l)};const a=r.bulkAddAnnotation;r.bulkAddAnnotation=(i,l=!0,f)=>{const u=i.map(g=>{const{selector:O}=g.target;return"startSelector"in O&&"start"in O?g:n(g)});return a(u,l,f)};const c=r.updateAnnotation;r.updateAnnotation=(i,l)=>c(n(i),l);const d=r.updateTarget;return r.updateTarget=(i,l)=>d(o(i),l),{...e,state:{...e.state,store:r}}};x.TEIPlugin=me,Object.defineProperty(x,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=text-annotator-tei.umd.js.map

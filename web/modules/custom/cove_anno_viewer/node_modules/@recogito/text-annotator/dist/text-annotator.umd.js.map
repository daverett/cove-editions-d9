{"version":3,"file":"text-annotator.umd.js","sources":["../src/utils/isNotAnnotatable.ts","../src/utils/cancelSingleClickEvents.ts","../src/utils/cloneEvents.ts","../src/utils/device.ts","../src/utils/programmaticallyFocusable.ts","../src/utils/debounce.ts","../src/utils/splitAnnotatableRanges.ts","../src/utils/getQuoteContext.ts","../src/utils/isRevived.ts","../src/utils/isWhitespaceOrEmpty.ts","../src/utils/mergeClientRects.ts","../src/utils/rangeToSelector.ts","../src/utils/reviveSelector.ts","../src/utils/reviveTarget.ts","../src/utils/reviveAnnotation.ts","../src/utils/trimRangeToContainer.ts","../src/api/scrollIntoView.ts","../src/highlight/HighlightStyle.ts","../src/highlight/HighlightPainter.ts","../src/highlight/viewport.ts","../src/highlight/baseRenderer.ts","../src/highlight/canvas/canvasRenderer.ts","../../../node_modules/colord/index.mjs","../src/highlight/highlights/highlightsRenderer.ts","../../../node_modules/dequal/lite/index.mjs","../src/highlight/span/spansRenderer.ts","../../../node_modules/uuid/dist/esm-browser/stringify.js","../../../node_modules/uuid/dist/esm-browser/rng.js","../../../node_modules/uuid/dist/esm-browser/native.js","../../../node_modules/uuid/dist/esm-browser/v4.js","../../../node_modules/@annotorious/core/dist/annotorious-core.es.js","../src/model/w3c/W3CTextFormatAdapter.ts","../../../node_modules/quickselect/index.js","../../../node_modules/rbush/index.js","../src/state/spatialTree.ts","../src/state/TextAnnotatorState.ts","../src/presence/PresencePainter.ts","../../../node_modules/hotkeys-js/dist/hotkeys.esm.js","../src/SelectionHandler.ts","../src/TextAnnotatorOptions.ts","../src/TextAnnotator.ts"],"sourcesContent":["export const NOT_ANNOTATABLE_CLASS = 'not-annotatable';\n\nexport const NOT_ANNOTATABLE_SELECTOR = `.${NOT_ANNOTATABLE_CLASS}`;\n\nexport const isNotAnnotatable = (node: Node): boolean => {\n  const closestNotAnnotatable = node instanceof HTMLElement\n    ? node.closest(NOT_ANNOTATABLE_SELECTOR)\n    : node.parentElement?.closest(NOT_ANNOTATABLE_SELECTOR);\n  return Boolean(closestNotAnnotatable);\n}\n\nexport const isRangeAnnotatable = (range: Range): boolean => {\n  const ancestor = range.commonAncestorContainer;\n  return !isNotAnnotatable(ancestor);\n}","import { NOT_ANNOTATABLE_SELECTOR } from './isNotAnnotatable';\n\n/**\n * Calls .preventDefault() on click events in annotable areas, in order\n * to prevent problematic default browser behavior. (Specifically: keep\n * Chrome Android from triggering word selection on single click.)\n */\nexport const cancelSingleClickEvents = (container: HTMLElement) =>\n  container.addEventListener('click', event => {\n    const targetElement = event.target as HTMLElement;\n\n    const shouldPrevent =\n      // Allow clicks within not-annotatable elements\n      !targetElement.closest(NOT_ANNOTATABLE_SELECTOR)\n      // Allow clicks on links\n      && !(event.target as Element).closest('a');\n\n    if (shouldPrevent)\n      event.preventDefault();\n  });\n","/**\n * Events need to be manually mapped into new objects:\n * 1. It preserves the `target` and `currentTarget` properties.\n *    Otherwise, they will be `null` when the event is read beyond the handler.\n * 2. Spread operator can copy only own enumerable properties, not inherited ones.\n *    Therefore, we need to manually copy the props we're interested in.\n * @see https://developer.mozilla.org/en-US/docs/Web/API/Event/currentTarget\n * @see https://github.com/recogito/text-annotator-js/commit/65d13f3108c429311cf8c2523f6babbbc946013d#r144041390\n */\n\nexport const clonePointerEvent = (event: PointerEvent): PointerEvent => ({\n  ...event,\n  type: event.type,\n  x: event.x,\n  y: event.y,\n  clientX: event.clientX,\n  clientY: event.clientY,\n  offsetX: event.offsetX,\n  offsetY: event.offsetY,\n  screenX: event.screenX,\n  screenY: event.screenY,\n  isPrimary: event.isPrimary,\n  altKey: event.altKey,\n  ctrlKey: event.ctrlKey,\n  metaKey: event.metaKey,\n  shiftKey: event.shiftKey,\n  button: event.button,\n  buttons: event.buttons,\n  currentTarget: event.currentTarget,\n  target: event.target,\n  defaultPrevented: event.defaultPrevented,\n  detail: event.detail,\n  eventPhase: event.eventPhase,\n  pointerId: event.pointerId,\n  pointerType: event.pointerType,\n  timeStamp: event.timeStamp\n})\n\nexport const cloneKeyboardEvent = (event: KeyboardEvent): KeyboardEvent => ({\n  ...event,\n  type: event.type,\n  key: event.key,\n  code: event.code,\n  location: event.location,\n  repeat: event.repeat,\n  altKey: event.altKey,\n  ctrlKey: event.ctrlKey,\n  metaKey: event.metaKey,\n  shiftKey: event.shiftKey,\n  currentTarget: event.currentTarget,\n  target: event.target,\n  defaultPrevented: event.defaultPrevented,\n  detail: event.detail,\n  timeStamp: event.timeStamp\n})\n","// @ts-ignore\nexport const isMac = /mac/i.test(navigator.userAgentData ? navigator.userAgentData.platform : navigator.platform);\n","/**\n * Makes an element programmatically focusable by adding a `tabindex=\"-1\"` attribute.\n * Or does nothing if the element is already focusable 🤷🏻\n * It's required to process keyboard events on an element that is not natively focusable.\n */\nexport const programmaticallyFocusable = (container: HTMLElement) => {\n  if (!container.hasAttribute('tabindex') && container.tabIndex < 0) {\n    container.setAttribute('tabindex', '-1');\n  }\n\n  container.classList.add('no-focus-outline');\n};\n","export const debounce = <T extends (...args: any[]) => void>(func: T, delay = 10): T => {\n\tlet timeoutId: ReturnType<typeof setTimeout>;\n\n\treturn ((...args: any[]) => {\n\t\tclearTimeout(timeoutId);\n\t\ttimeoutId = setTimeout(() => func.apply(this, args), delay);\n\t}) as T;\n}\n","import { isRangeAnnotatable, NOT_ANNOTATABLE_CLASS, NOT_ANNOTATABLE_SELECTOR } from './isNotAnnotatable';\n\nconst iterateNotAnnotatableElements = function*(range: Range): Generator<HTMLElement> {\n  const notAnnotatableIterator = document.createNodeIterator(\n    range.commonAncestorContainer,\n    NodeFilter.SHOW_ELEMENT,\n    (node) =>\n      node instanceof HTMLElement // Only elements that can have the class applied\n      && node.classList.contains(NOT_ANNOTATABLE_CLASS) // Only elements that are not annotatable\n      && !node.parentElement.closest(NOT_ANNOTATABLE_SELECTOR) // Only elements that are not descendants of a not annotatable element\n      && range.intersectsNode(node) // Only elements that are within the range\n        ? NodeFilter.FILTER_ACCEPT\n        : NodeFilter.FILTER_SKIP\n  );\n\n  let notAnnotatableNode: Node | null;\n\n  while ((notAnnotatableNode = notAnnotatableIterator.nextNode())) {\n    if (notAnnotatableNode instanceof HTMLElement) {\n      yield notAnnotatableNode;\n    }\n  }\n}\n\n/**\n * Splits a DOM Range into one or more ranges that span annotatable content only.\n */\nexport const splitAnnotatableRanges = (range: Range): Range[] => {\n  if (!isRangeAnnotatable(range)) return [];\n\n  const annotatableRanges: Range[] = [];\n\n  let prevNotAnnotatable: HTMLElement | null = null;\n\n  for (const notAnnotatable of iterateNotAnnotatableElements(range)) {\n    let subRange: Range;\n\n    // From the start of the range to the not annotatable element.\n    // If selection starts on the non-annotatable element, a collapsed range will be created and ignored.\n    if (!prevNotAnnotatable) {\n      subRange = range.cloneRange();\n      subRange.setEndBefore(notAnnotatable);\n    } else {\n      // From the previous not annotatable element to the current not annotatable element\n      subRange = document.createRange();\n      subRange.setStartAfter(prevNotAnnotatable);\n      subRange.setEndBefore(notAnnotatable);\n    }\n\n    if (!subRange.collapsed)\n      annotatableRanges.push(subRange);\n\n    prevNotAnnotatable = notAnnotatable;\n  }\n\n  // From the last not annotatable element to the end of the parent range\n  if (prevNotAnnotatable) {\n    const lastRange = range.cloneRange();\n    lastRange.setStartAfter(prevNotAnnotatable);\n    if (!lastRange.collapsed) {\n      annotatableRanges.push(lastRange);\n    }\n  }\n\n  return annotatableRanges.length > 0 ? annotatableRanges : [range];\n}\n\nexport const getRangeAnnotatableContents = (range: Range): DocumentFragment => {\n  const contents = range.cloneContents();\n  contents.querySelectorAll(NOT_ANNOTATABLE_SELECTOR).forEach((el) => el.remove());\n  return contents;\n}\n","import { getRangeAnnotatableContents } from './splitAnnotatableRanges';\n\nexport const getQuoteContext = (\n  range: Range, \n  container: HTMLElement, \n  length = 10,\n  offsetReferenceSelector?: string\n) => {\n  const offsetReference: HTMLElement = offsetReferenceSelector\n    ? (range.startContainer.parentElement as HTMLElement).closest(offsetReferenceSelector)!\n    : container;\n\n  const rangeBefore = document.createRange();\n  rangeBefore.setStart(offsetReference, 0);\n  rangeBefore.setEnd(range.startContainer, range.startOffset);\n\n  const before = getRangeAnnotatableContents(rangeBefore).textContent;\n  \n  const rangeAfter = document.createRange();\n  rangeAfter.setStart(range.endContainer, range.endOffset);\n\n  if (offsetReference === document.body)\n    rangeAfter.setEnd(offsetReference, offsetReference.childNodes.length);\n  else\n    rangeAfter.setEndAfter(offsetReference);\n\n  const after = getRangeAnnotatableContents(rangeAfter).textContent;\n\n  return {\n    prefix: before.substring(before.length - length),\n    suffix: after.substring(0, length)\n  }\n}\n","import type { TextSelector } from '../model';\n\nexport const isRevived = (selector: TextSelector[]) =>\n  selector.every(s => s.range instanceof Range && !s.range.collapsed);\n","export const whitespaceOrEmptyRegex = /^\\s*$/;\n\nexport const isWhitespaceOrEmpty = (range: Range): boolean => whitespaceOrEmptyRegex.test(range.toString())\n","// The three topological relations we need to check for\ntype Relation = \n  // Inline elements, same height, directly adjacent\n  'inline-adjacent' |\n  // Inline elements, A fully contains B\n  'inline-contains' |\n  // Inline elements, A is fully contained inside B\n  'inline-is-contained' |\n  // At least one block element, A fully contains B\n  'block-contains' |\n  // At least one block element, A is fully contained in B\n  'block-is-contained';\n\n// Note that this is not a general topology test. Takes a \n// few shortcuts to test ONLY the situations we'll encounter\n// with text selections.\nconst getRelation = (rectA: DOMRect, rectB: DOMRect): Relation | undefined => {\n  const round = (num: number ) => Math.round(num * 10) / 10;\n\n  // Some browsers have fractional pixel differences (looking at you FF!)\n  const a = {\n    top: round(rectA.top),\n    bottom: round(rectA.bottom),\n    left: round(rectA.left),\n    right: round(rectA.right)\n  };\n\n  const b = {\n    top: round(rectB.top),\n    bottom: round(rectB.bottom),\n    left: round(rectB.left),\n    right: round(rectB.right)\n  };\n\n  if (Math.abs(a.top - b.top) < 0.5 && Math.abs(a.bottom - b.bottom) < 0.5) {\n    // Same height - check for containment and adjacency\n    if (Math.abs(a.left - b.right) < 0.5 || Math.abs(a.right - b.left) < 0.5)\n      return 'inline-adjacent';\n\n    if (a.left >= b.left && a.right <= b.right)\n      return 'inline-is-contained';\n\n    if (a.left <= b.left && a.right >= b.right)\n      return 'inline-contains';\n  } else {\n    // Different heights - check for containment\n    if (a.top <= b.top && a.bottom >= b.bottom) {\n      if (a.left <= b.left && a.right >= b.right) {\n        return 'block-contains'\n      }\n    } else if (a.top >= b.top && a.bottom <= b.bottom) {\n      if (a.left >= b.left && a.right <= b.right) {\n        return 'block-is-contained';\n      }\n    }\n  }\n}\n\nconst union = (a: DOMRect, b: DOMRect): DOMRect => {\n  const left = Math.min(a.left, b.left);\n  const right = Math.max(a.right, b.right);\n  const top = Math.min(a.top, b.top);\n  const bottom = Math.max(a.bottom, b.bottom);\n\n  return new DOMRect(left, top, right - left, bottom - top);\n}\n\nexport const mergeClientRects = (rects: DOMRect[]) => rects.reduce<DOMRect[]>((merged, rectA) => {\n  // Some browser report empty rects - discard\n  if (rectA.width === 0 || rectA.height === 0)\n    return merged;\n\n  let next = [...merged];\n\n  let wasMerged = false;\n\n  for (const rectB of merged) {\n    const relation = getRelation(rectA, rectB);\n    \n    if (relation === 'inline-adjacent') {\n      // A and B are adjacent - remove B and keep union\n      next = next.map(r => r === rectB ? union(rectA, rectB) : r);\n      wasMerged = true;\n      break;\n    } else if (relation === 'inline-contains') {\n      // A contains B - remove B and keep A\n      next = next.map(r => r === rectB ? rectA : r);\n      wasMerged = true;\n      break;\n    } else if (relation === 'inline-is-contained') {\n      // B contains A - skip A\n      wasMerged = true;\n      break;\n    } else if (relation === 'block-contains' || relation === 'block-is-contained') {\n      // Block containment - keep the element with smaller width\n      if (rectA.width < rectB.width) {\n        next = next.map(r => r === rectB ? rectA : r);\n      }\n      wasMerged = true;\n      break;\n    }\n  }\n\n  return wasMerged ? next : [ ...next, rectA ];\n}, []);\n\nexport const toDomRectList = (rects: DOMRect[]): DOMRectList => ({\n  length: rects.length,\n  item: (index) => rects[index],\n  [Symbol.iterator]: function* (): ArrayIterator<DOMRect> {\n    for (let i = 0; i < this.length; i++)\n      yield this.item(i)!;\n  }\n})\n\n/* Pixels that rects can be apart vertically while still\n// being considered to be on the same line.\nconst TOLERANCE = 3;\n\nexport const mergeClientRects = (rects: DOMRect[]) => {\n  const lines: DOMRect[][] = [];\n\n  // Sort rects from the top, to make grouping simpler\n  rects.sort((a, b) => a.top - b.top);\n\n  // Group rects into lines\n  for (const rect of rects) {\n    if (lines.length === 0 || Math.abs(rect.top - lines[lines.length - 1][0].top) > TOLERANCE) {\n      // Start a new line\n      lines.push([rect]);\n    } else {\n      lines[lines.length - 1].push(rect);\n    }\n  }\n\n  // Merge lines\n  const mergedRects = lines.map(line => {\n    const top = Math.min(...line.map(r => r.top));\n    const bottom = Math.max(...line.map(r => r.bottom));\n    const left = Math.min(...line.map(r => r.left));\n    const right = Math.max(...line.map(r => r.right));\n\n    return {\n      top: top,\n      bottom: bottom,\n      left: left,\n      right: right,\n      height: bottom - top,\n      width: right - left\n    } as DOMRect;\n  }).filter(r => r.height > 0 && r.width > 0);\n\n  // Checks if the given rect contains any other rects\n  const containsOthers = (rect: DOMRect) => mergedRects.some(other =>\n    other !== rect &&\n    other.left >= rect.left &&\n    other.right <= rect.right &&\n    other.top >= rect.top &&\n    other.bottom <= rect.bottom\n  );\n\n  // Remove all rects that contain other rects (block-level elements!)\n  return mergedRects.filter(rect => !containsOthers(rect));\n}\n*/\n","import { getRangeAnnotatableContents } from './splitAnnotatableRanges';\nimport type { TextSelector } from '../model';\n\nexport const rangeToSelector = (\n  range: Range,\n  container: HTMLElement,\n  offsetReferenceSelector?: string\n): TextSelector => {\n  const rangeBefore = document.createRange();\n\n  const offsetReference: HTMLElement = offsetReferenceSelector\n    ? (range.startContainer.parentElement as HTMLElement).closest(offsetReferenceSelector)!\n    : container;\n\n  // A helper range from the start of the container to the start of the selection\n  rangeBefore.setStart(offsetReference, 0);\n  rangeBefore.setEnd(range.startContainer, range.startOffset);\n\n  // A content range before content w/o not annotatable elements\n  const before = getRangeAnnotatableContents(rangeBefore).textContent;\n\n  const quote = range.toString();\n  const start = before.length || 0;\n  const end = start + quote.length;\n\n  return offsetReferenceSelector\n    ? { quote, start, end, range, offsetReference }\n    : { quote, start, end, range };\n}\n","import type { TextSelector } from '../model';\nimport { NOT_ANNOTATABLE_SELECTOR } from './isNotAnnotatable';\n\n/**\n * Creates a new selector object with the revived DOM range from the given text annotation position\n * Only the annotatable elements are processed and counted towards the range\n *\n * @param selector annotation selector with start and end positions\n * @param container the HTML container of the annotated content\n *\n * @returns the revived selector\n */\nexport const reviveSelector = <T extends TextSelector>(selector: T, container: HTMLElement): T => {\n\n  const { start, end } = selector;\n\n  const offsetReference = selector.offsetReference || container;\n\n  const iterator = document.createNodeIterator(container, NodeFilter.SHOW_TEXT, (node) =>\n    node.parentElement?.closest(NOT_ANNOTATABLE_SELECTOR)\n      ? NodeFilter.FILTER_SKIP\n      : NodeFilter.FILTER_ACCEPT\n  );\n\n  // Position that contains the length of the preceding annotatable text nodes\n  let runningOffset = 0;\n\n  const range = document.createRange();\n\n  let n = iterator.nextNode();\n  if (n === null) console.error('Could not revive annotation target. Content missing.');\n\n  // If there's no offset reference, start immediately\n  let startCounting = !offsetReference;\n  while (n !== null) {\n    startCounting ||= offsetReference?.contains(n);\n\n    if (startCounting) {\n      const len = n.textContent?.length || 0;\n\n      if (runningOffset + len > start) {\n        range.setStart(n, start - runningOffset);\n        break;\n      }\n\n      runningOffset += len;\n    }\n\n    n = iterator.nextNode();\n  }\n\n  // set range end\n  while (n !== null) {\n    const len = n.textContent?.length || 0;\n\n    if (runningOffset + len >= end) {\n      range.setEnd(n, end - runningOffset);\n      break;\n    }\n\n    runningOffset += len;\n\n    n = iterator.nextNode();\n  }\n  \n  return {\n    ...selector,\n    range\n  }\n\n}\n","import type { TextAnnotationTarget } from '../model';\nimport { isRevived } from './isRevived';\nimport { reviveSelector } from './reviveSelector';\n\nexport const reviveTarget = <T extends TextAnnotationTarget = TextAnnotationTarget>(target: T, container: HTMLElement): T =>\n  isRevived(target.selector)\n    ? target\n    : ({\n      ...target,\n      selector: target.selector.map(s => s.range instanceof Range && !s.range.collapsed ? s : reviveSelector(s, container))\n    });\n\n\n","import type { TextAnnotation } from '../model';\nimport { isRevived } from './isRevived';\nimport { reviveTarget } from './reviveTarget';\n\nexport const reviveAnnotation = <T extends TextAnnotation>(annotation: T, container: HTMLElement): T =>\n  isRevived(annotation.target.selector)\n    ? annotation\n    : ({ ...annotation, target: reviveTarget(annotation.target, container) });","export const trimRangeToContainer = (\n  range: Range,\n  container: HTMLElement\n): Range => {\n  const trimmedRange = range.cloneRange();\n\n  // If the start is outside the container - set it to the start of the container\n  if (!container.contains(trimmedRange.startContainer)) {\n    trimmedRange.setStart(container, 0);\n  }\n\n  // If the end is outside the container - set it to the end of the container\n  if (!container.contains(trimmedRange.endContainer)) {\n    trimmedRange.setEnd(container, container.childNodes.length);\n  }\n\n  return trimmedRange;\n};\n","import type { TextAnnotationStore } from '../state';\nimport type { TextAnnotation, TextAnnotationTarget } from '../model';\nimport { reviveTarget } from '../utils';\n\nconst getScrollParent = (el: Element) => {\n  if (el === null)\n    return document.scrollingElement;\n\n  const { overflowY } = window.getComputedStyle(el);\n  const isScrollable = overflowY !== 'visible' && overflowY !== 'hidden';\n\n  // Cf. discussion https://stackoverflow.com/questions/35939886/find-first-scrollable-parent\n  if (isScrollable && el.scrollHeight > el.clientHeight)\n    return el;\n  else\n    return getScrollParent(el.parentElement);\n};\n\nexport const scrollIntoView = (\n  container: HTMLElement, store: TextAnnotationStore\n) => (annotationOrId: string | TextAnnotation) => {\n  const id = \n    typeof annotationOrId === 'string' ? annotationOrId : annotationOrId.id;\n\n  // Executes scroll on an annotation with a valid DOM range selector\n  const scroll = (target: TextAnnotationTarget) => {\n    // Parent bounds and client (= visible) height\n    const parentBounds = scrollParent.getBoundingClientRect();\n    const parentHeight = scrollParent.clientHeight;\n    const parentWidth = scrollParent.clientWidth;\n\n    // Position of the annotation relative to viewport\n    // Note: first selector is not necessarily top one...\n    const annotationBounds = target.selector[0].range.getBoundingClientRect();\n\n    // Note: getBoundingClientRect seems to return wrong height! \n    // (Includes block elements?) We'll therefore use the normalized height\n    // from the spatial index!\n    const { width, height } = store.getAnnotationBounds(id);\n\n    // Position of the annotation relative to scrollParent\n    const offsetTop = annotationBounds.top - parentBounds.top;\n    const offsetLeft = annotationBounds.left - parentBounds.left;\n\n    const scrollTop = scrollParent.parentElement ? scrollParent.scrollTop : 0;\n    const scrollLeft = scrollParent.parentElement ? scrollParent.scrollLeft : 0;\n\n    // Scroll the annotation to the center of the viewport\n    const top = offsetTop + scrollTop - (parentHeight - height) / 2;\n    const left = offsetLeft + scrollLeft - (parentWidth - width) / 2;\n\n    scrollParent.scroll({ top, left, behavior: 'smooth' });\n  };\n\n  // Get closest scrollable parent\n  const scrollParent: Element = getScrollParent(container);\n  if (scrollParent) {\n    // Get curren version of the annotation from the store\n    const current = store.getAnnotation(id);\n\n    // The 1st selector is the topmost one as well\n    const { range } = current.target.selector[0];\n    if (range && !range.collapsed) {\n      scroll(current.target);\n      return true;\n    } else {\n      // Try reviving to account for lazy rendering\n      const revived = reviveTarget(current.target, container);\n      const { range } = revived.selector[0];\n      if (range && !range.collapsed) {\n        scroll(revived);\n        return true;\n      }\n    }\n  }\n\n  return false;\n};\n","import type { AnnotationState, Color, DrawingStyle } from '@annotorious/core';\nimport type { TextAnnotation } from 'src/model';\n\nexport interface HighlightStyle extends Pick<DrawingStyle, 'fill' | 'fillOpacity'> {\n\n  underlineStyle?: string;\n\n  underlineColor?: Color;\n\n  underlineOffset?: number;\n\n  underlineThickness?: number;\n  \n}\n\nexport type HighlightStyleExpression = HighlightStyle \n  | (<I extends TextAnnotation = TextAnnotation>(annotation: I, state: AnnotationState, zIndex?: number) => HighlightStyle | undefined);\n\nexport const DEFAULT_STYLE: HighlightStyle = { \n  fill: 'rgb(0, 128, 255)', \n  fillOpacity: 0.18\n};\n\nexport const DEFAULT_SELECTED_STYLE: HighlightStyle = { \n  fill: 'rgb(0, 128, 255)', \n  fillOpacity: 0.45 \n};\n","\nimport type { Highlight } from './Highlight';\nimport { DEFAULT_SELECTED_STYLE, DEFAULT_STYLE } from './HighlightStyle';\nimport type { HighlightStyle, HighlightStyleExpression } from './HighlightStyle';\nimport type { ViewportBounds } from './viewport';\n\nexport interface HighlightPainter {\n\n  clear(): void;\n\n  destroy(): void;\n\n  paint(highlight: Highlight, viewportBounds: ViewportBounds): HighlightStyle;\n\n  reset(): void;\n\n}\n\n/** Helper **/\nexport const paint = (\n  highlight: Highlight,\n  viewportBounds: ViewportBounds,\n  style?: HighlightStyleExpression, \n  painter?: HighlightPainter,\n  zIndex?: number\n) => {\n  const base: HighlightStyle = style \n    ? typeof style === 'function' \n      ? style(highlight.annotation, highlight.state, zIndex) || (\n        highlight.state?.selected ? DEFAULT_SELECTED_STYLE : DEFAULT_STYLE\n      )\n      : style \n    : highlight.state?.selected \n      ? DEFAULT_SELECTED_STYLE \n      : DEFAULT_STYLE;\n\n  // Trigger the custom painter (if any) as a side-effect\n  return painter ? painter.paint(highlight, viewportBounds) || base : base;\n}","import type { ViewportState } from '@annotorious/core';\nimport type { TextAnnotation } from '../model';\n\nexport interface ViewportBounds {\n\n  top: number;\n\n  left: number;\n\n  minX: number;\n\n  minY: number;\n  \n  maxX: number;\n  \n  maxY: number;\n\n}\n\nexport const getViewportBounds = (container: HTMLElement): ViewportBounds => {\n  const { top, left } = container.getBoundingClientRect();\n\n  const { innerWidth, innerHeight } = window;\n\n  const minX = - left;\n  const minY = - top;\n  const maxX = innerWidth - left;\n  const maxY = innerHeight - top;\n\n  return { top, left, minX, minY, maxX, maxY };\n}\n\nexport const trackViewport = (viewport: ViewportState) => {\n  let visible = new Set<string>();\n\n  const onDraw = (annotations: TextAnnotation[]) => {\n    const ids = annotations.map(a => a.id);\n\n    if (visible.size !== ids.length || ids.some(id => !visible.has(id))) {\n      viewport.set(ids);\n    } \n\n    visible = new Set(ids);\n  }\n\n  return onDraw;\n\n}","import type { Filter, ViewportState } from '@annotorious/core';\nimport type { TextAnnotatorState } from '../state';\nimport { debounce } from '../utils';\nimport { type ViewportBounds, getViewportBounds, trackViewport } from './viewport';\nimport type { HighlightPainter } from './HighlightPainter';\nimport type { Highlight } from './Highlight';\nimport type { HighlightStyleExpression } from './HighlightStyle';\n\nexport interface RendererImplementation {\n\n  destroy(): void;\n\n  redraw(\n\n    highlights:Highlight[], \n\n    bounds: ViewportBounds, \n    \n    style?: HighlightStyleExpression,\n\n    painter?: HighlightPainter,\n\n    lazy?: boolean\n  \n  ): void;\n\n  setVisible(visible: boolean): void;\n\n}\n\nexport interface Renderer {\n\n  destroy(): void;\n\n  redraw(force?: boolean): void;\n\n  setStyle(style?: HighlightStyleExpression): void;\n\n  setFilter(filter?: Filter): void;\n\n  setPainter(painter?: HighlightPainter): void;\n\n  setVisible(visible: boolean): void;\n\n}\n\nexport const createBaseRenderer = <T extends TextAnnotatorState = TextAnnotatorState> (\n  container: HTMLElement, \n  state: T,\n  viewport: ViewportState,\n  renderer: RendererImplementation\n): Renderer => {\n  const { store, selection, hover } = state;\n\n  let currentStyle: HighlightStyleExpression | undefined;\n\n  let currentFilter: Filter | undefined;\n\n  let currentPainter: HighlightPainter;\n\n  const onDraw = trackViewport(viewport);\n\n  const onPointerMove = (event: PointerEvent) => {\n    const {x, y} = container.getBoundingClientRect();\n\n    const hit = store.getAt(event.clientX - x, event.clientY - y, false, currentFilter);\n    if (hit) {\n      if (hover.current !== hit.id) {\n        container.classList.add('hovered');\n        hover.set(hit.id);\n      }\n    } else {\n      if (hover.current) {\n        container.classList.remove('hovered');\n        hover.set(null);\n      }\n    }\n  }\n\n  container.addEventListener('pointermove', onPointerMove);\n\n  const redraw = (lazy: boolean = false) => {\n    if (currentPainter)\n      currentPainter.clear();\n\n    const bounds = getViewportBounds(container);   \n\n    const { minX, minY, maxX, maxY } = bounds;\n    \n    const annotationsInView = currentFilter\n      ? store.getIntersecting(minX, minY, maxX, maxY).filter(({ annotation }) => currentFilter(annotation))\n      : store.getIntersecting(minX, minY, maxX, maxY);\n\n    const selectedIds = selection.selected.map(({ id }) => id);\n\n    const highlights: Highlight[] = annotationsInView.map(({ annotation, rects }) => {\n      const selected = selectedIds.includes(annotation.id);\n      const hovered = annotation.id === hover.current;\n\n      return { annotation, rects, state: { selected, hover: hovered }};\n    });\n\n    renderer.redraw(highlights, bounds, currentStyle, currentPainter, lazy);\n\n    setTimeout(() => onDraw(annotationsInView.map(({ annotation }) => annotation)), 1);\n  }\n\n  const setPainter = (painter: HighlightPainter) => { \n    currentPainter = painter;\n    redraw();\n  }\n\n  const setStyle = (style?: HighlightStyleExpression) => {\n    currentStyle = style;\n    redraw();\n  }\n\n  const setFilter = (filter?: Filter) => {\n    currentFilter = filter;\n    redraw(false);\n  } \n\n  // Refresh on store change\n  const onStoreChange = () => redraw();\n  store.observe(onStoreChange);\n\n  // Refresh on selection change\n  const unsubscribeSelection = selection.subscribe(() => redraw());\n\n  // Refresh on scroll\n  const onScroll = () => redraw(true);\n  document.addEventListener('scroll', onScroll, { capture: true, passive: true });\n\n  // Refresh on resize\n  const onResize = debounce(() => {\n    store.recalculatePositions();\n\n    if (currentPainter)\n      currentPainter.reset();\n\n    redraw();\n  });\n\n  window.addEventListener('resize', onResize);\n\n  const resizeObserver = new ResizeObserver(onResize);\n  resizeObserver.observe(container);\n\n  // This is an extra precaution. The position of the container\n  // might shift (without resizing) due to layout changes higher-up\n  // in the DOM. (This happens in Recogito for example)\n  const config: MutationObserverInit = { attributes: true, childList: true, subtree: true };\n\n  const mutationObserver = new MutationObserver((records: MutationRecord[]) => {\n    const isInternal = records.every(record => record.target === container || container.contains(record.target));\n    if (!isInternal) redraw(true);\n  });\n\n  mutationObserver.observe(document.body, config);\n\n  const destroy = () => {\n    container.removeEventListener('pointermove', onPointerMove);\n  \n    renderer.destroy();\n  \n    store.unobserve(onStoreChange);\n\n    unsubscribeSelection();\n\n    document.removeEventListener('scroll', onScroll);\n\n    window.removeEventListener('resize', onResize);\n    resizeObserver.disconnect();\n\n    mutationObserver.disconnect();\n  }\n\n  return {\n    destroy,\n    redraw,\n    setStyle,\n    setFilter,\n    setPainter,\n    setVisible: renderer.setVisible\n  }\n\n}\n","import type { ViewportState } from '@annotorious/core';\nimport type { TextAnnotatorState } from '../../state';\nimport { debounce } from '../../utils';\nimport type { ViewportBounds } from '../viewport';\nimport type { HighlightStyle } from '../HighlightStyle';\nimport { DEFAULT_SELECTED_STYLE, DEFAULT_STYLE, type HighlightStyleExpression } from '../HighlightStyle';\nimport type { HighlightPainter } from '../HighlightPainter';\nimport { createBaseRenderer, type RendererImplementation } from '../baseRenderer';\nimport type { Highlight } from '../Highlight';\nimport type { TextAnnotation } from 'src/model';\n\nimport './canvasRenderer.css';\n\nconst createCanvas = () => {\n  const canvas = document.createElement('canvas');\n  canvas.width = window.innerWidth;\n  canvas.height = window.innerHeight;\n  canvas.className = 'r6o-canvas-highlight-layer bg';\n  return canvas;\n}\n\nconst resetCanvas = (canvas: HTMLCanvasElement, highres?: boolean) => {\n  canvas.width = highres ? 2 * window.innerWidth : window.innerWidth;\n  canvas.height = highres ? 2 * window.innerHeight : window.innerHeight;\n\n  if (highres) {\n    // Note that resizing the canvas resets the context\n    const context = canvas.getContext('2d');\n    context.scale(2, 2);\n    context.translate(0.5, 0.5);\n  }\n}\n\nconst createRenderer = (container: HTMLElement): RendererImplementation => {\n\n  container.classList.add('r6o-annotatable');\n\n  const canvas = createCanvas();\n  const ctx = canvas.getContext('2d');\n\n  document.body.appendChild(canvas);\n\n  const redraw = (\n    highlights: Highlight[],\n    viewportBounds: ViewportBounds,\n    currentStyle?: HighlightStyleExpression,\n    currentPainter?: HighlightPainter\n  ) => requestAnimationFrame(() => {\n\n    const { width, height } = canvas;\n\n    // New render loop - clear canvases\n    ctx.clearRect(-0.5, -0.5, width + 1, height + 1);\n\n    if (currentPainter)\n      currentPainter.clear();\n\n    const { top, left } = viewportBounds;\n\n    /**\n     * Highlights rendering on the canvas is an order-sensitive operation.\n     * The later the highlight is rendered, the higher it will be in the visual stack.\n     *\n     * By default, we should expect that the newer highlight\n     * will be rendered over the older one\n     */\n    const highlightsByCreation = [...highlights].sort((highlightA, highlightB) => {\n      const { annotation: { target: { created: createdA } } } = highlightA;\n      const { annotation: { target: { created: createdB } } } = highlightB;\n      return createdA.getTime() - createdB.getTime();\n    });\n\n    highlightsByCreation.forEach(h => {\n      const base: HighlightStyle = currentStyle\n        ? typeof currentStyle === 'function'\n          ? currentStyle(h.annotation, h.state)\n          : currentStyle\n        : h.state?.selected\n          ? DEFAULT_SELECTED_STYLE\n          : DEFAULT_STYLE;\n\n      // Trigger the custom painter (if any) as a side-effect\n      const style = currentPainter ? currentPainter.paint(h, viewportBounds) || base : base;\n\n      // Offset annotation rects by current scroll position\n      const offsetRects = h.rects.map(({ x, y, width, height }) => ({\n        x: x + left,\n        y: y + top,\n        width,\n        height\n      }));\n\n      ctx.fillStyle = style.fill;\n      ctx.globalAlpha = style.fillOpacity || 1;\n\n      offsetRects.forEach(({ x, y, width, height }) =>\n        ctx.fillRect(x, y, width, height)\n      );\n\n      if (style.underlineColor) {\n        ctx.globalAlpha = 1;\n        ctx.strokeStyle = style.underlineColor;\n        ctx.lineWidth = style.underlineThickness ?? 1;\n\n        // Place the underline below the highlighted text + an optional offset\n        const underlineOffset = style.underlineOffset ?? 0;\n\n        offsetRects.forEach(({ x, y, width, height }) => {\n          ctx.beginPath();\n          ctx.moveTo(x, y + height + underlineOffset);\n          ctx.lineTo(x + width, y + height + underlineOffset);\n\n          // Draw the Path\n          ctx.stroke();\n        });\n      }\n    });\n  });\n\n  const onResize = debounce(() => {\n    resetCanvas(canvas);\n  });\n\n  window.addEventListener('resize', onResize);\n\n  const setVisible = (visible: boolean) => {\n    console.log('setVisible not implemented on Canvas renderer');\n  }\n\n  const destroy = () => {\n    canvas.remove();\n\n    window.removeEventListener('resize', onResize);\n  }\n\n  return {\n    destroy,\n    setVisible,\n    redraw\n  };\n\n};\n\nexport const createCanvasRenderer = (\n  container: HTMLElement,\n  state: TextAnnotatorState<TextAnnotation, unknown>,\n  viewport: ViewportState\n) => createBaseRenderer(container, state, viewport, createRenderer(container));\n","var r={grad:.9,turn:360,rad:360/(2*Math.PI)},t=function(r){return\"string\"==typeof r?r.length>0:\"number\"==typeof r},n=function(r,t,n){return void 0===t&&(t=0),void 0===n&&(n=Math.pow(10,t)),Math.round(n*r)/n+0},e=function(r,t,n){return void 0===t&&(t=0),void 0===n&&(n=1),r>n?n:r>t?r:t},u=function(r){return(r=isFinite(r)?r%360:0)>0?r:r+360},a=function(r){return{r:e(r.r,0,255),g:e(r.g,0,255),b:e(r.b,0,255),a:e(r.a)}},o=function(r){return{r:n(r.r),g:n(r.g),b:n(r.b),a:n(r.a,3)}},i=/^#([0-9a-f]{3,8})$/i,s=function(r){var t=r.toString(16);return t.length<2?\"0\"+t:t},h=function(r){var t=r.r,n=r.g,e=r.b,u=r.a,a=Math.max(t,n,e),o=a-Math.min(t,n,e),i=o?a===t?(n-e)/o:a===n?2+(e-t)/o:4+(t-n)/o:0;return{h:60*(i<0?i+6:i),s:a?o/a*100:0,v:a/255*100,a:u}},b=function(r){var t=r.h,n=r.s,e=r.v,u=r.a;t=t/360*6,n/=100,e/=100;var a=Math.floor(t),o=e*(1-n),i=e*(1-(t-a)*n),s=e*(1-(1-t+a)*n),h=a%6;return{r:255*[e,i,o,o,s,e][h],g:255*[s,e,e,i,o,o][h],b:255*[o,o,s,e,e,i][h],a:u}},g=function(r){return{h:u(r.h),s:e(r.s,0,100),l:e(r.l,0,100),a:e(r.a)}},d=function(r){return{h:n(r.h),s:n(r.s),l:n(r.l),a:n(r.a,3)}},f=function(r){return b((n=(t=r).s,{h:t.h,s:(n*=((e=t.l)<50?e:100-e)/100)>0?2*n/(e+n)*100:0,v:e+n,a:t.a}));var t,n,e},c=function(r){return{h:(t=h(r)).h,s:(u=(200-(n=t.s))*(e=t.v)/100)>0&&u<200?n*e/100/(u<=100?u:200-u)*100:0,l:u/2,a:t.a};var t,n,e,u},l=/^hsla?\\(\\s*([+-]?\\d*\\.?\\d+)(deg|rad|grad|turn)?\\s*,\\s*([+-]?\\d*\\.?\\d+)%\\s*,\\s*([+-]?\\d*\\.?\\d+)%\\s*(?:,\\s*([+-]?\\d*\\.?\\d+)(%)?\\s*)?\\)$/i,p=/^hsla?\\(\\s*([+-]?\\d*\\.?\\d+)(deg|rad|grad|turn)?\\s+([+-]?\\d*\\.?\\d+)%\\s+([+-]?\\d*\\.?\\d+)%\\s*(?:\\/\\s*([+-]?\\d*\\.?\\d+)(%)?\\s*)?\\)$/i,v=/^rgba?\\(\\s*([+-]?\\d*\\.?\\d+)(%)?\\s*,\\s*([+-]?\\d*\\.?\\d+)(%)?\\s*,\\s*([+-]?\\d*\\.?\\d+)(%)?\\s*(?:,\\s*([+-]?\\d*\\.?\\d+)(%)?\\s*)?\\)$/i,m=/^rgba?\\(\\s*([+-]?\\d*\\.?\\d+)(%)?\\s+([+-]?\\d*\\.?\\d+)(%)?\\s+([+-]?\\d*\\.?\\d+)(%)?\\s*(?:\\/\\s*([+-]?\\d*\\.?\\d+)(%)?\\s*)?\\)$/i,y={string:[[function(r){var t=i.exec(r);return t?(r=t[1]).length<=4?{r:parseInt(r[0]+r[0],16),g:parseInt(r[1]+r[1],16),b:parseInt(r[2]+r[2],16),a:4===r.length?n(parseInt(r[3]+r[3],16)/255,2):1}:6===r.length||8===r.length?{r:parseInt(r.substr(0,2),16),g:parseInt(r.substr(2,2),16),b:parseInt(r.substr(4,2),16),a:8===r.length?n(parseInt(r.substr(6,2),16)/255,2):1}:null:null},\"hex\"],[function(r){var t=v.exec(r)||m.exec(r);return t?t[2]!==t[4]||t[4]!==t[6]?null:a({r:Number(t[1])/(t[2]?100/255:1),g:Number(t[3])/(t[4]?100/255:1),b:Number(t[5])/(t[6]?100/255:1),a:void 0===t[7]?1:Number(t[7])/(t[8]?100:1)}):null},\"rgb\"],[function(t){var n=l.exec(t)||p.exec(t);if(!n)return null;var e,u,a=g({h:(e=n[1],u=n[2],void 0===u&&(u=\"deg\"),Number(e)*(r[u]||1)),s:Number(n[3]),l:Number(n[4]),a:void 0===n[5]?1:Number(n[5])/(n[6]?100:1)});return f(a)},\"hsl\"]],object:[[function(r){var n=r.r,e=r.g,u=r.b,o=r.a,i=void 0===o?1:o;return t(n)&&t(e)&&t(u)?a({r:Number(n),g:Number(e),b:Number(u),a:Number(i)}):null},\"rgb\"],[function(r){var n=r.h,e=r.s,u=r.l,a=r.a,o=void 0===a?1:a;if(!t(n)||!t(e)||!t(u))return null;var i=g({h:Number(n),s:Number(e),l:Number(u),a:Number(o)});return f(i)},\"hsl\"],[function(r){var n=r.h,a=r.s,o=r.v,i=r.a,s=void 0===i?1:i;if(!t(n)||!t(a)||!t(o))return null;var h=function(r){return{h:u(r.h),s:e(r.s,0,100),v:e(r.v,0,100),a:e(r.a)}}({h:Number(n),s:Number(a),v:Number(o),a:Number(s)});return b(h)},\"hsv\"]]},N=function(r,t){for(var n=0;n<t.length;n++){var e=t[n][0](r);if(e)return[e,t[n][1]]}return[null,void 0]},x=function(r){return\"string\"==typeof r?N(r.trim(),y.string):\"object\"==typeof r&&null!==r?N(r,y.object):[null,void 0]},I=function(r){return x(r)[1]},M=function(r,t){var n=c(r);return{h:n.h,s:e(n.s+100*t,0,100),l:n.l,a:n.a}},H=function(r){return(299*r.r+587*r.g+114*r.b)/1e3/255},$=function(r,t){var n=c(r);return{h:n.h,s:n.s,l:e(n.l+100*t,0,100),a:n.a}},j=function(){function r(r){this.parsed=x(r)[0],this.rgba=this.parsed||{r:0,g:0,b:0,a:1}}return r.prototype.isValid=function(){return null!==this.parsed},r.prototype.brightness=function(){return n(H(this.rgba),2)},r.prototype.isDark=function(){return H(this.rgba)<.5},r.prototype.isLight=function(){return H(this.rgba)>=.5},r.prototype.toHex=function(){return r=o(this.rgba),t=r.r,e=r.g,u=r.b,i=(a=r.a)<1?s(n(255*a)):\"\",\"#\"+s(t)+s(e)+s(u)+i;var r,t,e,u,a,i},r.prototype.toRgb=function(){return o(this.rgba)},r.prototype.toRgbString=function(){return r=o(this.rgba),t=r.r,n=r.g,e=r.b,(u=r.a)<1?\"rgba(\"+t+\", \"+n+\", \"+e+\", \"+u+\")\":\"rgb(\"+t+\", \"+n+\", \"+e+\")\";var r,t,n,e,u},r.prototype.toHsl=function(){return d(c(this.rgba))},r.prototype.toHslString=function(){return r=d(c(this.rgba)),t=r.h,n=r.s,e=r.l,(u=r.a)<1?\"hsla(\"+t+\", \"+n+\"%, \"+e+\"%, \"+u+\")\":\"hsl(\"+t+\", \"+n+\"%, \"+e+\"%)\";var r,t,n,e,u},r.prototype.toHsv=function(){return r=h(this.rgba),{h:n(r.h),s:n(r.s),v:n(r.v),a:n(r.a,3)};var r},r.prototype.invert=function(){return w({r:255-(r=this.rgba).r,g:255-r.g,b:255-r.b,a:r.a});var r},r.prototype.saturate=function(r){return void 0===r&&(r=.1),w(M(this.rgba,r))},r.prototype.desaturate=function(r){return void 0===r&&(r=.1),w(M(this.rgba,-r))},r.prototype.grayscale=function(){return w(M(this.rgba,-1))},r.prototype.lighten=function(r){return void 0===r&&(r=.1),w($(this.rgba,r))},r.prototype.darken=function(r){return void 0===r&&(r=.1),w($(this.rgba,-r))},r.prototype.rotate=function(r){return void 0===r&&(r=15),this.hue(this.hue()+r)},r.prototype.alpha=function(r){return\"number\"==typeof r?w({r:(t=this.rgba).r,g:t.g,b:t.b,a:r}):n(this.rgba.a,3);var t},r.prototype.hue=function(r){var t=c(this.rgba);return\"number\"==typeof r?w({h:r,s:t.s,l:t.l,a:t.a}):n(t.h)},r.prototype.isEqual=function(r){return this.toHex()===w(r).toHex()},r}(),w=function(r){return r instanceof j?r:new j(r)},S=[],k=function(r){r.forEach(function(r){S.indexOf(r)<0&&(r(j,y),S.push(r))})},E=function(){return new j({r:255*Math.random(),g:255*Math.random(),b:255*Math.random()})};export{j as Colord,w as colord,k as extend,I as getFormat,E as random};\n","import type { ViewportState } from '@annotorious/core';\nimport { colord } from 'colord';\nimport type { HighlightPainter } from '../HighlightPainter';\nimport type { TextAnnotatorState } from 'src/state';\nimport type { ViewportBounds } from '../viewport';\nimport { DEFAULT_SELECTED_STYLE, DEFAULT_STYLE } from '../HighlightStyle';\nimport type { HighlightStyle, HighlightStyleExpression } from '../HighlightStyle';\nimport { type RendererImplementation, createBaseRenderer } from '../baseRenderer';\nimport type { Highlight } from '../Highlight';\nimport type { TextAnnotation } from 'src/model';\n\nconst toCSS = (s?: HighlightStyle) => {\n  const backgroundColor = colord(s?.fill || DEFAULT_STYLE.fill)\n    .alpha(s?.fillOpacity === undefined ? DEFAULT_STYLE.fillOpacity : s.fillOpacity)\n    .toHex();\n\n  const rules = [\n    `background-color:${backgroundColor}`,\n    s?.underlineThickness ? `text-decoration:underline` : undefined,\n    s?.underlineColor ? `text-decoration-color:${s.underlineColor}` : undefined,\n    s?.underlineOffset ? `text-underline-offset:${s.underlineOffset}px` : undefined,\n    s?.underlineThickness ? `text-decoration-thickness:${s.underlineThickness}px` : undefined\n  ].filter(Boolean);\n\n  return rules.join(';');\n}\n\nexport const createRenderer = (): RendererImplementation => {\n  const elem = document.createElement('style');\n  document.getElementsByTagName('head')[0].appendChild(elem);\n\n  let currentRendered = new Set<string>();\n\n  const redraw = (\n    highlights: Highlight[],\n    viewportBounds: ViewportBounds,\n    currentStyle?: HighlightStyleExpression,\n    painter?: HighlightPainter\n  ) => {\n    if (painter)\n      painter.clear();\n\n    // Next set of rendered annotation IDs and selections\n    const nextRendered = new Set(highlights.map(h => h.annotation.id));\n\n    // Annotations currently in this stylesheet that no longer need rendering\n    const toRemove = Array.from(currentRendered).filter(id => !nextRendered.has(id));\n\n    // For simplicity, re-generate the whole stylesheet\n    const updatedCSS = highlights.map(h => {\n      const base = currentStyle\n        ? typeof currentStyle === 'function'\n          ? currentStyle(h.annotation, h.state)\n          : currentStyle\n        : h.state?.selected ? DEFAULT_SELECTED_STYLE : DEFAULT_STYLE;\n\n      // Trigger the custom painter (if any) as a side-effect\n      const style = painter ? painter.paint(h, viewportBounds) || base : base;\n\n      return `::highlight(_${h.annotation.id}) { ${toCSS(style)} }`;\n    });\n\n    elem.innerHTML = updatedCSS.join('\\n');\n\n    // After we have the styles, we need to update the Highlights.\n    // Note that the (experimental) CSS Custom Highlight API is not yet\n    // available in TypeScript!\n\n    // @ts-ignore\n    CSS.highlights.clear();\n    // toRemove.forEach(id => CSS.highlights.delete(`_${id}`));\n\n    // Could be improved further by (re-)setting only annotations that\n    // have changes.\n    highlights.forEach(({ annotation }) => {\n      const ranges = annotation.target.selector.map(s => s.range);\n\n      // @ts-ignore\n      const highlights = new Highlight(...ranges);\n\n      // @ts-ignore\n      CSS.highlights.set(`_${annotation.id}`, highlights);\n    });\n\n    currentRendered = nextRendered;\n  }\n\n  const setVisible = (visible: boolean) => {\n    console.log('setVisible not implemented on CSS Custom Highlights renderer');\n  }\n\n  const destroy = () => {\n    // Clear all highlights from the Highlight Registry\n    // @ts-ignore\n    CSS.highlights.clear();\n\n    // Remove the stylesheet\n    elem.remove();\n  }\n\n  return {\n    destroy,\n    setVisible,\n    redraw\n  };\n\n}\n\nexport const createHighlightsRenderer = (\n  container: HTMLElement,\n  state: TextAnnotatorState<TextAnnotation, unknown>,\n  viewport: ViewportState\n) => createBaseRenderer(container, state, viewport, createRenderer());\n","var has = Object.prototype.hasOwnProperty;\n\nexport function dequal(foo, bar) {\n\tvar ctor, len;\n\tif (foo === bar) return true;\n\n\tif (foo && bar && (ctor=foo.constructor) === bar.constructor) {\n\t\tif (ctor === Date) return foo.getTime() === bar.getTime();\n\t\tif (ctor === RegExp) return foo.toString() === bar.toString();\n\n\t\tif (ctor === Array) {\n\t\t\tif ((len=foo.length) === bar.length) {\n\t\t\t\twhile (len-- && dequal(foo[len], bar[len]));\n\t\t\t}\n\t\t\treturn len === -1;\n\t\t}\n\n\t\tif (!ctor || typeof foo === 'object') {\n\t\t\tlen = 0;\n\t\t\tfor (ctor in foo) {\n\t\t\t\tif (has.call(foo, ctor) && ++len && !has.call(bar, ctor)) return false;\n\t\t\t\tif (!(ctor in bar) || !dequal(foo[ctor], bar[ctor])) return false;\n\t\t\t}\n\t\t\treturn Object.keys(bar).length === len;\n\t\t}\n\t}\n\n\treturn foo !== foo && bar !== bar;\n}\n","import type { ViewportState } from '@annotorious/core';\nimport { colord } from 'colord';\nimport { dequal } from 'dequal/lite';\nimport type { Rect, TextAnnotatorState } from '../../state';\nimport { type HighlightPainter, paint } from '../HighlightPainter';\nimport type { ViewportBounds } from '../viewport';\nimport { createBaseRenderer, type RendererImplementation } from '../baseRenderer';\nimport type { Highlight } from '../Highlight';\nimport { DEFAULT_STYLE, type HighlightStyleExpression } from '../HighlightStyle';\nimport type { TextAnnotation } from 'src/model';\n\nimport './spansRenderer.css';\n\nconst computeZIndex = (rect: Rect, all: Highlight[]): number => {\n  const intersects = (a: Rect, b: Rect): boolean => (\n    a.x <= b.x + b.width && a.x + a.width >= b.x &&\n    a.y <= b.y + b.height && a.y + a.height >= b.y\n  )\n\n  const getLength = (h: Highlight) => \n    h.rects.reduce((total, rect) => total + rect.width, 0);\n\n  // Any highlights that intersect this rect, sorted by total length\n  const intersecting = all.filter(({ rects }) => rects.some(r => intersects(rect, r)));\n  intersecting.sort((a, b) => getLength(b) - getLength(a));\n\n  return intersecting.findIndex(h => h.rects.includes(rect));\n}\n\nconst createRenderer = (container: HTMLElement): RendererImplementation => {\n\n  container.classList.add('r6o-annotatable');\n\n  const highlightLayer = document.createElement('div');\n  highlightLayer.className = 'r6o-span-highlight-layer';\n\n  container.insertBefore(highlightLayer, container.firstChild);\n\n  // Currently rendered highlights\n  let currentRendered: Highlight[] = [];\n\n  const redraw = (\n    highlights: Highlight[],\n    viewportBounds: ViewportBounds,\n    currentStyle?: HighlightStyleExpression,\n    painter?: HighlightPainter,\n    lazy?: boolean\n  ) => {\n    const noChanges = dequal(currentRendered, highlights);\n\n    // If there are no changes and rendering is set to lazy\n    // Don't redraw the SPANs - but redraw the painter, if any!\n    const shouldRedraw = !(noChanges && lazy);\n\n    if (!painter && !shouldRedraw) return;\n\n    if (shouldRedraw)\n      highlightLayer.innerHTML = '';\n\n    /**\n     * Highlights rendering in the span highlight layer is an order-sensitive operation.\n     * The later the highlight is rendered, the higher it will be in the visual stack.\n     *\n     * By default, we should expect that the newer highlight\n     * will be rendered over the older one\n     */\n    const sorted = [...highlights].sort((highlightA, highlightB) => {\n      const { annotation: { target: { created: createdA } } } = highlightA;\n      const { annotation: { target: { created: createdB } } } = highlightB;\n      return createdA && createdB ? createdA.getTime() - createdB.getTime() : 0;\n    });\n\n    sorted.forEach(highlight => {\n      highlight.rects.map(rect => {\n        const zIndex = computeZIndex(rect, highlights);\n        const style = paint(highlight, viewportBounds, currentStyle, painter, zIndex);\n\n        if (shouldRedraw) {\n          const span = document.createElement('span');\n          span.className = 'r6o-annotation';\n          span.dataset.annotation = highlight.annotation.id;\n\n          span.style.left = `${rect.x}px`;\n          span.style.top = `${rect.y}px`;\n          span.style.width = `${rect.width}px`;\n          span.style.height = `${rect.height}px`;\n\n          span.style.backgroundColor = colord(style?.fill || DEFAULT_STYLE.fill)\n            .alpha(style?.fillOpacity === undefined ? DEFAULT_STYLE.fillOpacity : style.fillOpacity)\n            .toHex();\n\n          if (style.underlineStyle)\n            span.style.borderStyle = style.underlineStyle;\n\n          if (style.underlineColor)\n            span.style.borderColor = style.underlineColor;\n\n          if (style.underlineThickness)\n            span.style.borderBottomWidth = `${style.underlineThickness}px`;\n\n          if (style.underlineOffset)\n            span.style.paddingBottom = `${style.underlineOffset}px`;\n\n          highlightLayer.appendChild(span);\n        }\n      });\n    });\n\n    currentRendered = highlights;\n  }\n\n  const setVisible = (visible: boolean) => {\n    if (visible)\n      highlightLayer.classList.remove('hidden');\n    else\n      highlightLayer.classList.add('hidden');\n  }\n\n  const destroy = () => {\n    highlightLayer.remove();\n  }\n\n  return {\n    destroy,\n    redraw,\n    setVisible\n  };\n\n}\n\nexport const createSpansRenderer = (\n  container: HTMLElement,\n  state: TextAnnotatorState<TextAnnotation, unknown>,\n  viewport: ViewportState\n) => createBaseRenderer(container, state, viewport, createRenderer(container));\n","import validate from './validate.js';\nconst byteToHex = [];\nfor (let i = 0; i < 256; ++i) {\n    byteToHex.push((i + 0x100).toString(16).slice(1));\n}\nexport function unsafeStringify(arr, offset = 0) {\n    return (byteToHex[arr[offset + 0]] +\n        byteToHex[arr[offset + 1]] +\n        byteToHex[arr[offset + 2]] +\n        byteToHex[arr[offset + 3]] +\n        '-' +\n        byteToHex[arr[offset + 4]] +\n        byteToHex[arr[offset + 5]] +\n        '-' +\n        byteToHex[arr[offset + 6]] +\n        byteToHex[arr[offset + 7]] +\n        '-' +\n        byteToHex[arr[offset + 8]] +\n        byteToHex[arr[offset + 9]] +\n        '-' +\n        byteToHex[arr[offset + 10]] +\n        byteToHex[arr[offset + 11]] +\n        byteToHex[arr[offset + 12]] +\n        byteToHex[arr[offset + 13]] +\n        byteToHex[arr[offset + 14]] +\n        byteToHex[arr[offset + 15]]).toLowerCase();\n}\nfunction stringify(arr, offset = 0) {\n    const uuid = unsafeStringify(arr, offset);\n    if (!validate(uuid)) {\n        throw TypeError('Stringified UUID is invalid');\n    }\n    return uuid;\n}\nexport default stringify;\n","let getRandomValues;\nconst rnds8 = new Uint8Array(16);\nexport default function rng() {\n    if (!getRandomValues) {\n        if (typeof crypto === 'undefined' || !crypto.getRandomValues) {\n            throw new Error('crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported');\n        }\n        getRandomValues = crypto.getRandomValues.bind(crypto);\n    }\n    return getRandomValues(rnds8);\n}\n","const randomUUID = typeof crypto !== 'undefined' && crypto.randomUUID && crypto.randomUUID.bind(crypto);\nexport default { randomUUID };\n","import native from './native.js';\nimport rng from './rng.js';\nimport { unsafeStringify } from './stringify.js';\nfunction v4(options, buf, offset) {\n    if (native.randomUUID && !buf && !options) {\n        return native.randomUUID();\n    }\n    options = options || {};\n    const rnds = options.random || (options.rng || rng)();\n    rnds[6] = (rnds[6] & 0x0f) | 0x40;\n    rnds[8] = (rnds[8] & 0x3f) | 0x80;\n    if (buf) {\n        offset = offset || 0;\n        for (let i = 0; i < 16; ++i) {\n            buf[offset + i] = rnds[i];\n        }\n        return buf;\n    }\n    return unsafeStringify(rnds);\n}\nexport default v4;\n","var M = Object.prototype.hasOwnProperty;\nfunction k(e, t) {\n  var n, o;\n  if (e === t) return !0;\n  if (e && t && (n = e.constructor) === t.constructor) {\n    if (n === Date) return e.getTime() === t.getTime();\n    if (n === RegExp) return e.toString() === t.toString();\n    if (n === Array) {\n      if ((o = e.length) === t.length)\n        for (; o-- && k(e[o], t[o]); ) ;\n      return o === -1;\n    }\n    if (!n || typeof e == \"object\") {\n      o = 0;\n      for (n in e)\n        if (M.call(e, n) && ++o && !M.call(t, n) || !(n in t) || !k(e[n], t[n])) return !1;\n      return Object.keys(t).length === o;\n    }\n  }\n  return e !== e && t !== t;\n}\nfunction V() {\n}\nfunction X(e, t) {\n  return e != e ? t == t : e !== t || e && typeof e == \"object\" || typeof e == \"function\";\n}\nconst N = [];\nfunction j(e, t = V) {\n  let n;\n  const o = /* @__PURE__ */ new Set();\n  function s(b) {\n    if (X(e, b) && (e = b, n)) {\n      const w = !N.length;\n      for (const m of o)\n        m[1](), N.push(m, e);\n      if (w) {\n        for (let m = 0; m < N.length; m += 2)\n          N[m][0](N[m + 1]);\n        N.length = 0;\n      }\n    }\n  }\n  function f(b) {\n    s(b(e));\n  }\n  function A(b, w = V) {\n    const m = [b, w];\n    return o.add(m), o.size === 1 && (n = t(s, f) || V), b(e), () => {\n      o.delete(m), o.size === 0 && n && (n(), n = null);\n    };\n  }\n  return { set: s, update: f, subscribe: A };\n}\nconst Ue = (e) => {\n  const { subscribe: t, set: n } = j();\n  let o;\n  return t((s) => o = s), e.observe(({ changes: s }) => {\n    if (o) {\n      (s.deleted || []).some((b) => b.id === o) && n(void 0);\n      const A = (s.updated || []).find(({ oldValue: b }) => b.id === o);\n      A && n(A.newValue.id);\n    }\n  }), {\n    get current() {\n      return o;\n    },\n    subscribe: t,\n    set: n\n  };\n};\nvar Z = /* @__PURE__ */ ((e) => (e.EDIT = \"EDIT\", e.SELECT = \"SELECT\", e.NONE = \"NONE\", e))(Z || {});\nconst z = { selected: [] }, Se = (e, t, n) => {\n  const { subscribe: o, set: s } = j(z);\n  let f = t, A = z;\n  o((h) => A = h);\n  const b = () => {\n    k(A, z) || s(z);\n  }, w = () => {\n    var h;\n    return ((h = A.selected) == null ? void 0 : h.length) === 0;\n  }, m = (h) => {\n    if (w())\n      return !1;\n    const C = typeof h == \"string\" ? h : h.id;\n    return A.selected.some((D) => D.id === C);\n  }, U = (h, C) => {\n    let D;\n    if (Array.isArray(h)) {\n      if (D = h.map((i) => e.getAnnotation(i)).filter(Boolean), D.length < h.length) {\n        console.warn(\"Invalid selection: \" + h.filter((i) => !D.some((p) => p.id === i)));\n        return;\n      }\n    } else {\n      const i = e.getAnnotation(h);\n      if (!i) {\n        console.warn(\"Invalid selection: \" + h);\n        return;\n      }\n      D = [i];\n    }\n    const a = D.reduce((i, p) => {\n      const v = W(p, f, n);\n      return v === \"EDIT\" ? [...i, { id: p.id, editable: !0 }] : v === \"SELECT\" ? [...i, { id: p.id }] : i;\n    }, []);\n    s({ selected: a, event: C });\n  }, c = (h, C) => {\n    const D = Array.isArray(h) ? h : [h], a = D.map((i) => e.getAnnotation(i)).filter((i) => !!i);\n    s({\n      selected: a.map((i) => {\n        const p = C === void 0 ? W(i, f, n) === \"EDIT\" : C;\n        return { id: i.id, editable: p };\n      })\n    }), a.length !== D.length && console.warn(\"Invalid selection\", h);\n  }, E = (h) => {\n    if (w())\n      return !1;\n    const { selected: C } = A;\n    C.some(({ id: a }) => h.includes(a)) && s({ selected: C.filter(({ id: a }) => !h.includes(a)) });\n  }, T = (h) => f = h;\n  return e.observe(\n    ({ changes: h }) => E((h.deleted || []).map((C) => C.id))\n  ), {\n    get event() {\n      return A ? A.event : null;\n    },\n    get selected() {\n      return A ? [...A.selected] : null;\n    },\n    get userSelectAction() {\n      return f;\n    },\n    clear: b,\n    isEmpty: w,\n    isSelected: m,\n    setSelected: c,\n    setUserSelectAction: T,\n    subscribe: o,\n    userSelect: U\n  };\n}, W = (e, t, n) => {\n  const o = n ? n.serialize(e) : e;\n  return typeof t == \"function\" ? t(o) : t || \"EDIT\";\n}, R = [];\nfor (let e = 0; e < 256; ++e)\n  R.push((e + 256).toString(16).slice(1));\nfunction F(e, t = 0) {\n  return (R[e[t + 0]] + R[e[t + 1]] + R[e[t + 2]] + R[e[t + 3]] + \"-\" + R[e[t + 4]] + R[e[t + 5]] + \"-\" + R[e[t + 6]] + R[e[t + 7]] + \"-\" + R[e[t + 8]] + R[e[t + 9]] + \"-\" + R[e[t + 10]] + R[e[t + 11]] + R[e[t + 12]] + R[e[t + 13]] + R[e[t + 14]] + R[e[t + 15]]).toLowerCase();\n}\nlet _;\nconst K = new Uint8Array(16);\nfunction ee() {\n  if (!_) {\n    if (typeof crypto > \"u\" || !crypto.getRandomValues)\n      throw new Error(\"crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported\");\n    _ = crypto.getRandomValues.bind(crypto);\n  }\n  return _(K);\n}\nconst te = typeof crypto < \"u\" && crypto.randomUUID && crypto.randomUUID.bind(crypto), q = { randomUUID: te };\nfunction G(e, t, n) {\n  if (q.randomUUID && !t && !e)\n    return q.randomUUID();\n  e = e || {};\n  const o = e.random || (e.rng || ee)();\n  return o[6] = o[6] & 15 | 64, o[8] = o[8] & 63 | 128, F(o);\n}\nconst Te = (e) => {\n  const { creator: t, updatedBy: n } = e.target, o = e.bodies.reduce((s, f) => [...s, f.creator, f.updatedBy].filter(Boolean), []);\n  return [\n    t,\n    n,\n    ...o\n  ].filter((s) => s);\n}, Y = (e) => {\n  const t = (n) => {\n    const o = { ...n };\n    return n.created && typeof n.created == \"string\" && (o.created = new Date(n.created)), n.updated && typeof n.updated == \"string\" && (o.updated = new Date(n.updated)), o;\n  };\n  return {\n    ...e,\n    bodies: (e.bodies || []).map(t),\n    target: t(e.target)\n  };\n}, De = (e, t, n, o) => ({\n  id: G(),\n  annotation: typeof e == \"string\" ? e : e.id,\n  created: n || /* @__PURE__ */ new Date(),\n  creator: o,\n  ...t\n}), ne = (e, t) => {\n  const n = new Set(e.bodies.map((o) => o.id));\n  return t.bodies.filter((o) => !n.has(o.id));\n}, oe = (e, t) => {\n  const n = new Set(t.bodies.map((o) => o.id));\n  return e.bodies.filter((o) => !n.has(o.id));\n}, se = (e, t) => t.bodies.map((n) => {\n  const o = e.bodies.find((s) => s.id === n.id);\n  return { newBody: n, oldBody: o && !k(o, n) ? o : void 0 };\n}).filter(({ oldBody: n }) => n).map(({ oldBody: n, newBody: o }) => ({ oldBody: n, newBody: o })), ie = (e, t) => !k(e.target, t.target), J = (e, t) => {\n  const n = ne(e, t), o = oe(e, t), s = se(e, t);\n  return {\n    oldValue: e,\n    newValue: t,\n    bodiesCreated: n.length > 0 ? n : void 0,\n    bodiesDeleted: o.length > 0 ? o : void 0,\n    bodiesUpdated: s.length > 0 ? s : void 0,\n    targetUpdated: ie(e, t) ? { oldTarget: e.target, newTarget: t.target } : void 0\n  };\n};\nvar de = /* @__PURE__ */ ((e) => (e.BODY_ONLY = \"BODY_ONLY\", e.TARGET_ONLY = \"TARGET_ONLY\", e))(de || {}), O = /* @__PURE__ */ ((e) => (e.LOCAL = \"LOCAL\", e.REMOTE = \"REMOTE\", e.SILENT = \"SILENT\", e))(O || {});\nconst re = (e, t) => {\n  var f, A;\n  const { changes: n, origin: o } = t;\n  if (!(e.options.origin ? e.options.origin === o : o !== \"SILENT\"))\n    return !1;\n  if (e.options.ignore) {\n    const { ignore: b } = e.options, w = (U) => U && U.length > 0;\n    if (!(w(n.created) || w(n.deleted))) {\n      const U = (f = n.updated) == null ? void 0 : f.some((E) => w(E.bodiesCreated) || w(E.bodiesDeleted) || w(E.bodiesUpdated)), c = (A = n.updated) == null ? void 0 : A.some((E) => E.targetUpdated);\n      if (b === \"BODY_ONLY\" && U && !c || b === \"TARGET_ONLY\" && c && !U)\n        return !1;\n    }\n  }\n  if (e.options.annotations) {\n    const b = /* @__PURE__ */ new Set([\n      ...(n.created || []).map((m) => m.id),\n      ...(n.deleted || []).map((m) => m.id),\n      ...(n.updated || []).map(({ oldValue: m }) => m.id)\n    ]);\n    return !!(Array.isArray(e.options.annotations) ? e.options.annotations : [e.options.annotations]).find((m) => b.has(m));\n  } else\n    return !0;\n}, ae = (e, t) => {\n  const n = new Set((e.created || []).map((c) => c.id)), o = new Set((e.updated || []).map(({ newValue: c }) => c.id)), s = new Set((t.created || []).map((c) => c.id)), f = new Set((t.deleted || []).map((c) => c.id)), A = new Set((t.updated || []).map(({ oldValue: c }) => c.id)), b = new Set((t.updated || []).filter(({ oldValue: c }) => n.has(c.id) || o.has(c.id)).map(({ oldValue: c }) => c.id)), w = [\n    ...(e.created || []).filter((c) => !f.has(c.id)).map((c) => A.has(c.id) ? t.updated.find(({ oldValue: E }) => E.id === c.id).newValue : c),\n    ...t.created || []\n  ], m = [\n    ...(e.deleted || []).filter((c) => !s.has(c.id)),\n    ...(t.deleted || []).filter((c) => !n.has(c.id))\n  ], U = [\n    ...(e.updated || []).filter(({ newValue: c }) => !f.has(c.id)).map((c) => {\n      const { oldValue: E, newValue: T } = c;\n      if (A.has(T.id)) {\n        const h = t.updated.find((C) => C.oldValue.id === T.id).newValue;\n        return J(E, h);\n      } else\n        return c;\n    }),\n    ...(t.updated || []).filter(({ oldValue: c }) => !b.has(c.id))\n  ];\n  return { created: w, deleted: m, updated: U };\n}, $ = (e) => {\n  const t = e.id === void 0 ? G() : e.id;\n  return {\n    ...e,\n    id: t,\n    bodies: e.bodies === void 0 ? [] : e.bodies.map((n) => ({\n      ...n,\n      annotation: t\n    })),\n    target: {\n      ...e.target,\n      annotation: t\n    }\n  };\n}, ce = (e) => e.id !== void 0, Oe = () => {\n  const e = /* @__PURE__ */ new Map(), t = /* @__PURE__ */ new Map(), n = [], o = (d, l = {}) => {\n    n.push({ onChange: d, options: l });\n  }, s = (d) => {\n    const l = n.findIndex((u) => u.onChange == d);\n    l > -1 && n.splice(l, 1);\n  }, f = (d, l) => {\n    const u = {\n      origin: d,\n      changes: {\n        created: l.created || [],\n        updated: l.updated || [],\n        deleted: l.deleted || []\n      },\n      state: [...e.values()]\n    };\n    n.forEach((g) => {\n      re(g, u) && g.onChange(u);\n    });\n  }, A = (d, l = O.LOCAL) => {\n    if (d.id && e.get(d.id))\n      throw Error(`Cannot add annotation ${d.id} - exists already`);\n    {\n      const g = $(d);\n      e.set(g.id, g), g.bodies.forEach((S) => t.set(S.id, g.id)), f(l, { created: [g] });\n    }\n  }, b = (d, l) => {\n    const u = $(typeof d == \"string\" ? l : d), g = typeof d == \"string\" ? d : d.id, S = g && e.get(g);\n    if (S) {\n      const y = J(S, u);\n      return g === u.id ? e.set(g, u) : (e.delete(g), e.set(u.id, u)), S.bodies.forEach((x) => t.delete(x.id)), u.bodies.forEach((x) => t.set(x.id, u.id)), y;\n    } else\n      console.warn(`Cannot update annotation ${g} - does not exist`);\n  }, w = (d, l = O.LOCAL, u = O.LOCAL) => {\n    const g = ce(l) ? u : l, S = b(d, l);\n    S && f(g, { updated: [S] });\n  }, m = (d, l = O.LOCAL) => {\n    const u = d.reduce((g, S) => {\n      const y = b(S);\n      return y ? [...g, y] : g;\n    }, []);\n    u.length > 0 && f(l, { updated: u });\n  }, U = (d, l = O.LOCAL) => {\n    const u = e.get(d.annotation);\n    if (u) {\n      const g = {\n        ...u,\n        bodies: [...u.bodies, d]\n      };\n      e.set(u.id, g), t.set(d.id, g.id), f(l, { updated: [{\n        oldValue: u,\n        newValue: g,\n        bodiesCreated: [d]\n      }] });\n    } else\n      console.warn(`Attempt to add body to missing annotation: ${d.annotation}`);\n  }, c = () => [...e.values()], E = (d = O.LOCAL) => {\n    const l = [...e.values()];\n    e.clear(), t.clear(), f(d, { deleted: l });\n  }, T = (d, l = !0, u = O.LOCAL) => {\n    const g = d.map($);\n    if (l) {\n      const S = [...e.values()];\n      e.clear(), t.clear(), g.forEach((y) => {\n        e.set(y.id, y), y.bodies.forEach((x) => t.set(x.id, y.id));\n      }), f(u, { created: g, deleted: S });\n    } else {\n      const S = d.reduce((y, x) => {\n        const H = x.id && e.get(x.id);\n        return H ? [...y, H] : y;\n      }, []);\n      if (S.length > 0)\n        throw Error(`Bulk insert would overwrite the following annotations: ${S.map((y) => y.id).join(\", \")}`);\n      g.forEach((y) => {\n        e.set(y.id, y), y.bodies.forEach((x) => t.set(x.id, y.id));\n      }), f(u, { created: g });\n    }\n  }, h = (d) => {\n    const l = typeof d == \"string\" ? d : d.id, u = e.get(l);\n    if (u)\n      return e.delete(l), u.bodies.forEach((g) => t.delete(g.id)), u;\n    console.warn(`Attempt to delete missing annotation: ${l}`);\n  }, C = (d, l = O.LOCAL) => {\n    const u = h(d);\n    u && f(l, { deleted: [u] });\n  }, D = (d, l = O.LOCAL) => {\n    const u = d.reduce((g, S) => {\n      const y = h(S);\n      return y ? [...g, y] : g;\n    }, []);\n    u.length > 0 && f(l, { deleted: u });\n  }, a = (d) => {\n    const l = e.get(d.annotation);\n    if (l) {\n      const u = l.bodies.find((g) => g.id === d.id);\n      if (u) {\n        t.delete(u.id);\n        const g = {\n          ...l,\n          bodies: l.bodies.filter((y) => y.id !== d.id)\n        };\n        return e.set(l.id, g), {\n          oldValue: l,\n          newValue: g,\n          bodiesDeleted: [u]\n        };\n      } else\n        console.warn(`Attempt to delete missing body ${d.id} from annotation ${d.annotation}`);\n    } else\n      console.warn(`Attempt to delete body from missing annotation ${d.annotation}`);\n  }, i = (d, l = O.LOCAL) => {\n    const u = a(d);\n    u && f(l, { updated: [u] });\n  }, p = (d, l = O.LOCAL) => {\n    const u = d.map((g) => a(g)).filter(Boolean);\n    u.length > 0 && f(l, { updated: u });\n  }, v = (d) => {\n    const l = e.get(d);\n    return l ? { ...l } : void 0;\n  }, r = (d) => {\n    const l = t.get(d);\n    if (l) {\n      const g = v(l).bodies.find((S) => S.id === d);\n      if (g)\n        return g;\n      console.error(`Store integrity error: body ${d} in index, but not in annotation`);\n    } else\n      console.warn(`Attempt to retrieve missing body: ${d}`);\n  }, L = (d, l) => {\n    if (d.annotation !== l.annotation)\n      throw \"Annotation integrity violation: annotation ID must be the same when updating bodies\";\n    const u = e.get(d.annotation);\n    if (u) {\n      const g = u.bodies.find((y) => y.id === d.id), S = {\n        ...u,\n        bodies: u.bodies.map((y) => y.id === g.id ? l : y)\n      };\n      return e.set(u.id, S), g.id !== l.id && (t.delete(g.id), t.set(l.id, S.id)), {\n        oldValue: u,\n        newValue: S,\n        bodiesUpdated: [{ oldBody: g, newBody: l }]\n      };\n    } else\n      console.warn(`Attempt to add body to missing annotation ${d.annotation}`);\n  }, B = (d, l, u = O.LOCAL) => {\n    const g = L(d, l);\n    g && f(u, { updated: [g] });\n  }, I = (d, l = O.LOCAL) => {\n    const u = d.map((g) => L({ id: g.id, annotation: g.annotation }, g)).filter(Boolean);\n    f(l, { updated: u });\n  }, P = (d) => {\n    const l = e.get(d.annotation);\n    if (l) {\n      const u = {\n        ...l,\n        target: {\n          ...l.target,\n          ...d\n        }\n      };\n      return e.set(l.id, u), {\n        oldValue: l,\n        newValue: u,\n        targetUpdated: {\n          oldTarget: l.target,\n          newTarget: d\n        }\n      };\n    } else\n      console.warn(`Attempt to update target on missing annotation: ${d.annotation}`);\n  };\n  return {\n    addAnnotation: A,\n    addBody: U,\n    all: c,\n    bulkAddAnnotation: T,\n    bulkDeleteAnnotation: D,\n    bulkDeleteBodies: p,\n    bulkUpdateAnnotation: m,\n    bulkUpdateBodies: I,\n    bulkUpdateTargets: (d, l = O.LOCAL) => {\n      const u = d.map((g) => P(g)).filter(Boolean);\n      u.length > 0 && f(l, { updated: u });\n    },\n    clear: E,\n    deleteAnnotation: C,\n    deleteBody: i,\n    getAnnotation: v,\n    getBody: r,\n    observe: o,\n    unobserve: s,\n    updateAnnotation: w,\n    updateBody: B,\n    updateTarget: (d, l = O.LOCAL) => {\n      const u = P(d);\n      u && f(l, { updated: [u] });\n    }\n  };\n}, Re = (e) => ({\n  ...e,\n  subscribe: (n) => {\n    const o = (s) => n(s.state);\n    return e.observe(o), n(e.all()), () => e.unobserve(o);\n  }\n});\nlet Q = () => ({\n  emit(e, ...t) {\n    for (let n = this.events[e] || [], o = 0, s = n.length; o < s; o++)\n      n[o](...t);\n  },\n  events: {},\n  on(e, t) {\n    var n;\n    return ((n = this.events)[e] || (n[e] = [])).push(t), () => {\n      var o;\n      this.events[e] = (o = this.events[e]) == null ? void 0 : o.filter((s) => t !== s);\n    };\n  }\n});\nconst le = 250, Be = (e, t) => {\n  const n = Q(), o = (t == null ? void 0 : t.changes) || [];\n  let s = t ? t.pointer : -1, f = !1, A = 0;\n  const b = (r) => {\n    if (!f) {\n      const { changes: L } = r, B = performance.now();\n      if (B - A > le)\n        o.splice(s + 1), o.push(L), s = o.length - 1;\n      else {\n        const I = o.length - 1;\n        o[I] = ae(o[I], L);\n      }\n      A = B;\n    }\n    f = !1;\n  };\n  e.observe(b, { origin: O.LOCAL });\n  const w = (r) => r && r.length > 0 && e.bulkDeleteAnnotation(r), m = (r) => r && r.length > 0 && e.bulkAddAnnotation(r, !1), U = (r) => r && r.length > 0 && e.bulkUpdateAnnotation(r.map(({ oldValue: L }) => L)), c = (r) => r && r.length > 0 && e.bulkUpdateAnnotation(r.map(({ newValue: L }) => L)), E = (r) => r && r.length > 0 && e.bulkAddAnnotation(r, !1), T = (r) => r && r.length > 0 && e.bulkDeleteAnnotation(r);\n  return {\n    canRedo: () => o.length - 1 > s,\n    canUndo: () => s > -1,\n    destroy: () => e.unobserve(b),\n    getHistory: () => ({ changes: [...o], pointer: s }),\n    on: (r, L) => n.on(r, L),\n    redo: () => {\n      if (o.length - 1 > s) {\n        f = !0;\n        const { created: r, updated: L, deleted: B } = o[s + 1];\n        m(r), c(L), T(B), n.emit(\"redo\", o[s + 1]), s += 1;\n      }\n    },\n    undo: () => {\n      if (s > -1) {\n        f = !0;\n        const { created: r, updated: L, deleted: B } = o[s];\n        w(r), U(L), E(B), n.emit(\"undo\", o[s]), s -= 1;\n      }\n    }\n  };\n}, xe = () => {\n  const { subscribe: e, set: t } = j([]);\n  return {\n    subscribe: e,\n    set: t\n  };\n}, Ie = (e, t, n, o) => {\n  const { hover: s, selection: f, store: A, viewport: b } = e, w = /* @__PURE__ */ new Map();\n  let m = [], U, c;\n  const E = (a, i) => {\n    w.has(a) ? w.get(a).push(i) : w.set(a, [i]);\n  }, T = (a, i) => {\n    const p = w.get(a);\n    if (p) {\n      const v = p.indexOf(i);\n      v !== -1 && p.splice(v, 1);\n    }\n  }, h = (a, i, p) => {\n    w.has(a) && setTimeout(() => {\n      w.get(a).forEach((v) => {\n        if (n) {\n          const r = Array.isArray(i) ? i.map((B) => n.serialize(B)) : n.serialize(i), L = p ? p instanceof PointerEvent ? p : n.serialize(p) : void 0;\n          v(r, L);\n        } else\n          v(i, p);\n      });\n    }, 1);\n  }, C = () => {\n    const { selected: a } = f, i = (a || []).map(({ id: p }) => A.getAnnotation(p));\n    i.forEach((p) => {\n      const v = m.find((r) => r.id === p.id);\n      (!v || !k(v, p)) && h(\"updateAnnotation\", p, v);\n    }), m = m.map((p) => {\n      const v = i.find(({ id: r }) => r === p.id);\n      return v || p;\n    });\n  };\n  f.subscribe(({ selected: a }) => {\n    if (!(m.length === 0 && a.length === 0)) {\n      if (m.length === 0 && a.length > 0)\n        m = a.map(({ id: i }) => A.getAnnotation(i));\n      else if (m.length > 0 && a.length === 0)\n        m.forEach((i) => {\n          const p = A.getAnnotation(i.id);\n          p && !k(p, i) && h(\"updateAnnotation\", p, i);\n        }), m = [];\n      else {\n        const i = new Set(m.map((r) => r.id)), p = new Set(a.map(({ id: r }) => r));\n        m.filter((r) => !p.has(r.id)).forEach((r) => {\n          const L = A.getAnnotation(r.id);\n          L && !k(L, r) && h(\"updateAnnotation\", L, r);\n        }), m = [\n          // Remove annotations that were deselected\n          ...m.filter((r) => p.has(r.id)),\n          // Add editable annotations that were selected\n          ...a.filter(({ id: r }) => !i.has(r)).map(({ id: r }) => A.getAnnotation(r))\n        ];\n      }\n      h(\"selectionChanged\", m);\n    }\n  }), s.subscribe((a) => {\n    !U && a ? h(\"mouseEnterAnnotation\", A.getAnnotation(a)) : U && !a ? h(\"mouseLeaveAnnotation\", A.getAnnotation(U)) : U && a && (h(\"mouseLeaveAnnotation\", A.getAnnotation(U)), h(\"mouseEnterAnnotation\", A.getAnnotation(a))), U = a;\n  }), b == null || b.subscribe((a) => h(\"viewportIntersect\", a.map((i) => A.getAnnotation(i)))), A.observe((a) => {\n    o && (c && clearTimeout(c), c = setTimeout(C, 1e3));\n    const { created: i, deleted: p } = a.changes;\n    (i || []).forEach((r) => h(\"createAnnotation\", r)), (p || []).forEach((r) => h(\"deleteAnnotation\", r)), (a.changes.updated || []).filter((r) => [\n      ...r.bodiesCreated || [],\n      ...r.bodiesDeleted || [],\n      ...r.bodiesUpdated || []\n    ].length > 0).forEach(({ oldValue: r, newValue: L }) => {\n      const B = m.find((I) => I.id === r.id) || r;\n      m = m.map((I) => I.id === r.id ? L : I), h(\"updateAnnotation\", L, B);\n    });\n  }, { origin: O.LOCAL }), A.observe((a) => {\n    if (m) {\n      const i = new Set(m.map((v) => v.id)), p = (a.changes.updated || []).filter(({ newValue: v }) => i.has(v.id)).map(({ newValue: v }) => v);\n      p.length > 0 && (m = m.map((v) => {\n        const r = p.find((L) => L.id === v.id);\n        return r || v;\n      }));\n    }\n  }, { origin: O.REMOTE });\n  const D = (a) => (i) => {\n    const { updated: p } = i;\n    a ? (p || []).forEach((v) => h(\"updateAnnotation\", v.oldValue, v.newValue)) : (p || []).forEach((v) => h(\"updateAnnotation\", v.newValue, v.oldValue));\n  };\n  return t.on(\"undo\", D(!0)), t.on(\"redo\", D(!1)), { on: E, off: T, emit: h };\n}, ke = (e) => (t) => t.map((n) => e.serialize(n)), ue = (e) => (t) => t.reduce((n, o) => {\n  const { parsed: s, error: f } = e.parse(o);\n  return f ? {\n    parsed: n.parsed,\n    failed: [...n.failed, o]\n  } : s ? {\n    parsed: [...n.parsed, s],\n    failed: n.failed\n  } : {\n    ...n\n  };\n}, { parsed: [], failed: [] }), Ne = (e, t, n) => {\n  const { store: o, selection: s } = e, f = (a) => {\n    if (n) {\n      const { parsed: i, error: p } = n.parse(a);\n      i ? o.addAnnotation(i, O.REMOTE) : console.error(p);\n    } else\n      o.addAnnotation(Y(a), O.REMOTE);\n  }, A = () => s.clear(), b = () => o.clear(), w = (a) => {\n    const i = o.getAnnotation(a);\n    return n && i ? n.serialize(i) : i;\n  }, m = () => n ? o.all().map(n.serialize) : o.all(), U = () => {\n    var p;\n    const i = (((p = s.selected) == null ? void 0 : p.map((v) => v.id)) || []).map((v) => o.getAnnotation(v)).filter(Boolean);\n    return n ? i.map(n.serialize) : i;\n  }, c = (a, i = !0) => fetch(a).then((p) => p.json()).then((p) => (T(p, i), p)), E = (a) => {\n    if (typeof a == \"string\") {\n      const i = o.getAnnotation(a);\n      if (o.deleteAnnotation(a), i)\n        return n ? n.serialize(i) : i;\n    } else {\n      const i = n ? n.parse(a).parsed : a;\n      if (i)\n        return o.deleteAnnotation(i), a;\n    }\n  }, T = (a, i = !0) => {\n    if (n) {\n      const p = n.parseAll || ue(n), { parsed: v, failed: r } = p(a);\n      r.length > 0 && console.warn(`Discarded ${r.length} invalid annotations`, r), o.bulkAddAnnotation(v, i, O.REMOTE);\n    } else\n      o.bulkAddAnnotation(a.map(Y), i, O.REMOTE);\n  }, h = (a, i) => {\n    a ? s.setSelected(a, i) : s.clear();\n  }, C = (a) => {\n    s.clear(), s.setUserSelectAction(a);\n  }, D = (a) => {\n    if (n) {\n      const i = n.parse(a).parsed, p = n.serialize(o.getAnnotation(i.id));\n      return o.updateAnnotation(i), p;\n    } else {\n      const i = o.getAnnotation(a.id);\n      return o.updateAnnotation(Y(a)), i;\n    }\n  };\n  return {\n    addAnnotation: f,\n    cancelSelected: A,\n    canRedo: t.canRedo,\n    canUndo: t.canUndo,\n    clearAnnotations: b,\n    getAnnotationById: w,\n    getAnnotations: m,\n    getHistory: t.getHistory,\n    getSelected: U,\n    loadAnnotations: c,\n    redo: t.redo,\n    removeAnnotation: E,\n    setAnnotations: T,\n    setSelected: h,\n    setUserSelectAction: C,\n    undo: t.undo,\n    updateAnnotation: D\n  };\n}, ze = (e, t, n) => typeof t == \"function\" ? t(e, n) : t, $e = (e, t) => typeof e != \"function\" && typeof t != \"function\" ? {\n  ...e || {},\n  ...t || {}\n} : (n, o) => {\n  const s = typeof e == \"function\" ? e(n, o) : e, f = typeof t == \"function\" ? t(n, o) : t;\n  return {\n    ...s || {},\n    ...f || {}\n  };\n}, fe = \"useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict\";\nlet pe = (e) => crypto.getRandomValues(new Uint8Array(e)), ge = (e, t, n) => {\n  let o = (2 << Math.log2(e.length - 1)) - 1, s = -~(1.6 * o * t / e.length);\n  return (f = t) => {\n    let A = \"\";\n    for (; ; ) {\n      let b = n(s), w = s | 0;\n      for (; w--; )\n        if (A += e[b[w] & o] || \"\", A.length >= f) return A;\n    }\n  };\n}, he = (e, t = 21) => ge(e, t | 0, pe), me = (e = 21) => {\n  let t = \"\", n = crypto.getRandomValues(new Uint8Array(e |= 0));\n  for (; e--; )\n    t += fe[n[e] & 63];\n  return t;\n};\nconst Ve = () => ({ isGuest: !0, id: he(\"1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_\", 20)() }), Ae = (e) => {\n  const t = JSON.stringify(e);\n  let n = 0;\n  for (let o = 0, s = t.length; o < s; o++) {\n    let f = t.charCodeAt(o);\n    n = (n << 5) - n + f, n |= 0;\n  }\n  return `${n}`;\n}, be = (e) => e ? typeof e == \"object\" ? { ...e } : e : void 0, _e = (e, t) => (Array.isArray(e) ? e : [e]).map((n) => {\n  const { id: o, type: s, purpose: f, value: A, created: b, modified: w, creator: m, ...U } = n;\n  return {\n    id: o || `temp-${Ae(n)}`,\n    annotation: t,\n    type: s,\n    purpose: f,\n    value: A,\n    creator: be(m),\n    created: b ? new Date(b) : void 0,\n    updated: w ? new Date(w) : void 0,\n    ...U\n  };\n}), Ye = (e) => e.map((t) => {\n  var b;\n  const { annotation: n, created: o, updated: s, ...f } = t, A = {\n    ...f,\n    created: o == null ? void 0 : o.toISOString(),\n    modified: s == null ? void 0 : s.toISOString()\n  };\n  return (b = A.id) != null && b.startsWith(\"temp-\") && delete A.id, A;\n}), ve = [\n  \"#ff7c00\",\n  // orange\n  \"#1ac938\",\n  // green\n  \"#e8000b\",\n  // red\n  \"#8b2be2\",\n  // purple\n  \"#9f4800\",\n  // brown\n  \"#f14cc1\",\n  // pink\n  \"#ffc400\",\n  // khaki\n  \"#00d7ff\",\n  // cyan\n  \"#023eff\"\n  // blue\n], Ee = () => {\n  const e = [...ve];\n  return { assignRandomColor: () => {\n    const o = Math.floor(Math.random() * e.length), s = e[o];\n    return e.splice(o, 1), s;\n  }, releaseColor: (o) => e.push(o) };\n}, we = () => {\n  const e = Ee();\n  return { addUser: (o, s) => {\n    const f = e.assignRandomColor();\n    return {\n      label: s.name || s.id,\n      avatar: s.avatar,\n      color: f\n    };\n  }, removeUser: (o) => e.releaseColor(o.appearance.color) };\n}, Ce = (e, t) => e.every((n) => e.includes(n)) && t.every((n) => e.includes(n)), je = me(), Pe = (e = we()) => {\n  const t = Q(), n = /* @__PURE__ */ new Map(), o = /* @__PURE__ */ new Map(), s = (c, E) => {\n    if (n.has(c)) {\n      console.warn(\"Attempt to add user that is already present\", c, E);\n      return;\n    }\n    const T = e.addUser(c, E);\n    n.set(c, {\n      ...E,\n      presenceKey: c,\n      appearance: T\n    });\n  }, f = (c) => {\n    const E = n.get(c);\n    if (!E) {\n      console.warn(\"Attempt to remove user that is not present\", c);\n      return;\n    }\n    e.removeUser(E), n.delete(c);\n  }, A = (c) => {\n    const E = new Set(c.map((C) => C.presenceKey)), T = c.filter(({ presenceKey: C }) => !n.has(C)), h = Array.from(n.values()).filter((C) => !E.has(C.presenceKey));\n    T.forEach(({ presenceKey: C, user: D }) => s(C, D)), h.forEach((C) => {\n      const { presenceKey: D } = C;\n      o.has(D) && t.emit(\"selectionChange\", C, null), f(D);\n    }), (T.length > 0 || h.length > 0) && t.emit(\"presence\", m());\n  }, b = (c, E) => {\n    const T = n.get(c);\n    if (!T) {\n      console.warn(\"Activity notification from user that is not present\");\n      return;\n    }\n    const h = o.get(c);\n    (!h || !Ce(h, E)) && (o.set(c, E), t.emit(\"selectionChange\", T, E));\n  }, w = (c, E) => {\n    const T = n.get(c);\n    if (!T) {\n      console.warn(\"Selection change for user that is not present\", c);\n      return;\n    }\n    E ? o.set(c, E) : o.delete(c), t.emit(\"selectionChange\", T, E);\n  }, m = () => [...Array.from(n.values())];\n  return {\n    getPresentUsers: m,\n    notifyActivity: b,\n    on: (c, E) => t.on(c, E),\n    syncUsers: A,\n    updateSelection: w\n  };\n};\nexport {\n  de as Ignore,\n  O as Origin,\n  je as PRESENCE_KEY,\n  Z as UserSelectAction,\n  $e as chainStyles,\n  ze as computeStyle,\n  Ve as createAnonymousGuest,\n  Ne as createBaseAnnotator,\n  De as createBody,\n  we as createDefaultAppearanceProvider,\n  Ue as createHoverState,\n  Ie as createLifecycleObserver,\n  Pe as createPresenceState,\n  Se as createSelectionState,\n  Oe as createStore,\n  Be as createUndoStack,\n  xe as createViewportState,\n  Ee as defaultColorProvider,\n  J as diffAnnotations,\n  Te as getContributors,\n  ae as mergeChanges,\n  W as onUserSelect,\n  ue as parseAll,\n  _e as parseW3CBodies,\n  be as parseW3CUser,\n  Y as reviveDates,\n  ke as serializeAll,\n  Ye as serializeW3CBodies,\n  re as shouldNotify,\n  Re as toSvelteStore\n};\n//# sourceMappingURL=annotorious-core.es.js.map\n","import { v4 as uuidv4 } from 'uuid';\nimport {\n  type FormatAdapter,\n  type ParseResult,\n  parseW3CBodies,\n  parseW3CUser,\n  serializeW3CBodies\n} from '@annotorious/core';\nimport type { TextAnnotation, TextAnnotationTarget, TextSelector } from '../core';\nimport type { W3CTextAnnotation, W3CTextAnnotationTarget, W3CTextSelector } from '../w3c';\nimport { getQuoteContext } from '../../utils';\n\nexport type W3CTextFormatAdapter<I extends TextAnnotation = TextAnnotation, E extends W3CTextAnnotation = W3CTextAnnotation> = FormatAdapter<I, E>;\n\n/**\n * @param source - the IRI of the annotated content\n * @param container - the HTML container of the annotated content,\n *                    Required to locate the content's `range` within the DOM\n */\nexport const W3CTextFormat =<I extends TextAnnotation = TextAnnotation, E extends W3CTextAnnotation = W3CTextAnnotation>(\n  source: string,\n  container: HTMLElement\n): W3CTextFormatAdapter<I, E> => ({\n  parse: (serialized) => parseW3CTextAnnotation(serialized),\n  serialize: (annotation) => serializeW3CTextAnnotation(annotation, source, container)\n});\n\nconst isTextSelector = (selector: Partial<TextSelector>): selector is TextSelector =>\n  selector.quote !== undefined && selector.start !== undefined && selector.end !== undefined;\n\nconst parseW3CTextTargets = (annotation: W3CTextAnnotation) => {\n  const {\n    id: annotationId,\n    creator,\n    created,\n    modified,\n    target\n  } = annotation;\n\n  const w3cTargets = Array.isArray(target) ? target : [target];\n  if (w3cTargets.length === 0) {\n    return { error: Error(`No targets found for annotation: ${annotation.id}`) };\n  }\n\n  const parsed: TextAnnotationTarget = {\n    creator: parseW3CUser(creator),\n    created: created ? new Date(created) : undefined,\n    updated: modified ? new Date(modified) : undefined,\n    annotation: annotationId,\n    selector: [],\n    // @ts-expect-error: `styleClass` is not part of the core `TextAnnotationTarget` type\n    styleClass: 'styleClass' in w3cTargets[0] ? w3cTargets[0].styleClass : undefined\n  };\n\n  for (const w3cTarget of w3cTargets) {\n    const w3cSelectors = Array.isArray(w3cTarget.selector) ? w3cTarget.selector : [w3cTarget.selector];\n\n    const selector = w3cSelectors.reduce<Partial<TextSelector>>((s, w3cSelector) => {\n      switch (w3cSelector.type) {\n        case 'TextQuoteSelector':\n          s.quote = w3cSelector.exact;\n          break;\n        case 'TextPositionSelector':\n          s.start = w3cSelector.start;\n          s.end = w3cSelector.end;\n          break;\n      }\n      return s;\n    }, {});\n\n    if (isTextSelector(selector)) {\n      parsed.selector.push(\n        {\n          ...selector,\n          id: w3cTarget.id,\n          // @ts-expect-error: `scope` is not part of the core `TextSelector` type\n          scope: w3cTarget.scope\n        }\n      );\n    } else {\n      const missingTypes = [\n        !selector.start ? 'TextPositionSelector' : undefined,\n        !selector.quote ? 'TextQuoteSelector' : undefined\n      ].filter(Boolean);\n\n      return { error: Error(`Missing selector types: ${missingTypes.join(' and ')} for annotation: ${annotation.id}`) };\n    }\n  }\n\n  return { parsed };\n};\n\nexport const parseW3CTextAnnotation = <I extends TextAnnotation = TextAnnotation, E extends W3CTextAnnotation = W3CTextAnnotation>(\n  annotation: E\n): ParseResult<I> => {\n  const annotationId = annotation.id || uuidv4();\n\n  const {\n    creator,\n    created,\n    modified,\n    body,\n    ...rest\n  } = annotation;\n\n  const bodies = parseW3CBodies(body, annotationId);\n  const target = parseW3CTextTargets(annotation);\n\n  const parseResult = 'error' in target\n    ? { error: target.error }\n    : {\n      parsed: {\n        ...rest,\n        id: annotationId,\n        bodies,\n        target: target.parsed\n      }\n    };\n\n  return parseResult as ParseResult<I>;\n\n};\n\nexport const serializeW3CTextAnnotation = <I extends TextAnnotation = TextAnnotation, E extends W3CTextAnnotation = W3CTextAnnotation>(\n  annotation: I,\n  source: string,\n  container: HTMLElement\n): E => {\n  const { bodies, target, ...rest } = annotation;\n\n  const {\n    selector,\n    creator,\n    created,\n    updated,\n    ...targetRest\n  } = target;\n\n  const w3cTargets = selector.map((s): W3CTextAnnotationTarget => {\n    const { id, quote, start, end, range } = s;\n\n    const { prefix, suffix } = getQuoteContext(range, container);\n\n    const w3cSelectors: W3CTextSelector[] = [{\n      type: 'TextQuoteSelector',\n      exact: quote,\n      prefix,\n      suffix\n    }, {\n      type: 'TextPositionSelector',\n      start,\n      end\n    }];\n\n    return {\n      ...targetRest,\n      id,\n      // @ts-expect-error: `scope` is not part of the core `TextSelector` type\n      scope: 'scope' in s ? s.scope : undefined,\n      source,\n      selector: w3cSelectors\n    };\n  });\n\n\n  return {\n    ...rest,\n    '@context': 'http://www.w3.org/ns/anno.jsonld',\n    id: annotation.id,\n    type: 'Annotation',\n    body: serializeW3CBodies(annotation.bodies),\n    creator,\n    created: created?.toISOString(),\n    modified: updated?.toISOString(),\n    target: w3cTargets\n  } as unknown as E;\n\n};\n","\n/**\n * Rearranges items so that all items in the [left, k] are the smallest.\n * The k-th element will have the (k - left + 1)-th smallest value in [left, right].\n *\n * @template T\n * @param {T[]} arr the array to partially sort (in place)\n * @param {number} k middle index for partial sorting (as defined above)\n * @param {number} [left=0] left index of the range to sort\n * @param {number} [right=arr.length-1] right index\n * @param {(a: T, b: T) => number} [compare = (a, b) => a - b] compare function\n */\nexport default function quickselect(arr, k, left = 0, right = arr.length - 1, compare = defaultCompare) {\n\n    while (right > left) {\n        if (right - left > 600) {\n            const n = right - left + 1;\n            const m = k - left + 1;\n            const z = Math.log(n);\n            const s = 0.5 * Math.exp(2 * z / 3);\n            const sd = 0.5 * Math.sqrt(z * s * (n - s) / n) * (m - n / 2 < 0 ? -1 : 1);\n            const newLeft = Math.max(left, Math.floor(k - m * s / n + sd));\n            const newRight = Math.min(right, Math.floor(k + (n - m) * s / n + sd));\n            quickselect(arr, k, newLeft, newRight, compare);\n        }\n\n        const t = arr[k];\n        let i = left;\n        /** @type {number} */\n        let j = right;\n\n        swap(arr, left, k);\n        if (compare(arr[right], t) > 0) swap(arr, left, right);\n\n        while (i < j) {\n            swap(arr, i, j);\n            i++;\n            j--;\n            while (compare(arr[i], t) < 0) i++;\n            while (compare(arr[j], t) > 0) j--;\n        }\n\n        if (compare(arr[left], t) === 0) swap(arr, left, j);\n        else {\n            j++;\n            swap(arr, j, right);\n        }\n\n        if (j <= k) left = j + 1;\n        if (k <= j) right = j - 1;\n    }\n}\n\n/**\n * @template T\n * @param {T[]} arr\n * @param {number} i\n * @param {number} j\n */\nfunction swap(arr, i, j) {\n    const tmp = arr[i];\n    arr[i] = arr[j];\n    arr[j] = tmp;\n}\n\n/**\n * @template T\n * @param {T} a\n * @param {T} b\n * @returns {number}\n */\nfunction defaultCompare(a, b) {\n    return a < b ? -1 : a > b ? 1 : 0;\n}\n","import quickselect from 'quickselect';\n\nexport default class RBush {\n    constructor(maxEntries = 9) {\n        // max entries in a node is 9 by default; min node fill is 40% for best performance\n        this._maxEntries = Math.max(4, maxEntries);\n        this._minEntries = Math.max(2, Math.ceil(this._maxEntries * 0.4));\n        this.clear();\n    }\n\n    all() {\n        return this._all(this.data, []);\n    }\n\n    search(bbox) {\n        let node = this.data;\n        const result = [];\n\n        if (!intersects(bbox, node)) return result;\n\n        const toBBox = this.toBBox;\n        const nodesToSearch = [];\n\n        while (node) {\n            for (let i = 0; i < node.children.length; i++) {\n                const child = node.children[i];\n                const childBBox = node.leaf ? toBBox(child) : child;\n\n                if (intersects(bbox, childBBox)) {\n                    if (node.leaf) result.push(child);\n                    else if (contains(bbox, childBBox)) this._all(child, result);\n                    else nodesToSearch.push(child);\n                }\n            }\n            node = nodesToSearch.pop();\n        }\n\n        return result;\n    }\n\n    collides(bbox) {\n        let node = this.data;\n\n        if (!intersects(bbox, node)) return false;\n\n        const nodesToSearch = [];\n        while (node) {\n            for (let i = 0; i < node.children.length; i++) {\n                const child = node.children[i];\n                const childBBox = node.leaf ? this.toBBox(child) : child;\n\n                if (intersects(bbox, childBBox)) {\n                    if (node.leaf || contains(bbox, childBBox)) return true;\n                    nodesToSearch.push(child);\n                }\n            }\n            node = nodesToSearch.pop();\n        }\n\n        return false;\n    }\n\n    load(data) {\n        if (!(data && data.length)) return this;\n\n        if (data.length < this._minEntries) {\n            for (let i = 0; i < data.length; i++) {\n                this.insert(data[i]);\n            }\n            return this;\n        }\n\n        // recursively build the tree with the given data from scratch using OMT algorithm\n        let node = this._build(data.slice(), 0, data.length - 1, 0);\n\n        if (!this.data.children.length) {\n            // save as is if tree is empty\n            this.data = node;\n\n        } else if (this.data.height === node.height) {\n            // split root if trees have the same height\n            this._splitRoot(this.data, node);\n\n        } else {\n            if (this.data.height < node.height) {\n                // swap trees if inserted one is bigger\n                const tmpNode = this.data;\n                this.data = node;\n                node = tmpNode;\n            }\n\n            // insert the small tree into the large tree at appropriate level\n            this._insert(node, this.data.height - node.height - 1, true);\n        }\n\n        return this;\n    }\n\n    insert(item) {\n        if (item) this._insert(item, this.data.height - 1);\n        return this;\n    }\n\n    clear() {\n        this.data = createNode([]);\n        return this;\n    }\n\n    remove(item, equalsFn) {\n        if (!item) return this;\n\n        let node = this.data;\n        const bbox = this.toBBox(item);\n        const path = [];\n        const indexes = [];\n        let i, parent, goingUp;\n\n        // depth-first iterative tree traversal\n        while (node || path.length) {\n\n            if (!node) { // go up\n                node = path.pop();\n                parent = path[path.length - 1];\n                i = indexes.pop();\n                goingUp = true;\n            }\n\n            if (node.leaf) { // check current node\n                const index = findItem(item, node.children, equalsFn);\n\n                if (index !== -1) {\n                    // item found, remove the item and condense tree upwards\n                    node.children.splice(index, 1);\n                    path.push(node);\n                    this._condense(path);\n                    return this;\n                }\n            }\n\n            if (!goingUp && !node.leaf && contains(node, bbox)) { // go down\n                path.push(node);\n                indexes.push(i);\n                i = 0;\n                parent = node;\n                node = node.children[0];\n\n            } else if (parent) { // go right\n                i++;\n                node = parent.children[i];\n                goingUp = false;\n\n            } else node = null; // nothing found\n        }\n\n        return this;\n    }\n\n    toBBox(item) { return item; }\n\n    compareMinX(a, b) { return a.minX - b.minX; }\n    compareMinY(a, b) { return a.minY - b.minY; }\n\n    toJSON() { return this.data; }\n\n    fromJSON(data) {\n        this.data = data;\n        return this;\n    }\n\n    _all(node, result) {\n        const nodesToSearch = [];\n        while (node) {\n            if (node.leaf) result.push(...node.children);\n            else nodesToSearch.push(...node.children);\n\n            node = nodesToSearch.pop();\n        }\n        return result;\n    }\n\n    _build(items, left, right, height) {\n\n        const N = right - left + 1;\n        let M = this._maxEntries;\n        let node;\n\n        if (N <= M) {\n            // reached leaf level; return leaf\n            node = createNode(items.slice(left, right + 1));\n            calcBBox(node, this.toBBox);\n            return node;\n        }\n\n        if (!height) {\n            // target height of the bulk-loaded tree\n            height = Math.ceil(Math.log(N) / Math.log(M));\n\n            // target number of root entries to maximize storage utilization\n            M = Math.ceil(N / Math.pow(M, height - 1));\n        }\n\n        node = createNode([]);\n        node.leaf = false;\n        node.height = height;\n\n        // split the items into M mostly square tiles\n\n        const N2 = Math.ceil(N / M);\n        const N1 = N2 * Math.ceil(Math.sqrt(M));\n\n        multiSelect(items, left, right, N1, this.compareMinX);\n\n        for (let i = left; i <= right; i += N1) {\n\n            const right2 = Math.min(i + N1 - 1, right);\n\n            multiSelect(items, i, right2, N2, this.compareMinY);\n\n            for (let j = i; j <= right2; j += N2) {\n\n                const right3 = Math.min(j + N2 - 1, right2);\n\n                // pack each entry recursively\n                node.children.push(this._build(items, j, right3, height - 1));\n            }\n        }\n\n        calcBBox(node, this.toBBox);\n\n        return node;\n    }\n\n    _chooseSubtree(bbox, node, level, path) {\n        while (true) {\n            path.push(node);\n\n            if (node.leaf || path.length - 1 === level) break;\n\n            let minArea = Infinity;\n            let minEnlargement = Infinity;\n            let targetNode;\n\n            for (let i = 0; i < node.children.length; i++) {\n                const child = node.children[i];\n                const area = bboxArea(child);\n                const enlargement = enlargedArea(bbox, child) - area;\n\n                // choose entry with the least area enlargement\n                if (enlargement < minEnlargement) {\n                    minEnlargement = enlargement;\n                    minArea = area < minArea ? area : minArea;\n                    targetNode = child;\n\n                } else if (enlargement === minEnlargement) {\n                    // otherwise choose one with the smallest area\n                    if (area < minArea) {\n                        minArea = area;\n                        targetNode = child;\n                    }\n                }\n            }\n\n            node = targetNode || node.children[0];\n        }\n\n        return node;\n    }\n\n    _insert(item, level, isNode) {\n        const bbox = isNode ? item : this.toBBox(item);\n        const insertPath = [];\n\n        // find the best node for accommodating the item, saving all nodes along the path too\n        const node = this._chooseSubtree(bbox, this.data, level, insertPath);\n\n        // put the item into the node\n        node.children.push(item);\n        extend(node, bbox);\n\n        // split on node overflow; propagate upwards if necessary\n        while (level >= 0) {\n            if (insertPath[level].children.length > this._maxEntries) {\n                this._split(insertPath, level);\n                level--;\n            } else break;\n        }\n\n        // adjust bboxes along the insertion path\n        this._adjustParentBBoxes(bbox, insertPath, level);\n    }\n\n    // split overflowed node into two\n    _split(insertPath, level) {\n        const node = insertPath[level];\n        const M = node.children.length;\n        const m = this._minEntries;\n\n        this._chooseSplitAxis(node, m, M);\n\n        const splitIndex = this._chooseSplitIndex(node, m, M);\n\n        const newNode = createNode(node.children.splice(splitIndex, node.children.length - splitIndex));\n        newNode.height = node.height;\n        newNode.leaf = node.leaf;\n\n        calcBBox(node, this.toBBox);\n        calcBBox(newNode, this.toBBox);\n\n        if (level) insertPath[level - 1].children.push(newNode);\n        else this._splitRoot(node, newNode);\n    }\n\n    _splitRoot(node, newNode) {\n        // split root node\n        this.data = createNode([node, newNode]);\n        this.data.height = node.height + 1;\n        this.data.leaf = false;\n        calcBBox(this.data, this.toBBox);\n    }\n\n    _chooseSplitIndex(node, m, M) {\n        let index;\n        let minOverlap = Infinity;\n        let minArea = Infinity;\n\n        for (let i = m; i <= M - m; i++) {\n            const bbox1 = distBBox(node, 0, i, this.toBBox);\n            const bbox2 = distBBox(node, i, M, this.toBBox);\n\n            const overlap = intersectionArea(bbox1, bbox2);\n            const area = bboxArea(bbox1) + bboxArea(bbox2);\n\n            // choose distribution with minimum overlap\n            if (overlap < minOverlap) {\n                minOverlap = overlap;\n                index = i;\n\n                minArea = area < minArea ? area : minArea;\n\n            } else if (overlap === minOverlap) {\n                // otherwise choose distribution with minimum area\n                if (area < minArea) {\n                    minArea = area;\n                    index = i;\n                }\n            }\n        }\n\n        return index || M - m;\n    }\n\n    // sorts node children by the best axis for split\n    _chooseSplitAxis(node, m, M) {\n        const compareMinX = node.leaf ? this.compareMinX : compareNodeMinX;\n        const compareMinY = node.leaf ? this.compareMinY : compareNodeMinY;\n        const xMargin = this._allDistMargin(node, m, M, compareMinX);\n        const yMargin = this._allDistMargin(node, m, M, compareMinY);\n\n        // if total distributions margin value is minimal for x, sort by minX,\n        // otherwise it's already sorted by minY\n        if (xMargin < yMargin) node.children.sort(compareMinX);\n    }\n\n    // total margin of all possible split distributions where each node is at least m full\n    _allDistMargin(node, m, M, compare) {\n        node.children.sort(compare);\n\n        const toBBox = this.toBBox;\n        const leftBBox = distBBox(node, 0, m, toBBox);\n        const rightBBox = distBBox(node, M - m, M, toBBox);\n        let margin = bboxMargin(leftBBox) + bboxMargin(rightBBox);\n\n        for (let i = m; i < M - m; i++) {\n            const child = node.children[i];\n            extend(leftBBox, node.leaf ? toBBox(child) : child);\n            margin += bboxMargin(leftBBox);\n        }\n\n        for (let i = M - m - 1; i >= m; i--) {\n            const child = node.children[i];\n            extend(rightBBox, node.leaf ? toBBox(child) : child);\n            margin += bboxMargin(rightBBox);\n        }\n\n        return margin;\n    }\n\n    _adjustParentBBoxes(bbox, path, level) {\n        // adjust bboxes along the given tree path\n        for (let i = level; i >= 0; i--) {\n            extend(path[i], bbox);\n        }\n    }\n\n    _condense(path) {\n        // go through the path, removing empty nodes and updating bboxes\n        for (let i = path.length - 1, siblings; i >= 0; i--) {\n            if (path[i].children.length === 0) {\n                if (i > 0) {\n                    siblings = path[i - 1].children;\n                    siblings.splice(siblings.indexOf(path[i]), 1);\n\n                } else this.clear();\n\n            } else calcBBox(path[i], this.toBBox);\n        }\n    }\n}\n\nfunction findItem(item, items, equalsFn) {\n    if (!equalsFn) return items.indexOf(item);\n\n    for (let i = 0; i < items.length; i++) {\n        if (equalsFn(item, items[i])) return i;\n    }\n    return -1;\n}\n\n// calculate node's bbox from bboxes of its children\nfunction calcBBox(node, toBBox) {\n    distBBox(node, 0, node.children.length, toBBox, node);\n}\n\n// min bounding rectangle of node children from k to p-1\nfunction distBBox(node, k, p, toBBox, destNode) {\n    if (!destNode) destNode = createNode(null);\n    destNode.minX = Infinity;\n    destNode.minY = Infinity;\n    destNode.maxX = -Infinity;\n    destNode.maxY = -Infinity;\n\n    for (let i = k; i < p; i++) {\n        const child = node.children[i];\n        extend(destNode, node.leaf ? toBBox(child) : child);\n    }\n\n    return destNode;\n}\n\nfunction extend(a, b) {\n    a.minX = Math.min(a.minX, b.minX);\n    a.minY = Math.min(a.minY, b.minY);\n    a.maxX = Math.max(a.maxX, b.maxX);\n    a.maxY = Math.max(a.maxY, b.maxY);\n    return a;\n}\n\nfunction compareNodeMinX(a, b) { return a.minX - b.minX; }\nfunction compareNodeMinY(a, b) { return a.minY - b.minY; }\n\nfunction bboxArea(a)   { return (a.maxX - a.minX) * (a.maxY - a.minY); }\nfunction bboxMargin(a) { return (a.maxX - a.minX) + (a.maxY - a.minY); }\n\nfunction enlargedArea(a, b) {\n    return (Math.max(b.maxX, a.maxX) - Math.min(b.minX, a.minX)) *\n           (Math.max(b.maxY, a.maxY) - Math.min(b.minY, a.minY));\n}\n\nfunction intersectionArea(a, b) {\n    const minX = Math.max(a.minX, b.minX);\n    const minY = Math.max(a.minY, b.minY);\n    const maxX = Math.min(a.maxX, b.maxX);\n    const maxY = Math.min(a.maxY, b.maxY);\n\n    return Math.max(0, maxX - minX) *\n           Math.max(0, maxY - minY);\n}\n\nfunction contains(a, b) {\n    return a.minX <= b.minX &&\n           a.minY <= b.minY &&\n           b.maxX <= a.maxX &&\n           b.maxY <= a.maxY;\n}\n\nfunction intersects(a, b) {\n    return b.minX <= a.maxX &&\n           b.minY <= a.maxY &&\n           b.maxX >= a.minX &&\n           b.maxY >= a.minY;\n}\n\nfunction createNode(children) {\n    return {\n        children,\n        height: 1,\n        leaf: true,\n        minX: Infinity,\n        minY: Infinity,\n        maxX: -Infinity,\n        maxY: -Infinity\n    };\n}\n\n// sort an array so that items come in groups of n unsorted items, with groups sorted between each other;\n// combines selection algorithm with binary divide & conquer approach\n\nfunction multiSelect(arr, left, right, n, compare) {\n    const stack = [left, right];\n\n    while (stack.length) {\n        right = stack.pop();\n        left = stack.pop();\n\n        if (right - left <= n) continue;\n\n        const mid = left + Math.ceil((right - left) / n / 2) * n;\n        quickselect(arr, mid, left, right, compare);\n\n        stack.push(left, mid, mid, right);\n    }\n}\n","import RBush from 'rbush';\nimport type { Store } from '@annotorious/core';\nimport type { TextAnnotation, TextAnnotationTarget } from '../model';\nimport { isRevived, reviveSelector, mergeClientRects } from '../utils';\nimport type { AnnotationRects } from './TextAnnotationStore';\n\ninterface IndexedHighlightRect {\n\n  minX: number;\n\n  minY: number;\n\n  maxX: number;\n\n  maxY: number;\n\n  annotation: {\n    \n    id: string;\n\n    rects: DOMRect[];\n\n  }\n\n}\n\nexport const createSpatialTree = <T extends TextAnnotation>(store: Store<T>, container: HTMLElement) => {\n\n  const tree = new RBush<IndexedHighlightRect>();\n\n  const index = new Map<string, IndexedHighlightRect[]>();\n\n  // Helper: converts a single text annotation target to a list of hightlight rects\n  const toItems = (target: TextAnnotationTarget, offset: DOMRect): IndexedHighlightRect[] => {\n    const rects = target.selector.flatMap(s => {\n      const revivedRange = isRevived([s]) ? s.range : reviveSelector(s, container).range;\n      return Array.from(revivedRange.getClientRects());\n    });\n\n    const merged = mergeClientRects(rects)\n      // Offset the merged client rects so that coords\n      // are relative to the parent container\n      .map(({ left, top, right, bottom }) =>  \n        new DOMRect(left - offset.left, top - offset.top, right - left, bottom - top));\n\n    return merged.map(rect => {\n      const { x, y, width, height } = rect;\n\n      return {\n        minX: x,\n        minY: y,\n        maxX: x + width,\n        maxY: y + height,\n        annotation: {\n          id: target.annotation,\n          rects: merged\n        }\n      }\n    });\n  }\n\n  const all = () => [...index.values()];\n\n  const clear = () => {\n    tree.clear();\n    index.clear();\n  }\n\n  const insert = (target: TextAnnotationTarget) => {\n    const rects = toItems(target, container.getBoundingClientRect());\n    if (rects.length === 0) return;\n\n    rects.forEach(rect => tree.insert(rect));\n    index.set(target.annotation, rects);\n  }\n\n  const remove = (target: TextAnnotationTarget) => {\n    const rects = index.get(target.annotation);\n    if (rects) {\n      rects.forEach(rect => tree.remove(rect));\n      index.delete(target.annotation);\n    }\n  }\n\n  const update = (target: TextAnnotationTarget) => {\n    remove(target);\n    insert(target);\n  }\n\n  const set = (targets: TextAnnotationTarget[], replace: boolean = true) => {\n    if (replace)\n      clear();\n\n    const offset = container.getBoundingClientRect();\n\n    const rectsByTarget = targets.map(target => ({ target, rects: toItems(target, offset) }));\n    rectsByTarget.forEach(({ target, rects }) => {\n      if (rects.length > 0)\n        index.set(target.annotation, rects)\n    });\n\n    const allRects = rectsByTarget.flatMap(({ rects }) => rects);\n    tree.load(allRects);\n  }\n\n  const getAt = (x: number, y: number, all = false): string[] => {\n    const hits = tree.search({\n      minX: x,\n      minY: y,\n      maxX: x,\n      maxY: y\n    });\n\n    const area = (rect: IndexedHighlightRect) =>\n      rect.annotation.rects.reduce((area, r) =>\n        area + r.width * r.height, 0);\n    \n    // Get smallest rect\n    if (hits.length > 0) {\n      hits.sort((a, b) => area(a) - area(b));\n      return all ? hits.map(h => h.annotation.id) : [ hits[0].annotation.id ];\n    } else {\n      return [];\n    }\n  }\n\n  const getAnnotationBounds = (id: string): DOMRect => {\n    const rects = getAnnotationRects(id);\n\n    if (rects.length === 0)\n      return undefined;\n\n    let left = rects[0].left;\n    let top = rects[0].top;\n    let right = rects[0].right;\n    let bottom = rects[0].bottom;\n\n    for (let i = 1; i < rects.length; i++) {\n      const rect = rects[i];\n\n      left = Math.min(left, rect.left);\n      top = Math.min(top, rect.top);\n      right = Math.max(right, rect.right);\n      bottom = Math.max(bottom, rect.bottom);\n    }\n\n    return new DOMRect(left, top, right - left, bottom - top);\n  }\n\n  const getAnnotationRects = (id: string): DOMRect[] => {\n    const indexed = index.get(id);\n    if (indexed) {\n      // Reminder: *each* IndexedHighlightRect stores *all*\n      // DOMRects for the annotation for convenience\n      return indexed[0].annotation.rects;\n    } else {\n      return [];\n    }\n  }\n\n  const getIntersecting = (\n    minX: number, \n    minY: number, \n    maxX: number, \n    maxY: number,\n  ): AnnotationRects<T>[] => {\n    // All rects in this area, regardless of annotation\n    const rects = tree.search({ minX, minY, maxX, maxY });\n\n    // Distinct annotation IDs\n    const annotationIds = new Set(rects.map(rect => rect.annotation.id));\n\n    // Resolve annotation IDs. Note that the tree could be slightly out of sync (because \n    // it updates by listening to changes, just like anyone else)\n    return Array.from(annotationIds).map(annotationId => ({\n      annotation: store.getAnnotation(annotationId),\n      rects: getAnnotationRects(annotationId)\n    })).filter(t => Boolean(t.annotation));\n  }\n\n  const size = () => tree.all().length;\n\n  const recalculate = () =>\n    set(store.all().map(a => a.target), true);\n\n  return {\n    all,\n    clear,\n    getAt,\n    getAnnotationBounds,\n    getAnnotationRects,\n    getIntersecting,\n    insert,\n    recalculate,\n    remove,\n    set,\n    size,\n    update\n  }\n\n}\n","import type { Filter, Store, ViewportState, UserSelectActionExpression } from '@annotorious/core';\nimport { \n  createHoverState, \n  createSelectionState, \n  createStore, \n  Origin,\n  createViewportState\n} from '@annotorious/core';\nimport type { \n  AnnotatorState, \n  SelectionState, \n  HoverState, \n} from '@annotorious/core';\nimport { createSpatialTree } from './spatialTree';\nimport type { TextAnnotation, TextAnnotationTarget } from '../model';\nimport type { AnnotationRects, TextAnnotationStore } from './TextAnnotationStore';\nimport { isRevived, reviveAnnotation, reviveTarget } from '../utils';\n\nexport interface TextAnnotatorState<I extends TextAnnotation = TextAnnotation, E extends unknown = TextAnnotation> extends AnnotatorState<I, E> {\n\n  store: TextAnnotationStore<I>;\n\n  selection: SelectionState<I, E>;\n\n  hover: HoverState<I>;\n\n  viewport: ViewportState;\n\n}\n\nexport const createTextAnnotatorState = <I extends TextAnnotation = TextAnnotation, E extends unknown = TextAnnotation>(\n  container: HTMLElement,\n  defaultUserSelectAction?: UserSelectActionExpression<E>\n): TextAnnotatorState<I, E> => {\n\n  const store: Store<I> = createStore<I>();\n\n  const tree = createSpatialTree(store, container);\n\n  // Temporary\n  const selection = createSelectionState<I, E>(store)\n  selection.setUserSelectAction(defaultUserSelectAction);\n\n  const hover = createHoverState(store);\n\n  const viewport = createViewportState();\n\n  // Wrap store interface to intercept annotations and revive DOM ranges, if needed\n  const addAnnotation = (annotation: I, origin = Origin.LOCAL): boolean => {\n    const revived = reviveAnnotation(annotation, container);\n\n    const isValid = isRevived(revived.target.selector);\n    if (isValid)\n      store.addAnnotation(revived, origin); \n\n    return isValid;\n  }\n\n  const bulkAddAnnotation = (\n    annotations: I[], \n    replace = true, \n    origin = Origin.LOCAL\n  ): I[] => {\n    const revived = annotations.map(a => reviveAnnotation<I>(a, container));\n\n    // Initial page load might take some time. Retry for more robustness.\n    const couldNotRevive = revived.filter(a => !isRevived(a.target.selector));\n    store.bulkAddAnnotation(revived, replace, origin);\n\n    return couldNotRevive;\n  }\n  \n  const bulkUpsertAnnotations = (\n    annotations: I[], \n    origin = Origin.LOCAL\n  ): I[] => {\n    const revived = annotations.map(a => reviveAnnotation(a, container));\n\n    // Initial page load might take some time. Retry for more robustness.\n    const couldNotRevive = revived.filter(a => !isRevived(a.target.selector));\n    \n    revived.forEach(a => {\n      if (store.getAnnotation(a.id))\n        store.updateAnnotation(a, origin);\n      else \n        store.addAnnotation(a, origin);\n    })\n\n    return couldNotRevive;\n  }\n\n  const updateTarget = (target: TextAnnotationTarget, origin = Origin.LOCAL) => {\n    const revived = reviveTarget(target, container);\n    store.updateTarget(revived, origin);\n  }\n\n  const bulkUpdateTargets = (targets: TextAnnotationTarget[], origin = Origin.LOCAL) => {\n    const revived = targets.map(t => reviveTarget(t, container));\n    store.bulkUpdateTargets(revived, origin);\n  }\n\n  function getAt(x: number, y: number, all: true, filter?: Filter): I[] | undefined;\n  function getAt(x: number, y: number, all: false, filter?: Filter): I | undefined;\n  function getAt(x: number, y: number, all?: boolean, filter?: Filter): I | I[] | undefined {\n    const getAll = all || Boolean(filter);\n\n    const annotations = tree.getAt(x, y, getAll).map(id => store.getAnnotation(id));\n\n    const filtered = filter ? annotations.filter(filter) : annotations;\n\n    if (filtered.length === 0)\n      return undefined;\n\n    return all ? filtered : filtered[0];\n  }\n\n  const getAnnotationBounds = (id: string): DOMRect | undefined => {\n    const rects = tree.getAnnotationRects(id);\n    if (rects.length === 0) return;\n    return tree.getAnnotationBounds(id);\n  }\n\n  const getIntersecting = (\n    minX: number,\n    minY: number,\n    maxX: number,\n    maxY: number,\n  ): AnnotationRects<I>[] => tree.getIntersecting(minX, minY, maxX, maxY);\n\n  const getAnnotationRects = (id: string): DOMRect[] => tree.getAnnotationRects(id);\n\n  const recalculatePositions = () => tree.recalculate();\n\n  store.observe(({ changes }) => {\n    const deleted = (changes.deleted || []).filter(a => isRevived(a.target.selector));\n    const created = (changes.created || []).filter(a => isRevived(a.target.selector));\n    const updated = (changes.updated || []).filter(u => isRevived(u.newValue.target.selector));\n\n    if (deleted?.length > 0)\n      deleted.forEach(a => tree.remove(a.target));\n\n    if (created.length > 0)\n      tree.set(created.map(a => a.target), false);\n\n    if (updated?.length > 0)\n      updated.forEach(({ newValue }) => tree.update(newValue.target));\n  });\n\n  return {\n    store: {\n      ...store,\n      addAnnotation,\n      bulkAddAnnotation,\n      bulkUpdateTargets,\n      bulkUpsertAnnotations,\n      getAnnotationBounds,\n      getAnnotationRects,\n      getIntersecting,\n      getAt,\n      recalculatePositions,\n      updateTarget\n    },\n    selection,\n    hover,\n    viewport\n  }\n\n}\n","import type { Color, PresenceProvider, PresentUser } from '@annotorious/core';\nimport type { AnnotationRects } from '../state';\nimport type { HighlightStyle, HighlightPainter } from '../highlight';\nimport type { PresencePainterOptions } from '../presence';\nimport type { ViewportBounds } from '../highlight/viewport';\n\nimport './PresencePainter.css';\n\nconst createCanvas = () => {\n  const canvas = document.createElement('canvas');\n\n  // Retina resolution for crisp font rendering\n  canvas.width = 2 * window.innerWidth;\n  canvas.height = 2 * window.innerHeight;\n  canvas.className = 'r6o-presence-layer';\n\n  const context = canvas.getContext('2d');\n  context.scale(2, 2);\n  context.translate(0.5, 0.5);\n\n  return canvas;\n}\n\nexport const createPresencePainter = (\n  provider: PresenceProvider, \n  opts: PresencePainterOptions = {}\n): HighlightPainter => {\n\n  const canvas = createCanvas();\n\n  const ctx = canvas.getContext('2d');\n\n  document.body.appendChild(canvas);\n\n  const trackedAnnotations = new Map<string, PresentUser>();\n\n  const getAnnotationsForUser = (p: PresentUser) =>\n    Array.from(trackedAnnotations.entries())\n      .filter(([id, user]) => user.presenceKey === p.presenceKey)\n      .map(([id, _]) => id);\n\n  provider.on('selectionChange', (p: PresentUser, selection: string[] | null) => {\n    // Remove this user's previous selection\n    const currentIds = getAnnotationsForUser(p);\n    currentIds.forEach(id => trackedAnnotations.delete(id));\n\n    // Set new selection (if any)\n    if (selection)\n      selection.forEach(id => trackedAnnotations.set(id, p));\n  });  \n\n  const clear = () => {\n    const { width, height } = canvas;\n    ctx.clearRect(-0.5, -0.5, width + 1, height + 1);\n  }\n\n  const paint = (\n    highlight: AnnotationRects, \n    viewportBounds: ViewportBounds,\n    isSelected?: boolean\n  ): HighlightStyle | undefined => {\n    if (opts.font)\n      ctx.font = opts.font;\n\n    const user = trackedAnnotations.get(highlight.annotation.id);\n    if (user) {\n      // Draw cursor + label to the presence canvas\n      const { height } = highlight.rects[0];\n      const x = highlight.rects[0].x + viewportBounds.left;\n      const y = highlight.rects[0].y + viewportBounds.top;\n\n      // Draw presence indicator\n      ctx.fillStyle = user.appearance.color;\n      ctx.fillRect(x - 2, y - 2.5, 2, height + 5);\n\n      // Draw name label\n      const metrics = ctx.measureText(user.appearance.label);\n      const labelWidth = metrics.width + 6;\n      const labelHeight = metrics.actualBoundingBoxAscent + metrics.actualBoundingBoxDescent + 8;\n      \n      // Sigh... different between FF and Chrome\n      const paddingBottom = metrics.fontBoundingBoxAscent ? 8 : 6.5;\n\n      ctx.fillRect(x - 2, y - 2.5 - labelHeight, labelWidth, labelHeight);\n      \n      ctx.fillStyle = '#fff';\n      ctx.fillText(user.appearance.label, x + 1, y - paddingBottom);\n\n      // Return modfied style for the renderer\n      return { \n        fill: user.appearance.color as Color,\n        fillOpacity: isSelected ? 0.45 : 0.18\n      }\n    }\n  }\n  \n  const reset = () => {\n    canvas.width = 2 * window.innerWidth;\n    canvas.height = 2 * window.innerHeight;\n\n    // Note that resizing the canvas resets the context\n    const context = canvas.getContext('2d');\n    context.scale(2, 2);\n    context.translate(0.5, 0.5);\n  }\n\n  const destroy = () => {\n    canvas.remove();\n  }\n\n  return {\n    clear,\n    destroy,\n    paint,\n    reset\n  }\n  \n}\n","/**! \n * hotkeys-js v3.13.9 \n * A simple micro-library for defining and dispatching keyboard shortcuts. It has no dependencies. \n * \n * Copyright (c) 2024 kenny wong <wowohoo@qq.com> \n * https://github.com/jaywcjlove/hotkeys-js.git \n * \n * @website: https://jaywcjlove.github.io/hotkeys-js\n \n * Licensed under the MIT license \n */\n\nconst isff = typeof navigator !== 'undefined' ? navigator.userAgent.toLowerCase().indexOf('firefox') > 0 : false;\n\n// 绑定事件\nfunction addEvent(object, event, method, useCapture) {\n  if (object.addEventListener) {\n    object.addEventListener(event, method, useCapture);\n  } else if (object.attachEvent) {\n    object.attachEvent(\"on\".concat(event), method);\n  }\n}\nfunction removeEvent(object, event, method, useCapture) {\n  if (object.removeEventListener) {\n    object.removeEventListener(event, method, useCapture);\n  } else if (object.detachEvent) {\n    object.detachEvent(\"on\".concat(event), method);\n  }\n}\n\n// 修饰键转换成对应的键码\nfunction getMods(modifier, key) {\n  const mods = key.slice(0, key.length - 1);\n  for (let i = 0; i < mods.length; i++) mods[i] = modifier[mods[i].toLowerCase()];\n  return mods;\n}\n\n// 处理传的key字符串转换成数组\nfunction getKeys(key) {\n  if (typeof key !== 'string') key = '';\n  key = key.replace(/\\s/g, ''); // 匹配任何空白字符,包括空格、制表符、换页符等等\n  const keys = key.split(','); // 同时设置多个快捷键，以','分割\n  let index = keys.lastIndexOf('');\n\n  // 快捷键可能包含','，需特殊处理\n  for (; index >= 0;) {\n    keys[index - 1] += ',';\n    keys.splice(index, 1);\n    index = keys.lastIndexOf('');\n  }\n  return keys;\n}\n\n// 比较修饰键的数组\nfunction compareArray(a1, a2) {\n  const arr1 = a1.length >= a2.length ? a1 : a2;\n  const arr2 = a1.length >= a2.length ? a2 : a1;\n  let isIndex = true;\n  for (let i = 0; i < arr1.length; i++) {\n    if (arr2.indexOf(arr1[i]) === -1) isIndex = false;\n  }\n  return isIndex;\n}\n\n// Special Keys\nconst _keyMap = {\n  backspace: 8,\n  '⌫': 8,\n  tab: 9,\n  clear: 12,\n  enter: 13,\n  '↩': 13,\n  return: 13,\n  esc: 27,\n  escape: 27,\n  space: 32,\n  left: 37,\n  up: 38,\n  right: 39,\n  down: 40,\n  del: 46,\n  delete: 46,\n  ins: 45,\n  insert: 45,\n  home: 36,\n  end: 35,\n  pageup: 33,\n  pagedown: 34,\n  capslock: 20,\n  num_0: 96,\n  num_1: 97,\n  num_2: 98,\n  num_3: 99,\n  num_4: 100,\n  num_5: 101,\n  num_6: 102,\n  num_7: 103,\n  num_8: 104,\n  num_9: 105,\n  num_multiply: 106,\n  num_add: 107,\n  num_enter: 108,\n  num_subtract: 109,\n  num_decimal: 110,\n  num_divide: 111,\n  '⇪': 20,\n  ',': 188,\n  '.': 190,\n  '/': 191,\n  '`': 192,\n  '-': isff ? 173 : 189,\n  '=': isff ? 61 : 187,\n  ';': isff ? 59 : 186,\n  '\\'': 222,\n  '[': 219,\n  ']': 221,\n  '\\\\': 220\n};\n\n// Modifier Keys\nconst _modifier = {\n  // shiftKey\n  '⇧': 16,\n  shift: 16,\n  // altKey\n  '⌥': 18,\n  alt: 18,\n  option: 18,\n  // ctrlKey\n  '⌃': 17,\n  ctrl: 17,\n  control: 17,\n  // metaKey\n  '⌘': 91,\n  cmd: 91,\n  command: 91\n};\nconst modifierMap = {\n  16: 'shiftKey',\n  18: 'altKey',\n  17: 'ctrlKey',\n  91: 'metaKey',\n  shiftKey: 16,\n  ctrlKey: 17,\n  altKey: 18,\n  metaKey: 91\n};\nconst _mods = {\n  16: false,\n  18: false,\n  17: false,\n  91: false\n};\nconst _handlers = {};\n\n// F1~F12 special key\nfor (let k = 1; k < 20; k++) {\n  _keyMap[\"f\".concat(k)] = 111 + k;\n}\n\nlet _downKeys = []; // 记录摁下的绑定键\nlet winListendFocus = null; // window是否已经监听了focus事件\nlet _scope = 'all'; // 默认热键范围\nconst elementEventMap = new Map(); // 已绑定事件的节点记录\n\n// 返回键码\nconst code = x => _keyMap[x.toLowerCase()] || _modifier[x.toLowerCase()] || x.toUpperCase().charCodeAt(0);\nconst getKey = x => Object.keys(_keyMap).find(k => _keyMap[k] === x);\nconst getModifier = x => Object.keys(_modifier).find(k => _modifier[k] === x);\n\n// 设置获取当前范围（默认为'所有'）\nfunction setScope(scope) {\n  _scope = scope || 'all';\n}\n// 获取当前范围\nfunction getScope() {\n  return _scope || 'all';\n}\n// 获取摁下绑定键的键值\nfunction getPressedKeyCodes() {\n  return _downKeys.slice(0);\n}\nfunction getPressedKeyString() {\n  return _downKeys.map(c => getKey(c) || getModifier(c) || String.fromCharCode(c));\n}\nfunction getAllKeyCodes() {\n  const result = [];\n  Object.keys(_handlers).forEach(k => {\n    _handlers[k].forEach(_ref => {\n      let {\n        key,\n        scope,\n        mods,\n        shortcut\n      } = _ref;\n      result.push({\n        scope,\n        shortcut,\n        mods,\n        keys: key.split('+').map(v => code(v))\n      });\n    });\n  });\n  return result;\n}\n\n// 表单控件控件判断 返回 Boolean\n// hotkey is effective only when filter return true\nfunction filter(event) {\n  const target = event.target || event.srcElement;\n  const {\n    tagName\n  } = target;\n  let flag = true;\n  const isInput = tagName === 'INPUT' && !['checkbox', 'radio', 'range', 'button', 'file', 'reset', 'submit', 'color'].includes(target.type);\n  // ignore: isContentEditable === 'true', <input> and <textarea> when readOnly state is false, <select>\n  if (target.isContentEditable || (isInput || tagName === 'TEXTAREA' || tagName === 'SELECT') && !target.readOnly) {\n    flag = false;\n  }\n  return flag;\n}\n\n// 判断摁下的键是否为某个键，返回true或者false\nfunction isPressed(keyCode) {\n  if (typeof keyCode === 'string') {\n    keyCode = code(keyCode); // 转换成键码\n  }\n  return _downKeys.indexOf(keyCode) !== -1;\n}\n\n// 循环删除handlers中的所有 scope(范围)\nfunction deleteScope(scope, newScope) {\n  let handlers;\n  let i;\n\n  // 没有指定scope，获取scope\n  if (!scope) scope = getScope();\n  for (const key in _handlers) {\n    if (Object.prototype.hasOwnProperty.call(_handlers, key)) {\n      handlers = _handlers[key];\n      for (i = 0; i < handlers.length;) {\n        if (handlers[i].scope === scope) {\n          const deleteItems = handlers.splice(i, 1);\n          deleteItems.forEach(_ref2 => {\n            let {\n              element\n            } = _ref2;\n            return removeKeyEvent(element);\n          });\n        } else {\n          i++;\n        }\n      }\n    }\n  }\n\n  // 如果scope被删除，将scope重置为all\n  if (getScope() === scope) setScope(newScope || 'all');\n}\n\n// 清除修饰键\nfunction clearModifier(event) {\n  let key = event.keyCode || event.which || event.charCode;\n  const i = _downKeys.indexOf(key);\n\n  // 从列表中清除按压过的键\n  if (i >= 0) {\n    _downKeys.splice(i, 1);\n  }\n  // 特殊处理 cmmand 键，在 cmmand 组合快捷键 keyup 只执行一次的问题\n  if (event.key && event.key.toLowerCase() === 'meta') {\n    _downKeys.splice(0, _downKeys.length);\n  }\n\n  // 修饰键 shiftKey altKey ctrlKey (command||metaKey) 清除\n  if (key === 93 || key === 224) key = 91;\n  if (key in _mods) {\n    _mods[key] = false;\n\n    // 将修饰键重置为false\n    for (const k in _modifier) if (_modifier[k] === key) hotkeys[k] = false;\n  }\n}\nfunction unbind(keysInfo) {\n  // unbind(), unbind all keys\n  if (typeof keysInfo === 'undefined') {\n    Object.keys(_handlers).forEach(key => {\n      Array.isArray(_handlers[key]) && _handlers[key].forEach(info => eachUnbind(info));\n      delete _handlers[key];\n    });\n    removeKeyEvent(null);\n  } else if (Array.isArray(keysInfo)) {\n    // support like : unbind([{key: 'ctrl+a', scope: 's1'}, {key: 'ctrl-a', scope: 's2', splitKey: '-'}])\n    keysInfo.forEach(info => {\n      if (info.key) eachUnbind(info);\n    });\n  } else if (typeof keysInfo === 'object') {\n    // support like unbind({key: 'ctrl+a, ctrl+b', scope:'abc'})\n    if (keysInfo.key) eachUnbind(keysInfo);\n  } else if (typeof keysInfo === 'string') {\n    for (var _len = arguments.length, args = new Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {\n      args[_key - 1] = arguments[_key];\n    }\n    // support old method\n    // eslint-disable-line\n    let [scope, method] = args;\n    if (typeof scope === 'function') {\n      method = scope;\n      scope = '';\n    }\n    eachUnbind({\n      key: keysInfo,\n      scope,\n      method,\n      splitKey: '+'\n    });\n  }\n}\n\n// 解除绑定某个范围的快捷键\nconst eachUnbind = _ref3 => {\n  let {\n    key,\n    scope,\n    method,\n    splitKey = '+'\n  } = _ref3;\n  const multipleKeys = getKeys(key);\n  multipleKeys.forEach(originKey => {\n    const unbindKeys = originKey.split(splitKey);\n    const len = unbindKeys.length;\n    const lastKey = unbindKeys[len - 1];\n    const keyCode = lastKey === '*' ? '*' : code(lastKey);\n    if (!_handlers[keyCode]) return;\n    // 判断是否传入范围，没有就获取范围\n    if (!scope) scope = getScope();\n    const mods = len > 1 ? getMods(_modifier, unbindKeys) : [];\n    const unbindElements = [];\n    _handlers[keyCode] = _handlers[keyCode].filter(record => {\n      // 通过函数判断，是否解除绑定，函数相等直接返回\n      const isMatchingMethod = method ? record.method === method : true;\n      const isUnbind = isMatchingMethod && record.scope === scope && compareArray(record.mods, mods);\n      if (isUnbind) unbindElements.push(record.element);\n      return !isUnbind;\n    });\n    unbindElements.forEach(element => removeKeyEvent(element));\n  });\n};\n\n// 对监听对应快捷键的回调函数进行处理\nfunction eventHandler(event, handler, scope, element) {\n  if (handler.element !== element) {\n    return;\n  }\n  let modifiersMatch;\n\n  // 看它是否在当前范围\n  if (handler.scope === scope || handler.scope === 'all') {\n    // 检查是否匹配修饰符（如果有返回true）\n    modifiersMatch = handler.mods.length > 0;\n    for (const y in _mods) {\n      if (Object.prototype.hasOwnProperty.call(_mods, y)) {\n        if (!_mods[y] && handler.mods.indexOf(+y) > -1 || _mods[y] && handler.mods.indexOf(+y) === -1) {\n          modifiersMatch = false;\n        }\n      }\n    }\n\n    // 调用处理程序，如果是修饰键不做处理\n    if (handler.mods.length === 0 && !_mods[16] && !_mods[18] && !_mods[17] && !_mods[91] || modifiersMatch || handler.shortcut === '*') {\n      handler.keys = [];\n      handler.keys = handler.keys.concat(_downKeys);\n      if (handler.method(event, handler) === false) {\n        if (event.preventDefault) event.preventDefault();else event.returnValue = false;\n        if (event.stopPropagation) event.stopPropagation();\n        if (event.cancelBubble) event.cancelBubble = true;\n      }\n    }\n  }\n}\n\n// 处理keydown事件\nfunction dispatch(event, element) {\n  const asterisk = _handlers['*'];\n  let key = event.keyCode || event.which || event.charCode;\n\n  // 表单控件过滤 默认表单控件不触发快捷键\n  if (!hotkeys.filter.call(this, event)) return;\n\n  // Gecko(Firefox)的command键值224，在Webkit(Chrome)中保持一致\n  // Webkit左右 command 键值不一样\n  if (key === 93 || key === 224) key = 91;\n\n  /**\n   * Collect bound keys\n   * If an Input Method Editor is processing key input and the event is keydown, return 229.\n   * https://stackoverflow.com/questions/25043934/is-it-ok-to-ignore-keydown-events-with-keycode-229\n   * http://lists.w3.org/Archives/Public/www-dom/2010JulSep/att-0182/keyCode-spec.html\n   */\n  if (_downKeys.indexOf(key) === -1 && key !== 229) _downKeys.push(key);\n  /**\n   * Jest test cases are required.\n   * ===============================\n   */\n  ['metaKey', 'ctrlKey', 'altKey', 'shiftKey'].forEach(keyName => {\n    const keyNum = modifierMap[keyName];\n    if (event[keyName] && _downKeys.indexOf(keyNum) === -1) {\n      _downKeys.push(keyNum);\n    } else if (!event[keyName] && _downKeys.indexOf(keyNum) > -1) {\n      _downKeys.splice(_downKeys.indexOf(keyNum), 1);\n    } else if (keyName === 'metaKey' && event[keyName]) {\n      // 如果command被按下，那就清空所有除event按键外的非装饰键。\n      // 因为command被按下的情况下非装饰键的keyup永远都不会触发。这是已知的浏览器限制。\n      // If command key is pressed, clear all non-decorating keys except for key in event.\n      // This is because keyup for a non-decorating key will NEVER be triggered when command is pressed.\n      // This is a known browser limitation.\n      _downKeys = _downKeys.filter(k => k in modifierMap || k === key);\n    }\n  });\n  /**\n   * -------------------------------\n   */\n\n  if (key in _mods) {\n    _mods[key] = true;\n\n    // 将特殊字符的key注册到 hotkeys 上\n    for (const k in _modifier) {\n      if (_modifier[k] === key) hotkeys[k] = true;\n    }\n    if (!asterisk) return;\n  }\n\n  // 将 modifierMap 里面的修饰键绑定到 event 中\n  for (const e in _mods) {\n    if (Object.prototype.hasOwnProperty.call(_mods, e)) {\n      _mods[e] = event[modifierMap[e]];\n    }\n  }\n  /**\n   * https://github.com/jaywcjlove/hotkeys/pull/129\n   * This solves the issue in Firefox on Windows where hotkeys corresponding to special characters would not trigger.\n   * An example of this is ctrl+alt+m on a Swedish keyboard which is used to type μ.\n   * Browser support: https://caniuse.com/#feat=keyboardevent-getmodifierstate\n   */\n  if (event.getModifierState && !(event.altKey && !event.ctrlKey) && event.getModifierState('AltGraph')) {\n    if (_downKeys.indexOf(17) === -1) {\n      _downKeys.push(17);\n    }\n    if (_downKeys.indexOf(18) === -1) {\n      _downKeys.push(18);\n    }\n    _mods[17] = true;\n    _mods[18] = true;\n  }\n\n  // 获取范围 默认为 `all`\n  const scope = getScope();\n  // 对任何快捷键都需要做的处理\n  if (asterisk) {\n    for (let i = 0; i < asterisk.length; i++) {\n      if (asterisk[i].scope === scope && (event.type === 'keydown' && asterisk[i].keydown || event.type === 'keyup' && asterisk[i].keyup)) {\n        eventHandler(event, asterisk[i], scope, element);\n      }\n    }\n  }\n  // key 不在 _handlers 中返回\n  if (!(key in _handlers)) return;\n  const handlerKey = _handlers[key];\n  const keyLen = handlerKey.length;\n  for (let i = 0; i < keyLen; i++) {\n    if (event.type === 'keydown' && handlerKey[i].keydown || event.type === 'keyup' && handlerKey[i].keyup) {\n      if (handlerKey[i].key) {\n        const record = handlerKey[i];\n        const {\n          splitKey\n        } = record;\n        const keyShortcut = record.key.split(splitKey);\n        const _downKeysCurrent = []; // 记录当前按键键值\n        for (let a = 0; a < keyShortcut.length; a++) {\n          _downKeysCurrent.push(code(keyShortcut[a]));\n        }\n        if (_downKeysCurrent.sort().join('') === _downKeys.sort().join('')) {\n          // 找到处理内容\n          eventHandler(event, record, scope, element);\n        }\n      }\n    }\n  }\n}\nfunction hotkeys(key, option, method) {\n  _downKeys = [];\n  const keys = getKeys(key); // 需要处理的快捷键列表\n  let mods = [];\n  let scope = 'all'; // scope默认为all，所有范围都有效\n  let element = document; // 快捷键事件绑定节点\n  let i = 0;\n  let keyup = false;\n  let keydown = true;\n  let splitKey = '+';\n  let capture = false;\n  let single = false; // 单个callback\n\n  // 对为设定范围的判断\n  if (method === undefined && typeof option === 'function') {\n    method = option;\n  }\n  if (Object.prototype.toString.call(option) === '[object Object]') {\n    if (option.scope) scope = option.scope; // eslint-disable-line\n    if (option.element) element = option.element; // eslint-disable-line\n    if (option.keyup) keyup = option.keyup; // eslint-disable-line\n    if (option.keydown !== undefined) keydown = option.keydown; // eslint-disable-line\n    if (option.capture !== undefined) capture = option.capture; // eslint-disable-line\n    if (typeof option.splitKey === 'string') splitKey = option.splitKey; // eslint-disable-line\n    if (option.single === true) single = true; // eslint-disable-line\n  }\n  if (typeof option === 'string') scope = option;\n\n  // 如果只允许单个callback，先unbind\n  if (single) unbind(key, scope);\n\n  // 对于每个快捷键进行处理\n  for (; i < keys.length; i++) {\n    key = keys[i].split(splitKey); // 按键列表\n    mods = [];\n\n    // 如果是组合快捷键取得组合快捷键\n    if (key.length > 1) mods = getMods(_modifier, key);\n\n    // 将非修饰键转化为键码\n    key = key[key.length - 1];\n    key = key === '*' ? '*' : code(key); // *表示匹配所有快捷键\n\n    // 判断key是否在_handlers中，不在就赋一个空数组\n    if (!(key in _handlers)) _handlers[key] = [];\n    _handlers[key].push({\n      keyup,\n      keydown,\n      scope,\n      mods,\n      shortcut: keys[i],\n      method,\n      key: keys[i],\n      splitKey,\n      element\n    });\n  }\n  // 在全局document上设置快捷键\n  if (typeof element !== 'undefined' && window) {\n    if (!elementEventMap.has(element)) {\n      const keydownListener = function () {\n        let event = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : window.event;\n        return dispatch(event, element);\n      };\n      const keyupListenr = function () {\n        let event = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : window.event;\n        dispatch(event, element);\n        clearModifier(event);\n      };\n      elementEventMap.set(element, {\n        keydownListener,\n        keyupListenr,\n        capture\n      });\n      addEvent(element, 'keydown', keydownListener, capture);\n      addEvent(element, 'keyup', keyupListenr, capture);\n    }\n    if (!winListendFocus) {\n      const listener = () => {\n        _downKeys = [];\n      };\n      winListendFocus = {\n        listener,\n        capture\n      };\n      addEvent(window, 'focus', listener, capture);\n    }\n  }\n}\nfunction trigger(shortcut) {\n  let scope = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 'all';\n  Object.keys(_handlers).forEach(key => {\n    const dataList = _handlers[key].filter(item => item.scope === scope && item.shortcut === shortcut);\n    dataList.forEach(data => {\n      if (data && data.method) {\n        data.method();\n      }\n    });\n  });\n}\n\n// 销毁事件,unbind之后判断element上是否还有键盘快捷键，如果没有移除监听\nfunction removeKeyEvent(element) {\n  const values = Object.values(_handlers).flat();\n  const findindex = values.findIndex(_ref4 => {\n    let {\n      element: el\n    } = _ref4;\n    return el === element;\n  });\n  if (findindex < 0) {\n    const {\n      keydownListener,\n      keyupListenr,\n      capture\n    } = elementEventMap.get(element) || {};\n    if (keydownListener && keyupListenr) {\n      removeEvent(element, 'keyup', keyupListenr, capture);\n      removeEvent(element, 'keydown', keydownListener, capture);\n      elementEventMap.delete(element);\n    }\n  }\n  if (values.length <= 0 || elementEventMap.size <= 0) {\n    // 移除所有的元素上的监听\n    const eventKeys = Object.keys(elementEventMap);\n    eventKeys.forEach(el => {\n      const {\n        keydownListener,\n        keyupListenr,\n        capture\n      } = elementEventMap.get(el) || {};\n      if (keydownListener && keyupListenr) {\n        removeEvent(el, 'keyup', keyupListenr, capture);\n        removeEvent(el, 'keydown', keydownListener, capture);\n        elementEventMap.delete(el);\n      }\n    });\n    // 清空 elementEventMap\n    elementEventMap.clear();\n    // 清空 _handlers\n    Object.keys(_handlers).forEach(key => delete _handlers[key]);\n    // 移除window上的focus监听\n    if (winListendFocus) {\n      const {\n        listener,\n        capture\n      } = winListendFocus;\n      removeEvent(window, 'focus', listener, capture);\n      winListendFocus = null;\n    }\n  }\n}\nconst _api = {\n  getPressedKeyString,\n  setScope,\n  getScope,\n  deleteScope,\n  getPressedKeyCodes,\n  getAllKeyCodes,\n  isPressed,\n  filter,\n  trigger,\n  unbind,\n  keyMap: _keyMap,\n  modifier: _modifier,\n  modifierMap\n};\nfor (const a in _api) {\n  if (Object.prototype.hasOwnProperty.call(_api, a)) {\n    hotkeys[a] = _api[a];\n  }\n}\nif (typeof window !== 'undefined') {\n  const _hotkeys = window.hotkeys;\n  hotkeys.noConflict = deep => {\n    if (deep && window.hotkeys === hotkeys) {\n      window.hotkeys = _hotkeys;\n    }\n    return hotkeys;\n  };\n  window.hotkeys = hotkeys;\n}\n\nexport { hotkeys as default };\n","import { Origin } from '@annotorious/core';\nimport type { Filter, Selection, User } from '@annotorious/core';\nimport { v4 as uuidv4 } from 'uuid';\nimport hotkeys from 'hotkeys-js';\nimport type { TextAnnotatorState } from './state';\nimport type { TextAnnotation, TextAnnotationTarget } from './model';\nimport type { TextAnnotatorOptions } from './TextAnnotatorOptions';\nimport {\n  clonePointerEvent,\n  cloneKeyboardEvent,\n  debounce,\n  splitAnnotatableRanges,\n  rangeToSelector,\n  isMac,\n  isWhitespaceOrEmpty,\n  trimRangeToContainer,\n  isNotAnnotatable\n} from './utils';\n\nconst CLICK_TIMEOUT = 300;\n\nconst ARROW_KEYS = ['up', 'down', 'left', 'right'];\n\nconst SELECT_ALL = isMac ? '⌘+a' :  'ctrl+a';\n\nconst SELECTION_KEYS = [\n  ...ARROW_KEYS.map(key => `shift+${key}`),\n  SELECT_ALL\n];\n\nexport const SelectionHandler = (\n  container: HTMLElement,\n  state: TextAnnotatorState<TextAnnotation, unknown>,\n  options: TextAnnotatorOptions<TextAnnotation, unknown>\n) => {\n\n  let currentUser: User | undefined;\n\n  const { annotatingEnabled, offsetReferenceSelector, selectionMode } = options;\n\n  const setUser = (user?: User) => currentUser = user;\n\n  let currentFilter: Filter | undefined;\n\n  const setFilter = (filter?: Filter) => currentFilter = filter;\n\n  const { store, selection } = state;\n\n  let currentTarget: TextAnnotationTarget | undefined;\n\n  let isLeftClick: boolean | undefined;\n\n  let lastDownEvent: Selection['event'] | undefined;\n\n  const onSelectStart = (evt: Event) => {\n    if (isLeftClick === false)\n      return;\n\n    /**\n     * Make sure we don't listen to selection changes that were\n     * not started on the container, or which are not supposed to\n     * be annotatable (like a component popup).\n     * Note that Chrome/iOS will sometimes return the root doc as target!\n     */\n    currentTarget = isNotAnnotatable(evt.target as Node)\n      ? undefined\n      : {\n        annotation: uuidv4(),\n        selector: [],\n        creator: currentUser,\n        created: new Date()\n      };\n  };\n\n  const onSelectionChange = debounce((evt: Event) => {\n    const sel = document.getSelection();\n\n    /**\n     * In iOS when a user clicks on a button, the `selectionchange` event is fired.\n     * However, the generated selection is empty and the `anchorNode` is `null`.\n     * That doesn't give us information about whether the selection is in the annotatable area\n     * or whether the previously selected text was dismissed.\n     * Therefore - we should bail out from such a range processing.\n     *\n     * @see https://github.com/recogito/text-annotator-js/pull/164#issuecomment-2416961473\n     */\n    if (!sel?.anchorNode) {\n      return;\n    }\n\n    /**\n     * This is to handle cases where the selection is \"hijacked\"\n     * by another element in a not-annotatable area.\n     * A rare case in theory.\n     * But rich text editors will like Quill do it.\n     */\n    if (isNotAnnotatable(sel.anchorNode)) {\n      currentTarget = undefined;\n      return;\n    }\n\n    const timeDifference = evt.timeStamp - (lastDownEvent?.timeStamp || evt.timeStamp);\n\n    /**\n     * The selection start needs to be emulated only for the pointer events!\n     * The keyboard ones are consistently fired on desktops\n     * and the `timeDifference` will always be <10ms. between the `keydown` and `selectionchange`\n     */\n    if (lastDownEvent?.type === 'pointerdown') {\n      if (timeDifference < 1000 && !currentTarget) {\n\n        // Chrome/iOS does not reliably fire the 'selectstart' event!\n        onSelectStart(lastDownEvent || evt);\n      } else if (sel.isCollapsed && timeDifference < CLICK_TIMEOUT) {\n\n        // Firefox doesn't fire the 'selectstart' when user clicks\n        // over the text, which collapses the selection\n        onSelectStart(lastDownEvent || evt);\n      }\n    }\n\n    // The selection isn't active -> bail out from selection change processing\n    if (!currentTarget) return;\n\n    if (sel.isCollapsed) {\n      /**\n       * The selection range got collapsed during the selecting process.\n       * The previously created annotation isn't relevant anymore and can be discarded\n       *\n       * @see https://github.com/recogito/text-annotator-js/issues/139\n       */\n      if (store.getAnnotation(currentTarget.annotation)) {\n        selection.clear();\n        store.deleteAnnotation(currentTarget.annotation);\n      }\n\n      return;\n    }\n\n    const selectionRange = sel.getRangeAt(0);\n\n    // The selection should be captured only within the annotatable container\n    const containedRange = trimRangeToContainer(selectionRange, container);\n    if (isWhitespaceOrEmpty(containedRange)) return;\n\n    const annotatableRanges = splitAnnotatableRanges(containedRange.cloneRange());\n\n    const hasChanged =\n      annotatableRanges.length !== currentTarget.selector.length ||\n      annotatableRanges.some((r, i) => r.toString() !== currentTarget.selector[i]?.quote);\n    if (!hasChanged) return;\n\n    currentTarget = {\n      ...currentTarget,\n      selector: annotatableRanges.map(r => rangeToSelector(r, container, offsetReferenceSelector)),\n      updated: new Date()\n    };\n\n    /**\n     * During mouse selection on the desktop, the annotation won't usually exist while the selection is being edited.\n     * But it'll be typical during selection via the keyboard or mobile's handlebars.\n     */\n    if (store.getAnnotation(currentTarget.annotation)) {\n      store.updateTarget(currentTarget, Origin.LOCAL);\n    } else {\n      // Proper lifecycle management: clear the previous selection first...\n      selection.clear();\n    }\n  });\n\n  /**\n   * Select events don't carry information about the mouse button.\n   * Therefore, to prevent right-click selection, we need to listen\n   * to the initial pointerdown event and remember the button\n   */\n  const onPointerDown = (evt: PointerEvent) => {\n    if (isNotAnnotatable(evt.target as Node)) return;\n\n    /**\n     * Cloning the event to prevent it from accidentally being `undefined`\n     * @see https://github.com/recogito/text-annotator-js/commit/65d13f3108c429311cf8c2523f6babbbc946013d#r144033948\n     */\n    lastDownEvent = clonePointerEvent(evt);\n    isLeftClick = lastDownEvent.button === 0;\n  };\n\n  const onPointerUp = (evt: PointerEvent) => {\n    if (isNotAnnotatable(evt.target as Node) || !isLeftClick) return;\n\n    // Logic for selecting an existing annotation\n    const clickSelect = () => {\n      const { x, y } = container.getBoundingClientRect();\n\n      const hovered =\n        evt.target instanceof Node &&\n        container.contains(evt.target) &&\n        store.getAt(evt.clientX - x, evt.clientY - y, selectionMode === 'all', currentFilter);\n\n      if (hovered) {\n        const { selected } = selection;\n\n        const currentIds = new Set(selected.map(s => s.id));\n        const nextIds = Array.isArray(hovered) ? hovered.map(a => a.id) : [hovered.id];\n\n        const hasChanged =\n          currentIds.size !== nextIds.length ||\n          !nextIds.every(id => currentIds.has(id));\n\n        if (hasChanged)\n          selection.userSelect(nextIds, evt);\n      } else {\n        selection.clear();\n      }\n    };\n\n    const timeDifference = evt.timeStamp - lastDownEvent.timeStamp;\n\n    /**\n     * We must check the `isCollapsed` within the 0-timeout\n     * to handle the annotation dismissal after a click properly.\n     *\n     * Otherwise, the `isCollapsed` will return an obsolete `false` value,\n     * click won't be processed, and the annotation will get falsely re-selected.\n     *\n     * @see https://github.com/recogito/text-annotator-js/issues/136\n     */\n    setTimeout(() => {\n      const sel = document.getSelection();\n\n      // Just a click, not a selection\n      if (sel?.isCollapsed && timeDifference < CLICK_TIMEOUT) {\n        currentTarget = undefined;\n        clickSelect();\n      } else if (currentTarget && currentTarget.selector.length > 0) {\n        upsertCurrentTarget();\n        selection.userSelect(currentTarget.annotation, clonePointerEvent(evt));\n      }\n    });\n  }\n\n  const onContextMenu = (evt: PointerEvent) => {\n    const sel = document.getSelection();\n\n    if (sel?.isCollapsed) return;\n\n    // When selecting the initial word, Chrome Android fires `contextmenu` \n    // before selectionChanged.\n    if (!currentTarget || currentTarget.selector.length === 0) {\n      onSelectionChange(evt);\n    }\n    \n    upsertCurrentTarget();\n\n    selection.userSelect(currentTarget.annotation, clonePointerEvent(evt));\n  }\n\n  const onKeyup = (evt: KeyboardEvent) => {\n    if (evt.key === 'Shift' && currentTarget) {\n      const sel = document.getSelection();\n\n      if (!sel.isCollapsed) {\n        upsertCurrentTarget();\n        selection.userSelect(currentTarget.annotation, cloneKeyboardEvent(evt));\n      }\n    }\n  }\n\n  const onSelectAll = (evt: KeyboardEvent) => {\n\n    const onSelected = () => setTimeout(() => {\n      if (currentTarget?.selector.length > 0) {\n        selection.clear();\n\n        store.addAnnotation({\n          id: currentTarget.annotation,\n          bodies: [],\n          target: currentTarget\n        });\n\n        selection.userSelect(currentTarget.annotation, cloneKeyboardEvent(evt));\n      }\n\n      document.removeEventListener('selectionchange', onSelected);\n\n      // Sigh... this needs a delay to work. But doesn't seem reliable.\n    }, 100);\n\n    // Listen to the change event that follows\n    document.addEventListener('selectionchange', onSelected);\n\n    // Start selection!\n    onSelectStart(evt);\n  }\n\n  hotkeys(SELECTION_KEYS.join(','), { element: container, keydown: true, keyup: false }, evt => {\n    if (!evt.repeat)\n      lastDownEvent = cloneKeyboardEvent(evt);\n  });\n\n  hotkeys(SELECT_ALL, { keydown: true, keyup: false}, evt => {\n    lastDownEvent = cloneKeyboardEvent(evt);\n    onSelectAll(evt);\n  });\n\n  /**\n   * Free caret movement through the text resets the annotation selection.\n   *\n   * It should be handled only on:\n   * - the annotatable `container`, where the text is.\n   * - the `body`, where the focus goes when user closes the popup,\n   *   or clicks the button that gets unmounted, e.g. \"Close\"\n   */\n  const handleArrowKeyPress = (evt: KeyboardEvent) => {\n    if (\n      evt.repeat ||\n      evt.target !== container && evt.target !== document.body\n    ) {\n      return;\n    }\n\n    currentTarget = undefined;\n    selection.clear();\n  };\n\n  hotkeys(ARROW_KEYS.join(','), { keydown: true, keyup: false }, handleArrowKeyPress);\n\n  // Helper\n  const upsertCurrentTarget = () => {\n    const existingAnnotation = store.getAnnotation(currentTarget.annotation);\n    if (!existingAnnotation) {\n      store.addAnnotation({\n        id: currentTarget.annotation,\n        bodies: [],\n        target: currentTarget\n      });\n      return;\n    }\n\n    const { target: { updated: existingTargetUpdated } } = existingAnnotation;\n    const { updated: currentTargetUpdated } = currentTarget;\n    if (\n      !existingTargetUpdated ||\n      !currentTargetUpdated ||\n      existingTargetUpdated < currentTargetUpdated\n    ) {\n      store.updateTarget(currentTarget);\n    }\n  };\n\n  container.addEventListener('pointerdown', onPointerDown);\n  document.addEventListener('pointerup', onPointerUp);\n  document.addEventListener('contextmenu', onContextMenu);\n\n  if (annotatingEnabled) {\n    container.addEventListener('keyup', onKeyup);\n    container.addEventListener('selectstart', onSelectStart);\n    document.addEventListener('selectionchange', onSelectionChange);\n  }\n\n  const destroy = () => {\n    container.removeEventListener('pointerdown', onPointerDown);\n    document.removeEventListener('pointerup', onPointerUp);\n    document.removeEventListener('contextmenu', onContextMenu);\n\n    container.removeEventListener('keyup', onKeyup);\n    container.removeEventListener('selectstart', onSelectStart);\n    document.removeEventListener('selectionchange', onSelectionChange);\n\n    hotkeys.unbind();\n  };\n\n  return {\n    destroy,\n    setFilter,\n    setUser\n  }\n\n}\n\n","import type { FormatAdapter, UserSelectActionExpression, User, Annotation } from '@annotorious/core';\nimport type { PresencePainterOptions } from './presence';\nimport type { TextAnnotation } from './model';\nimport type { HighlightStyleExpression } from './highlight';\n\nexport interface TextAnnotatorOptions<I extends TextAnnotation = TextAnnotation, E extends unknown = TextAnnotation> {\n\n  adapter?: FormatAdapter<I, E> | null;\n\n  annotatingEnabled?: boolean;\n\n  renderer?: RendererType;\n\n  offsetReferenceSelector?: string;\n\n  userSelectAction?: UserSelectActionExpression<E>,\n\n  presence?: PresencePainterOptions;\n\n  selectionMode?: 'shortest' | 'all';\n\n  style?: HighlightStyleExpression;\n\n  user?: User;\n  \n}\n\nexport type RendererType = 'SPANS' | 'CANVAS' | 'CSS_HIGHLIGHTS';\n\nexport const fillDefaults = <I extends TextAnnotation = TextAnnotation, E extends unknown = TextAnnotation>(\n  opts: TextAnnotatorOptions<I, E>,\n  defaults: TextAnnotatorOptions<I, E>\n): TextAnnotatorOptions<I, E> => {\n\n  return {\n    ...opts,\n    annotatingEnabled: opts.annotatingEnabled ?? defaults.annotatingEnabled,\n    user: opts.user || defaults.user\n  };\n\n};\n","import { createAnonymousGuest, createLifecycleObserver, createBaseAnnotator, createUndoStack } from '@annotorious/core';\nimport type { Filter } from '@annotorious/core';\nimport type { Annotator, User, PresenceProvider } from '@annotorious/core';\nimport { createCanvasRenderer, createHighlightsRenderer, createSpansRenderer, type HighlightStyleExpression } from './highlight';\nimport { createPresencePainter } from './presence';\nimport { scrollIntoView } from './api';\nimport { type TextAnnotationStore, type TextAnnotatorState, createTextAnnotatorState } from './state';\nimport type { TextAnnotation } from './model';\nimport { cancelSingleClickEvents, programmaticallyFocusable } from './utils';\nimport { fillDefaults, type RendererType, type TextAnnotatorOptions } from './TextAnnotatorOptions';\nimport { SelectionHandler } from './SelectionHandler';\n\nimport './TextAnnotator.css';\n\nconst USE_DEFAULT_RENDERER: RendererType = 'SPANS';\n\nexport interface TextAnnotator<I extends TextAnnotation = TextAnnotation, E extends unknown = TextAnnotation> extends Annotator<I, E> {\n\n  element: HTMLElement;\n\n  setStyle(style: HighlightStyleExpression | undefined): void;\n\n  // Returns true if successful (or false if the annotation is not currently rendered)\n  scrollIntoView(annotationOrId: I | string): boolean;\n\n  state: TextAnnotatorState<I, E>;\n\n}\n\nexport const createTextAnnotator = <I extends TextAnnotation = TextAnnotation, E extends unknown = TextAnnotation>(\n  container: HTMLElement,\n  options: TextAnnotatorOptions<I, E> = {}\n): TextAnnotator<I, E> => {\n  // Prevent mobile browsers from triggering word selection on single click.\n  cancelSingleClickEvents(container);\n\n  // Make sure that the container is focusable and can receive both pointer and keyboard events\n  programmaticallyFocusable(container);\n\n  const opts = fillDefaults<I, E>(options, {\n    annotatingEnabled: true,\n    user: createAnonymousGuest()\n  });\n\n  const state: TextAnnotatorState<I, E> =\n    createTextAnnotatorState<I, E>(container, opts.userSelectAction);\n\n  const { selection, viewport } = state;\n\n  const store: TextAnnotationStore<I> = state.store;\n\n  const undoStack = createUndoStack<I>(store);\n\n  const lifecycle = createLifecycleObserver<I, E>(state, undoStack, opts.adapter);\n\n  let currentUser: User = opts.user;\n\n  // Use selected renderer, or fall back to default. If CSS_HIGHLIGHT is\n  // requested, check if CSS Custom Highlights are supported, and fall\n  // back to default renderer if not.\n  const useRenderer: RendererType =\n    opts.renderer === 'CSS_HIGHLIGHTS'\n      ? Boolean(CSS.highlights) ? 'CSS_HIGHLIGHTS' : USE_DEFAULT_RENDERER\n      : opts.renderer || USE_DEFAULT_RENDERER;\n\n  const highlightRenderer =\n    useRenderer === 'SPANS' ? createSpansRenderer(container, state, viewport) :\n    useRenderer === 'CSS_HIGHLIGHTS' ? createHighlightsRenderer(container, state, viewport) :\n    useRenderer === 'CANVAS' ? createCanvasRenderer(container, state, viewport) : undefined;\n\n  if (!highlightRenderer)\n    throw `Unknown renderer implementation: ${useRenderer}`;\n\n  console.debug(`Using ${useRenderer} renderer`);\n\n  if (opts.style)\n    highlightRenderer.setStyle(opts.style);\n\n  const selectionHandler = SelectionHandler(container, state, opts);\n  selectionHandler.setUser(currentUser);\n\n  /*************************/\n  /*      External API     */\n  /******++++++*************/\n\n  // Most of the external API functions are covered in the base annotator\n  const base = createBaseAnnotator<I, E>(state, undoStack, opts.adapter);\n\n  const getUser = () => currentUser;\n\n  const setFilter = (filter?: Filter<I>) => {\n    highlightRenderer.setFilter(filter);\n    selectionHandler.setFilter(filter);\n  }\n\n  const setStyle = (style: HighlightStyleExpression | undefined) =>\n    highlightRenderer.setStyle(style);\n\n  const setUser = (user: User) => {\n    currentUser = user;\n    selectionHandler.setUser(user);\n  }\n\n  const setPresenceProvider = (provider: PresenceProvider) => {\n    if (provider) {\n      highlightRenderer.setPainter(createPresencePainter(provider, opts.presence));\n      provider.on('selectionChange', () => highlightRenderer.redraw());\n    }\n  }\n\n  const setSelected = (arg?: string | string[]) => {\n    if (arg) {\n      selection.setSelected(arg);\n    } else {\n      selection.clear();\n    }\n  }\n\n  const setVisible = (visible: boolean) =>\n    highlightRenderer.setVisible(visible);\n\n  const destroy = () => {\n    highlightRenderer.destroy();\n    selectionHandler.destroy();\n\n    // Other cleanup actions\n    undoStack.destroy();\n  }\n\n  return {\n    ...base,\n    destroy,\n    element: container,\n    getUser,\n    setFilter,\n    setStyle,\n    setUser,\n    setSelected,\n    setPresenceProvider,\n    setVisible,\n    on: lifecycle.on,\n    off: lifecycle.off,\n    scrollIntoView: scrollIntoView(container, store),\n    state\n  }\n\n}\n"],"names":["NOT_ANNOTATABLE_CLASS","NOT_ANNOTATABLE_SELECTOR","isNotAnnotatable","node","_a","isRangeAnnotatable","range","ancestor","cancelSingleClickEvents","container","event","clonePointerEvent","cloneKeyboardEvent","isMac","programmaticallyFocusable","debounce","func","delay","timeoutId","args","iterateNotAnnotatableElements","notAnnotatableIterator","notAnnotatableNode","splitAnnotatableRanges","annotatableRanges","prevNotAnnotatable","notAnnotatable","subRange","lastRange","getRangeAnnotatableContents","contents","el","getQuoteContext","length","offsetReferenceSelector","offsetReference","rangeBefore","before","rangeAfter","after","isRevived","selector","s","whitespaceOrEmptyRegex","isWhitespaceOrEmpty","getRelation","rectA","rectB","round","num","a","b","union","left","right","top","bottom","mergeClientRects","rects","merged","next","wasMerged","relation","toDomRectList","index","i","rangeToSelector","quote","start","end","reviveSelector","iterator","runningOffset","n","startCounting","len","_b","reviveTarget","target","reviveAnnotation","annotation","trimRangeToContainer","trimmedRange","getScrollParent","overflowY","scrollIntoView","store","annotationOrId","id","scroll","parentBounds","scrollParent","parentHeight","parentWidth","annotationBounds","width","height","offsetTop","offsetLeft","scrollTop","scrollLeft","current","revived","DEFAULT_STYLE","DEFAULT_SELECTED_STYLE","paint","highlight","viewportBounds","style","painter","zIndex","base","getViewportBounds","innerWidth","innerHeight","minX","minY","maxX","maxY","trackViewport","viewport","visible","annotations","ids","createBaseRenderer","state","renderer","selection","hover","currentStyle","currentFilter","currentPainter","onDraw","onPointerMove","x","y","hit","redraw","lazy","bounds","annotationsInView","selectedIds","highlights","selected","hovered","setPainter","setStyle","setFilter","filter","onStoreChange","unsubscribeSelection","onScroll","onResize","resizeObserver","config","mutationObserver","records","record","createCanvas","canvas","resetCanvas","highres","createRenderer","ctx","highlightA","highlightB","createdA","createdB","h","offsetRects","underlineOffset","createCanvasRenderer","r","t","e","u","o","g","d","f","c","l","p","v","m","N","M","H","$","j","w","toCSS","colord","elem","currentRendered","nextRendered","updatedCSS","ranges","createHighlightsRenderer","has","dequal","foo","bar","ctor","computeZIndex","rect","all","intersects","getLength","total","intersecting","highlightLayer","shouldRedraw","span","createSpansRenderer","byteToHex","unsafeStringify","arr","offset","getRandomValues","rnds8","rng","native","v4","options","buf","rnds","k","V","X","A","Ue","Z","z","Se","C","D","U","W","E","T","R","F","_","K","ee","te","q","G","Y","De","ne","oe","se","ie","J","O","re","ae","ce","Oe","S","L","B","I","P","Q","le","Be","xe","Ie","ue","Ne","fe","pe","ge","he","me","Ve","Ae","be","_e","Ye","W3CTextFormat","source","serialized","parseW3CTextAnnotation","serializeW3CTextAnnotation","isTextSelector","parseW3CTextTargets","annotationId","creator","created","modified","w3cTargets","parsed","parseW3CUser","w3cTarget","w3cSelector","missingTypes","uuidv4","body","rest","bodies","parseW3CBodies","updated","targetRest","prefix","suffix","w3cSelectors","serializeW3CBodies","quickselect","compare","defaultCompare","sd","newLeft","newRight","swap","tmp","RBush","maxEntries","bbox","result","toBBox","nodesToSearch","child","childBBox","contains","data","tmpNode","item","createNode","equalsFn","path","indexes","parent","goingUp","findItem","items","calcBBox","N2","N1","multiSelect","right2","right3","level","minArea","minEnlargement","targetNode","area","bboxArea","enlargement","enlargedArea","isNode","insertPath","extend","splitIndex","newNode","minOverlap","bbox1","distBBox","bbox2","overlap","intersectionArea","compareMinX","compareNodeMinX","compareMinY","compareNodeMinY","xMargin","yMargin","leftBBox","rightBBox","margin","bboxMargin","siblings","destNode","children","stack","mid","createSpatialTree","tree","toItems","revivedRange","clear","insert","remove","update","set","targets","replace","rectsByTarget","allRects","getAt","hits","getAnnotationBounds","getAnnotationRects","indexed","annotationIds","createTextAnnotatorState","defaultUserSelectAction","createStore","createSelectionState","createHoverState","createViewportState","addAnnotation","origin","Origin","isValid","bulkAddAnnotation","couldNotRevive","bulkUpsertAnnotations","updateTarget","bulkUpdateTargets","getAll","filtered","getIntersecting","recalculatePositions","changes","deleted","newValue","context","createPresencePainter","provider","opts","trackedAnnotations","getAnnotationsForUser","user","isSelected","metrics","labelWidth","labelHeight","paddingBottom","isff","addEvent","object","method","useCapture","removeEvent","getMods","modifier","key","mods","getKeys","keys","compareArray","a1","a2","arr1","arr2","isIndex","_keyMap","_modifier","modifierMap","_mods","_handlers","_downKeys","winListendFocus","_scope","elementEventMap","code","getKey","getModifier","setScope","scope","getScope","getPressedKeyCodes","getPressedKeyString","getAllKeyCodes","_ref","shortcut","tagName","flag","isInput","isPressed","keyCode","deleteScope","newScope","handlers","_ref2","element","removeKeyEvent","clearModifier","hotkeys","unbind","keysInfo","info","eachUnbind","_len","_key","_ref3","splitKey","originKey","unbindKeys","lastKey","unbindElements","isUnbind","eventHandler","handler","modifiersMatch","dispatch","asterisk","keyName","keyNum","handlerKey","keyLen","keyShortcut","_downKeysCurrent","option","keyup","keydown","capture","single","keydownListener","keyupListenr","listener","trigger","values","_ref4","_api","_hotkeys","deep","CLICK_TIMEOUT","ARROW_KEYS","SELECT_ALL","SELECTION_KEYS","SelectionHandler","currentUser","annotatingEnabled","selectionMode","setUser","currentTarget","isLeftClick","lastDownEvent","onSelectStart","evt","onSelectionChange","sel","timeDifference","selectionRange","containedRange","onPointerDown","onPointerUp","clickSelect","currentIds","nextIds","upsertCurrentTarget","onContextMenu","onKeyup","onSelectAll","onSelected","handleArrowKeyPress","existingAnnotation","existingTargetUpdated","currentTargetUpdated","fillDefaults","defaults","USE_DEFAULT_RENDERER","createTextAnnotator","createAnonymousGuest","undoStack","createUndoStack","lifecycle","createLifecycleObserver","useRenderer","highlightRenderer","selectionHandler","createBaseAnnotator","arg"],"mappings":"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","x_google_ignoreList":[22,24,26,27,28,29,30,32,33,37]}
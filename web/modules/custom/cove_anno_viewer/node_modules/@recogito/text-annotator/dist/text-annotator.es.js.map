{"version":3,"file":"text-annotator.es.js","sources":["../src/utils/isNotAnnotatable.ts","../src/utils/cancelSingleClickEvents.ts","../src/utils/cloneEvents.ts","../src/utils/device.ts","../src/utils/programmaticallyFocusable.ts","../src/utils/debounce.ts","../src/utils/splitAnnotatableRanges.ts","../src/utils/getQuoteContext.ts","../src/utils/isRevived.ts","../src/utils/isWhitespaceOrEmpty.ts","../src/utils/mergeClientRects.ts","../src/utils/rangeToSelector.ts","../src/utils/reviveSelector.ts","../src/utils/reviveTarget.ts","../src/utils/reviveAnnotation.ts","../src/utils/trimRangeToContainer.ts","../src/api/scrollIntoView.ts","../src/highlight/HighlightStyle.ts","../src/highlight/HighlightPainter.ts","../src/highlight/viewport.ts","../src/highlight/baseRenderer.ts","../src/highlight/canvas/canvasRenderer.ts","../../../node_modules/colord/index.mjs","../src/highlight/highlights/highlightsRenderer.ts","../../../node_modules/dequal/lite/index.mjs","../src/highlight/span/spansRenderer.ts","../../../node_modules/uuid/dist/esm-browser/stringify.js","../../../node_modules/uuid/dist/esm-browser/rng.js","../../../node_modules/uuid/dist/esm-browser/native.js","../../../node_modules/uuid/dist/esm-browser/v4.js","../../../node_modules/@annotorious/core/dist/annotorious-core.es.js","../src/model/w3c/W3CTextFormatAdapter.ts","../../../node_modules/quickselect/index.js","../../../node_modules/rbush/index.js","../src/state/spatialTree.ts","../src/state/TextAnnotatorState.ts","../src/presence/PresencePainter.ts","../../../node_modules/hotkeys-js/dist/hotkeys.esm.js","../src/SelectionHandler.ts","../src/TextAnnotatorOptions.ts","../src/TextAnnotator.ts"],"sourcesContent":["export const NOT_ANNOTATABLE_CLASS = 'not-annotatable';\n\nexport const NOT_ANNOTATABLE_SELECTOR = `.${NOT_ANNOTATABLE_CLASS}`;\n\nexport const isNotAnnotatable = (node: Node): boolean => {\n  const closestNotAnnotatable = node instanceof HTMLElement\n    ? node.closest(NOT_ANNOTATABLE_SELECTOR)\n    : node.parentElement?.closest(NOT_ANNOTATABLE_SELECTOR);\n  return Boolean(closestNotAnnotatable);\n}\n\nexport const isRangeAnnotatable = (range: Range): boolean => {\n  const ancestor = range.commonAncestorContainer;\n  return !isNotAnnotatable(ancestor);\n}","import { NOT_ANNOTATABLE_SELECTOR } from './isNotAnnotatable';\n\n/**\n * Calls .preventDefault() on click events in annotable areas, in order\n * to prevent problematic default browser behavior. (Specifically: keep\n * Chrome Android from triggering word selection on single click.)\n */\nexport const cancelSingleClickEvents = (container: HTMLElement) =>\n  container.addEventListener('click', event => {\n    const targetElement = event.target as HTMLElement;\n\n    const shouldPrevent =\n      // Allow clicks within not-annotatable elements\n      !targetElement.closest(NOT_ANNOTATABLE_SELECTOR)\n      // Allow clicks on links\n      && !(event.target as Element).closest('a');\n\n    if (shouldPrevent)\n      event.preventDefault();\n  });\n","/**\n * Events need to be manually mapped into new objects:\n * 1. It preserves the `target` and `currentTarget` properties.\n *    Otherwise, they will be `null` when the event is read beyond the handler.\n * 2. Spread operator can copy only own enumerable properties, not inherited ones.\n *    Therefore, we need to manually copy the props we're interested in.\n * @see https://developer.mozilla.org/en-US/docs/Web/API/Event/currentTarget\n * @see https://github.com/recogito/text-annotator-js/commit/65d13f3108c429311cf8c2523f6babbbc946013d#r144041390\n */\n\nexport const clonePointerEvent = (event: PointerEvent): PointerEvent => ({\n  ...event,\n  type: event.type,\n  x: event.x,\n  y: event.y,\n  clientX: event.clientX,\n  clientY: event.clientY,\n  offsetX: event.offsetX,\n  offsetY: event.offsetY,\n  screenX: event.screenX,\n  screenY: event.screenY,\n  isPrimary: event.isPrimary,\n  altKey: event.altKey,\n  ctrlKey: event.ctrlKey,\n  metaKey: event.metaKey,\n  shiftKey: event.shiftKey,\n  button: event.button,\n  buttons: event.buttons,\n  currentTarget: event.currentTarget,\n  target: event.target,\n  defaultPrevented: event.defaultPrevented,\n  detail: event.detail,\n  eventPhase: event.eventPhase,\n  pointerId: event.pointerId,\n  pointerType: event.pointerType,\n  timeStamp: event.timeStamp\n})\n\nexport const cloneKeyboardEvent = (event: KeyboardEvent): KeyboardEvent => ({\n  ...event,\n  type: event.type,\n  key: event.key,\n  code: event.code,\n  location: event.location,\n  repeat: event.repeat,\n  altKey: event.altKey,\n  ctrlKey: event.ctrlKey,\n  metaKey: event.metaKey,\n  shiftKey: event.shiftKey,\n  currentTarget: event.currentTarget,\n  target: event.target,\n  defaultPrevented: event.defaultPrevented,\n  detail: event.detail,\n  timeStamp: event.timeStamp\n})\n","// @ts-ignore\nexport const isMac = /mac/i.test(navigator.userAgentData ? navigator.userAgentData.platform : navigator.platform);\n","/**\n * Makes an element programmatically focusable by adding a `tabindex=\"-1\"` attribute.\n * Or does nothing if the element is already focusable 🤷🏻\n * It's required to process keyboard events on an element that is not natively focusable.\n */\nexport const programmaticallyFocusable = (container: HTMLElement) => {\n  if (!container.hasAttribute('tabindex') && container.tabIndex < 0) {\n    container.setAttribute('tabindex', '-1');\n  }\n\n  container.classList.add('no-focus-outline');\n};\n","export const debounce = <T extends (...args: any[]) => void>(func: T, delay = 10): T => {\n\tlet timeoutId: ReturnType<typeof setTimeout>;\n\n\treturn ((...args: any[]) => {\n\t\tclearTimeout(timeoutId);\n\t\ttimeoutId = setTimeout(() => func.apply(this, args), delay);\n\t}) as T;\n}\n","import { isRangeAnnotatable, NOT_ANNOTATABLE_CLASS, NOT_ANNOTATABLE_SELECTOR } from './isNotAnnotatable';\n\nconst iterateNotAnnotatableElements = function*(range: Range): Generator<HTMLElement> {\n  const notAnnotatableIterator = document.createNodeIterator(\n    range.commonAncestorContainer,\n    NodeFilter.SHOW_ELEMENT,\n    (node) =>\n      node instanceof HTMLElement // Only elements that can have the class applied\n      && node.classList.contains(NOT_ANNOTATABLE_CLASS) // Only elements that are not annotatable\n      && !node.parentElement.closest(NOT_ANNOTATABLE_SELECTOR) // Only elements that are not descendants of a not annotatable element\n      && range.intersectsNode(node) // Only elements that are within the range\n        ? NodeFilter.FILTER_ACCEPT\n        : NodeFilter.FILTER_SKIP\n  );\n\n  let notAnnotatableNode: Node | null;\n\n  while ((notAnnotatableNode = notAnnotatableIterator.nextNode())) {\n    if (notAnnotatableNode instanceof HTMLElement) {\n      yield notAnnotatableNode;\n    }\n  }\n}\n\n/**\n * Splits a DOM Range into one or more ranges that span annotatable content only.\n */\nexport const splitAnnotatableRanges = (range: Range): Range[] => {\n  if (!isRangeAnnotatable(range)) return [];\n\n  const annotatableRanges: Range[] = [];\n\n  let prevNotAnnotatable: HTMLElement | null = null;\n\n  for (const notAnnotatable of iterateNotAnnotatableElements(range)) {\n    let subRange: Range;\n\n    // From the start of the range to the not annotatable element.\n    // If selection starts on the non-annotatable element, a collapsed range will be created and ignored.\n    if (!prevNotAnnotatable) {\n      subRange = range.cloneRange();\n      subRange.setEndBefore(notAnnotatable);\n    } else {\n      // From the previous not annotatable element to the current not annotatable element\n      subRange = document.createRange();\n      subRange.setStartAfter(prevNotAnnotatable);\n      subRange.setEndBefore(notAnnotatable);\n    }\n\n    if (!subRange.collapsed)\n      annotatableRanges.push(subRange);\n\n    prevNotAnnotatable = notAnnotatable;\n  }\n\n  // From the last not annotatable element to the end of the parent range\n  if (prevNotAnnotatable) {\n    const lastRange = range.cloneRange();\n    lastRange.setStartAfter(prevNotAnnotatable);\n    if (!lastRange.collapsed) {\n      annotatableRanges.push(lastRange);\n    }\n  }\n\n  return annotatableRanges.length > 0 ? annotatableRanges : [range];\n}\n\nexport const getRangeAnnotatableContents = (range: Range): DocumentFragment => {\n  const contents = range.cloneContents();\n  contents.querySelectorAll(NOT_ANNOTATABLE_SELECTOR).forEach((el) => el.remove());\n  return contents;\n}\n","import { getRangeAnnotatableContents } from './splitAnnotatableRanges';\n\nexport const getQuoteContext = (\n  range: Range, \n  container: HTMLElement, \n  length = 10,\n  offsetReferenceSelector?: string\n) => {\n  const offsetReference: HTMLElement = offsetReferenceSelector\n    ? (range.startContainer.parentElement as HTMLElement).closest(offsetReferenceSelector)!\n    : container;\n\n  const rangeBefore = document.createRange();\n  rangeBefore.setStart(offsetReference, 0);\n  rangeBefore.setEnd(range.startContainer, range.startOffset);\n\n  const before = getRangeAnnotatableContents(rangeBefore).textContent;\n  \n  const rangeAfter = document.createRange();\n  rangeAfter.setStart(range.endContainer, range.endOffset);\n\n  if (offsetReference === document.body)\n    rangeAfter.setEnd(offsetReference, offsetReference.childNodes.length);\n  else\n    rangeAfter.setEndAfter(offsetReference);\n\n  const after = getRangeAnnotatableContents(rangeAfter).textContent;\n\n  return {\n    prefix: before.substring(before.length - length),\n    suffix: after.substring(0, length)\n  }\n}\n","import type { TextSelector } from '../model';\n\nexport const isRevived = (selector: TextSelector[]) =>\n  selector.every(s => s.range instanceof Range && !s.range.collapsed);\n","export const whitespaceOrEmptyRegex = /^\\s*$/;\n\nexport const isWhitespaceOrEmpty = (range: Range): boolean => whitespaceOrEmptyRegex.test(range.toString())\n","// The three topological relations we need to check for\ntype Relation = \n  // Inline elements, same height, directly adjacent\n  'inline-adjacent' |\n  // Inline elements, A fully contains B\n  'inline-contains' |\n  // Inline elements, A is fully contained inside B\n  'inline-is-contained' |\n  // At least one block element, A fully contains B\n  'block-contains' |\n  // At least one block element, A is fully contained in B\n  'block-is-contained';\n\n// Note that this is not a general topology test. Takes a \n// few shortcuts to test ONLY the situations we'll encounter\n// with text selections.\nconst getRelation = (rectA: DOMRect, rectB: DOMRect): Relation | undefined => {\n  const round = (num: number ) => Math.round(num * 10) / 10;\n\n  // Some browsers have fractional pixel differences (looking at you FF!)\n  const a = {\n    top: round(rectA.top),\n    bottom: round(rectA.bottom),\n    left: round(rectA.left),\n    right: round(rectA.right)\n  };\n\n  const b = {\n    top: round(rectB.top),\n    bottom: round(rectB.bottom),\n    left: round(rectB.left),\n    right: round(rectB.right)\n  };\n\n  if (Math.abs(a.top - b.top) < 0.5 && Math.abs(a.bottom - b.bottom) < 0.5) {\n    // Same height - check for containment and adjacency\n    if (Math.abs(a.left - b.right) < 0.5 || Math.abs(a.right - b.left) < 0.5)\n      return 'inline-adjacent';\n\n    if (a.left >= b.left && a.right <= b.right)\n      return 'inline-is-contained';\n\n    if (a.left <= b.left && a.right >= b.right)\n      return 'inline-contains';\n  } else {\n    // Different heights - check for containment\n    if (a.top <= b.top && a.bottom >= b.bottom) {\n      if (a.left <= b.left && a.right >= b.right) {\n        return 'block-contains'\n      }\n    } else if (a.top >= b.top && a.bottom <= b.bottom) {\n      if (a.left >= b.left && a.right <= b.right) {\n        return 'block-is-contained';\n      }\n    }\n  }\n}\n\nconst union = (a: DOMRect, b: DOMRect): DOMRect => {\n  const left = Math.min(a.left, b.left);\n  const right = Math.max(a.right, b.right);\n  const top = Math.min(a.top, b.top);\n  const bottom = Math.max(a.bottom, b.bottom);\n\n  return new DOMRect(left, top, right - left, bottom - top);\n}\n\nexport const mergeClientRects = (rects: DOMRect[]) => rects.reduce<DOMRect[]>((merged, rectA) => {\n  // Some browser report empty rects - discard\n  if (rectA.width === 0 || rectA.height === 0)\n    return merged;\n\n  let next = [...merged];\n\n  let wasMerged = false;\n\n  for (const rectB of merged) {\n    const relation = getRelation(rectA, rectB);\n    \n    if (relation === 'inline-adjacent') {\n      // A and B are adjacent - remove B and keep union\n      next = next.map(r => r === rectB ? union(rectA, rectB) : r);\n      wasMerged = true;\n      break;\n    } else if (relation === 'inline-contains') {\n      // A contains B - remove B and keep A\n      next = next.map(r => r === rectB ? rectA : r);\n      wasMerged = true;\n      break;\n    } else if (relation === 'inline-is-contained') {\n      // B contains A - skip A\n      wasMerged = true;\n      break;\n    } else if (relation === 'block-contains' || relation === 'block-is-contained') {\n      // Block containment - keep the element with smaller width\n      if (rectA.width < rectB.width) {\n        next = next.map(r => r === rectB ? rectA : r);\n      }\n      wasMerged = true;\n      break;\n    }\n  }\n\n  return wasMerged ? next : [ ...next, rectA ];\n}, []);\n\nexport const toDomRectList = (rects: DOMRect[]): DOMRectList => ({\n  length: rects.length,\n  item: (index) => rects[index],\n  [Symbol.iterator]: function* (): ArrayIterator<DOMRect> {\n    for (let i = 0; i < this.length; i++)\n      yield this.item(i)!;\n  }\n})\n\n/* Pixels that rects can be apart vertically while still\n// being considered to be on the same line.\nconst TOLERANCE = 3;\n\nexport const mergeClientRects = (rects: DOMRect[]) => {\n  const lines: DOMRect[][] = [];\n\n  // Sort rects from the top, to make grouping simpler\n  rects.sort((a, b) => a.top - b.top);\n\n  // Group rects into lines\n  for (const rect of rects) {\n    if (lines.length === 0 || Math.abs(rect.top - lines[lines.length - 1][0].top) > TOLERANCE) {\n      // Start a new line\n      lines.push([rect]);\n    } else {\n      lines[lines.length - 1].push(rect);\n    }\n  }\n\n  // Merge lines\n  const mergedRects = lines.map(line => {\n    const top = Math.min(...line.map(r => r.top));\n    const bottom = Math.max(...line.map(r => r.bottom));\n    const left = Math.min(...line.map(r => r.left));\n    const right = Math.max(...line.map(r => r.right));\n\n    return {\n      top: top,\n      bottom: bottom,\n      left: left,\n      right: right,\n      height: bottom - top,\n      width: right - left\n    } as DOMRect;\n  }).filter(r => r.height > 0 && r.width > 0);\n\n  // Checks if the given rect contains any other rects\n  const containsOthers = (rect: DOMRect) => mergedRects.some(other =>\n    other !== rect &&\n    other.left >= rect.left &&\n    other.right <= rect.right &&\n    other.top >= rect.top &&\n    other.bottom <= rect.bottom\n  );\n\n  // Remove all rects that contain other rects (block-level elements!)\n  return mergedRects.filter(rect => !containsOthers(rect));\n}\n*/\n","import { getRangeAnnotatableContents } from './splitAnnotatableRanges';\nimport type { TextSelector } from '../model';\n\nexport const rangeToSelector = (\n  range: Range,\n  container: HTMLElement,\n  offsetReferenceSelector?: string\n): TextSelector => {\n  const rangeBefore = document.createRange();\n\n  const offsetReference: HTMLElement = offsetReferenceSelector\n    ? (range.startContainer.parentElement as HTMLElement).closest(offsetReferenceSelector)!\n    : container;\n\n  // A helper range from the start of the container to the start of the selection\n  rangeBefore.setStart(offsetReference, 0);\n  rangeBefore.setEnd(range.startContainer, range.startOffset);\n\n  // A content range before content w/o not annotatable elements\n  const before = getRangeAnnotatableContents(rangeBefore).textContent;\n\n  const quote = range.toString();\n  const start = before.length || 0;\n  const end = start + quote.length;\n\n  return offsetReferenceSelector\n    ? { quote, start, end, range, offsetReference }\n    : { quote, start, end, range };\n}\n","import type { TextSelector } from '../model';\nimport { NOT_ANNOTATABLE_SELECTOR } from './isNotAnnotatable';\n\n/**\n * Creates a new selector object with the revived DOM range from the given text annotation position\n * Only the annotatable elements are processed and counted towards the range\n *\n * @param selector annotation selector with start and end positions\n * @param container the HTML container of the annotated content\n *\n * @returns the revived selector\n */\nexport const reviveSelector = <T extends TextSelector>(selector: T, container: HTMLElement): T => {\n\n  const { start, end } = selector;\n\n  const offsetReference = selector.offsetReference || container;\n\n  const iterator = document.createNodeIterator(container, NodeFilter.SHOW_TEXT, (node) =>\n    node.parentElement?.closest(NOT_ANNOTATABLE_SELECTOR)\n      ? NodeFilter.FILTER_SKIP\n      : NodeFilter.FILTER_ACCEPT\n  );\n\n  // Position that contains the length of the preceding annotatable text nodes\n  let runningOffset = 0;\n\n  const range = document.createRange();\n\n  let n = iterator.nextNode();\n  if (n === null) console.error('Could not revive annotation target. Content missing.');\n\n  // If there's no offset reference, start immediately\n  let startCounting = !offsetReference;\n  while (n !== null) {\n    startCounting ||= offsetReference?.contains(n);\n\n    if (startCounting) {\n      const len = n.textContent?.length || 0;\n\n      if (runningOffset + len > start) {\n        range.setStart(n, start - runningOffset);\n        break;\n      }\n\n      runningOffset += len;\n    }\n\n    n = iterator.nextNode();\n  }\n\n  // set range end\n  while (n !== null) {\n    const len = n.textContent?.length || 0;\n\n    if (runningOffset + len >= end) {\n      range.setEnd(n, end - runningOffset);\n      break;\n    }\n\n    runningOffset += len;\n\n    n = iterator.nextNode();\n  }\n  \n  return {\n    ...selector,\n    range\n  }\n\n}\n","import type { TextAnnotationTarget } from '../model';\nimport { isRevived } from './isRevived';\nimport { reviveSelector } from './reviveSelector';\n\nexport const reviveTarget = <T extends TextAnnotationTarget = TextAnnotationTarget>(target: T, container: HTMLElement): T =>\n  isRevived(target.selector)\n    ? target\n    : ({\n      ...target,\n      selector: target.selector.map(s => s.range instanceof Range && !s.range.collapsed ? s : reviveSelector(s, container))\n    });\n\n\n","import type { TextAnnotation } from '../model';\nimport { isRevived } from './isRevived';\nimport { reviveTarget } from './reviveTarget';\n\nexport const reviveAnnotation = <T extends TextAnnotation>(annotation: T, container: HTMLElement): T =>\n  isRevived(annotation.target.selector)\n    ? annotation\n    : ({ ...annotation, target: reviveTarget(annotation.target, container) });","export const trimRangeToContainer = (\n  range: Range,\n  container: HTMLElement\n): Range => {\n  const trimmedRange = range.cloneRange();\n\n  // If the start is outside the container - set it to the start of the container\n  if (!container.contains(trimmedRange.startContainer)) {\n    trimmedRange.setStart(container, 0);\n  }\n\n  // If the end is outside the container - set it to the end of the container\n  if (!container.contains(trimmedRange.endContainer)) {\n    trimmedRange.setEnd(container, container.childNodes.length);\n  }\n\n  return trimmedRange;\n};\n","import type { TextAnnotationStore } from '../state';\nimport type { TextAnnotation, TextAnnotationTarget } from '../model';\nimport { reviveTarget } from '../utils';\n\nconst getScrollParent = (el: Element) => {\n  if (el === null)\n    return document.scrollingElement;\n\n  const { overflowY } = window.getComputedStyle(el);\n  const isScrollable = overflowY !== 'visible' && overflowY !== 'hidden';\n\n  // Cf. discussion https://stackoverflow.com/questions/35939886/find-first-scrollable-parent\n  if (isScrollable && el.scrollHeight > el.clientHeight)\n    return el;\n  else\n    return getScrollParent(el.parentElement);\n};\n\nexport const scrollIntoView = (\n  container: HTMLElement, store: TextAnnotationStore\n) => (annotationOrId: string | TextAnnotation) => {\n  const id = \n    typeof annotationOrId === 'string' ? annotationOrId : annotationOrId.id;\n\n  // Executes scroll on an annotation with a valid DOM range selector\n  const scroll = (target: TextAnnotationTarget) => {\n    // Parent bounds and client (= visible) height\n    const parentBounds = scrollParent.getBoundingClientRect();\n    const parentHeight = scrollParent.clientHeight;\n    const parentWidth = scrollParent.clientWidth;\n\n    // Position of the annotation relative to viewport\n    // Note: first selector is not necessarily top one...\n    const annotationBounds = target.selector[0].range.getBoundingClientRect();\n\n    // Note: getBoundingClientRect seems to return wrong height! \n    // (Includes block elements?) We'll therefore use the normalized height\n    // from the spatial index!\n    const { width, height } = store.getAnnotationBounds(id);\n\n    // Position of the annotation relative to scrollParent\n    const offsetTop = annotationBounds.top - parentBounds.top;\n    const offsetLeft = annotationBounds.left - parentBounds.left;\n\n    const scrollTop = scrollParent.parentElement ? scrollParent.scrollTop : 0;\n    const scrollLeft = scrollParent.parentElement ? scrollParent.scrollLeft : 0;\n\n    // Scroll the annotation to the center of the viewport\n    const top = offsetTop + scrollTop - (parentHeight - height) / 2;\n    const left = offsetLeft + scrollLeft - (parentWidth - width) / 2;\n\n    scrollParent.scroll({ top, left, behavior: 'smooth' });\n  };\n\n  // Get closest scrollable parent\n  const scrollParent: Element = getScrollParent(container);\n  if (scrollParent) {\n    // Get curren version of the annotation from the store\n    const current = store.getAnnotation(id);\n\n    // The 1st selector is the topmost one as well\n    const { range } = current.target.selector[0];\n    if (range && !range.collapsed) {\n      scroll(current.target);\n      return true;\n    } else {\n      // Try reviving to account for lazy rendering\n      const revived = reviveTarget(current.target, container);\n      const { range } = revived.selector[0];\n      if (range && !range.collapsed) {\n        scroll(revived);\n        return true;\n      }\n    }\n  }\n\n  return false;\n};\n","import type { AnnotationState, Color, DrawingStyle } from '@annotorious/core';\nimport type { TextAnnotation } from 'src/model';\n\nexport interface HighlightStyle extends Pick<DrawingStyle, 'fill' | 'fillOpacity'> {\n\n  underlineStyle?: string;\n\n  underlineColor?: Color;\n\n  underlineOffset?: number;\n\n  underlineThickness?: number;\n  \n}\n\nexport type HighlightStyleExpression = HighlightStyle \n  | (<I extends TextAnnotation = TextAnnotation>(annotation: I, state: AnnotationState, zIndex?: number) => HighlightStyle | undefined);\n\nexport const DEFAULT_STYLE: HighlightStyle = { \n  fill: 'rgb(0, 128, 255)', \n  fillOpacity: 0.18\n};\n\nexport const DEFAULT_SELECTED_STYLE: HighlightStyle = { \n  fill: 'rgb(0, 128, 255)', \n  fillOpacity: 0.45 \n};\n","\nimport type { Highlight } from './Highlight';\nimport { DEFAULT_SELECTED_STYLE, DEFAULT_STYLE } from './HighlightStyle';\nimport type { HighlightStyle, HighlightStyleExpression } from './HighlightStyle';\nimport type { ViewportBounds } from './viewport';\n\nexport interface HighlightPainter {\n\n  clear(): void;\n\n  destroy(): void;\n\n  paint(highlight: Highlight, viewportBounds: ViewportBounds): HighlightStyle;\n\n  reset(): void;\n\n}\n\n/** Helper **/\nexport const paint = (\n  highlight: Highlight,\n  viewportBounds: ViewportBounds,\n  style?: HighlightStyleExpression, \n  painter?: HighlightPainter,\n  zIndex?: number\n) => {\n  const base: HighlightStyle = style \n    ? typeof style === 'function' \n      ? style(highlight.annotation, highlight.state, zIndex) || (\n        highlight.state?.selected ? DEFAULT_SELECTED_STYLE : DEFAULT_STYLE\n      )\n      : style \n    : highlight.state?.selected \n      ? DEFAULT_SELECTED_STYLE \n      : DEFAULT_STYLE;\n\n  // Trigger the custom painter (if any) as a side-effect\n  return painter ? painter.paint(highlight, viewportBounds) || base : base;\n}","import type { ViewportState } from '@annotorious/core';\nimport type { TextAnnotation } from '../model';\n\nexport interface ViewportBounds {\n\n  top: number;\n\n  left: number;\n\n  minX: number;\n\n  minY: number;\n  \n  maxX: number;\n  \n  maxY: number;\n\n}\n\nexport const getViewportBounds = (container: HTMLElement): ViewportBounds => {\n  const { top, left } = container.getBoundingClientRect();\n\n  const { innerWidth, innerHeight } = window;\n\n  const minX = - left;\n  const minY = - top;\n  const maxX = innerWidth - left;\n  const maxY = innerHeight - top;\n\n  return { top, left, minX, minY, maxX, maxY };\n}\n\nexport const trackViewport = (viewport: ViewportState) => {\n  let visible = new Set<string>();\n\n  const onDraw = (annotations: TextAnnotation[]) => {\n    const ids = annotations.map(a => a.id);\n\n    if (visible.size !== ids.length || ids.some(id => !visible.has(id))) {\n      viewport.set(ids);\n    } \n\n    visible = new Set(ids);\n  }\n\n  return onDraw;\n\n}","import type { Filter, ViewportState } from '@annotorious/core';\nimport type { TextAnnotatorState } from '../state';\nimport { debounce } from '../utils';\nimport { type ViewportBounds, getViewportBounds, trackViewport } from './viewport';\nimport type { HighlightPainter } from './HighlightPainter';\nimport type { Highlight } from './Highlight';\nimport type { HighlightStyleExpression } from './HighlightStyle';\n\nexport interface RendererImplementation {\n\n  destroy(): void;\n\n  redraw(\n\n    highlights:Highlight[], \n\n    bounds: ViewportBounds, \n    \n    style?: HighlightStyleExpression,\n\n    painter?: HighlightPainter,\n\n    lazy?: boolean\n  \n  ): void;\n\n  setVisible(visible: boolean): void;\n\n}\n\nexport interface Renderer {\n\n  destroy(): void;\n\n  redraw(force?: boolean): void;\n\n  setStyle(style?: HighlightStyleExpression): void;\n\n  setFilter(filter?: Filter): void;\n\n  setPainter(painter?: HighlightPainter): void;\n\n  setVisible(visible: boolean): void;\n\n}\n\nexport const createBaseRenderer = <T extends TextAnnotatorState = TextAnnotatorState> (\n  container: HTMLElement, \n  state: T,\n  viewport: ViewportState,\n  renderer: RendererImplementation\n): Renderer => {\n  const { store, selection, hover } = state;\n\n  let currentStyle: HighlightStyleExpression | undefined;\n\n  let currentFilter: Filter | undefined;\n\n  let currentPainter: HighlightPainter;\n\n  const onDraw = trackViewport(viewport);\n\n  const onPointerMove = (event: PointerEvent) => {\n    const {x, y} = container.getBoundingClientRect();\n\n    const hit = store.getAt(event.clientX - x, event.clientY - y, false, currentFilter);\n    if (hit) {\n      if (hover.current !== hit.id) {\n        container.classList.add('hovered');\n        hover.set(hit.id);\n      }\n    } else {\n      if (hover.current) {\n        container.classList.remove('hovered');\n        hover.set(null);\n      }\n    }\n  }\n\n  container.addEventListener('pointermove', onPointerMove);\n\n  const redraw = (lazy: boolean = false) => {\n    if (currentPainter)\n      currentPainter.clear();\n\n    const bounds = getViewportBounds(container);   \n\n    const { minX, minY, maxX, maxY } = bounds;\n    \n    const annotationsInView = currentFilter\n      ? store.getIntersecting(minX, minY, maxX, maxY).filter(({ annotation }) => currentFilter(annotation))\n      : store.getIntersecting(minX, minY, maxX, maxY);\n\n    const selectedIds = selection.selected.map(({ id }) => id);\n\n    const highlights: Highlight[] = annotationsInView.map(({ annotation, rects }) => {\n      const selected = selectedIds.includes(annotation.id);\n      const hovered = annotation.id === hover.current;\n\n      return { annotation, rects, state: { selected, hover: hovered }};\n    });\n\n    renderer.redraw(highlights, bounds, currentStyle, currentPainter, lazy);\n\n    setTimeout(() => onDraw(annotationsInView.map(({ annotation }) => annotation)), 1);\n  }\n\n  const setPainter = (painter: HighlightPainter) => { \n    currentPainter = painter;\n    redraw();\n  }\n\n  const setStyle = (style?: HighlightStyleExpression) => {\n    currentStyle = style;\n    redraw();\n  }\n\n  const setFilter = (filter?: Filter) => {\n    currentFilter = filter;\n    redraw(false);\n  } \n\n  // Refresh on store change\n  const onStoreChange = () => redraw();\n  store.observe(onStoreChange);\n\n  // Refresh on selection change\n  const unsubscribeSelection = selection.subscribe(() => redraw());\n\n  // Refresh on scroll\n  const onScroll = () => redraw(true);\n  document.addEventListener('scroll', onScroll, { capture: true, passive: true });\n\n  // Refresh on resize\n  const onResize = debounce(() => {\n    store.recalculatePositions();\n\n    if (currentPainter)\n      currentPainter.reset();\n\n    redraw();\n  });\n\n  window.addEventListener('resize', onResize);\n\n  const resizeObserver = new ResizeObserver(onResize);\n  resizeObserver.observe(container);\n\n  // This is an extra precaution. The position of the container\n  // might shift (without resizing) due to layout changes higher-up\n  // in the DOM. (This happens in Recogito for example)\n  const config: MutationObserverInit = { attributes: true, childList: true, subtree: true };\n\n  const mutationObserver = new MutationObserver((records: MutationRecord[]) => {\n    const isInternal = records.every(record => record.target === container || container.contains(record.target));\n    if (!isInternal) redraw(true);\n  });\n\n  mutationObserver.observe(document.body, config);\n\n  const destroy = () => {\n    container.removeEventListener('pointermove', onPointerMove);\n  \n    renderer.destroy();\n  \n    store.unobserve(onStoreChange);\n\n    unsubscribeSelection();\n\n    document.removeEventListener('scroll', onScroll);\n\n    window.removeEventListener('resize', onResize);\n    resizeObserver.disconnect();\n\n    mutationObserver.disconnect();\n  }\n\n  return {\n    destroy,\n    redraw,\n    setStyle,\n    setFilter,\n    setPainter,\n    setVisible: renderer.setVisible\n  }\n\n}\n","import type { ViewportState } from '@annotorious/core';\nimport type { TextAnnotatorState } from '../../state';\nimport { debounce } from '../../utils';\nimport type { ViewportBounds } from '../viewport';\nimport type { HighlightStyle } from '../HighlightStyle';\nimport { DEFAULT_SELECTED_STYLE, DEFAULT_STYLE, type HighlightStyleExpression } from '../HighlightStyle';\nimport type { HighlightPainter } from '../HighlightPainter';\nimport { createBaseRenderer, type RendererImplementation } from '../baseRenderer';\nimport type { Highlight } from '../Highlight';\nimport type { TextAnnotation } from 'src/model';\n\nimport './canvasRenderer.css';\n\nconst createCanvas = () => {\n  const canvas = document.createElement('canvas');\n  canvas.width = window.innerWidth;\n  canvas.height = window.innerHeight;\n  canvas.className = 'r6o-canvas-highlight-layer bg';\n  return canvas;\n}\n\nconst resetCanvas = (canvas: HTMLCanvasElement, highres?: boolean) => {\n  canvas.width = highres ? 2 * window.innerWidth : window.innerWidth;\n  canvas.height = highres ? 2 * window.innerHeight : window.innerHeight;\n\n  if (highres) {\n    // Note that resizing the canvas resets the context\n    const context = canvas.getContext('2d');\n    context.scale(2, 2);\n    context.translate(0.5, 0.5);\n  }\n}\n\nconst createRenderer = (container: HTMLElement): RendererImplementation => {\n\n  container.classList.add('r6o-annotatable');\n\n  const canvas = createCanvas();\n  const ctx = canvas.getContext('2d');\n\n  document.body.appendChild(canvas);\n\n  const redraw = (\n    highlights: Highlight[],\n    viewportBounds: ViewportBounds,\n    currentStyle?: HighlightStyleExpression,\n    currentPainter?: HighlightPainter\n  ) => requestAnimationFrame(() => {\n\n    const { width, height } = canvas;\n\n    // New render loop - clear canvases\n    ctx.clearRect(-0.5, -0.5, width + 1, height + 1);\n\n    if (currentPainter)\n      currentPainter.clear();\n\n    const { top, left } = viewportBounds;\n\n    /**\n     * Highlights rendering on the canvas is an order-sensitive operation.\n     * The later the highlight is rendered, the higher it will be in the visual stack.\n     *\n     * By default, we should expect that the newer highlight\n     * will be rendered over the older one\n     */\n    const highlightsByCreation = [...highlights].sort((highlightA, highlightB) => {\n      const { annotation: { target: { created: createdA } } } = highlightA;\n      const { annotation: { target: { created: createdB } } } = highlightB;\n      return createdA.getTime() - createdB.getTime();\n    });\n\n    highlightsByCreation.forEach(h => {\n      const base: HighlightStyle = currentStyle\n        ? typeof currentStyle === 'function'\n          ? currentStyle(h.annotation, h.state)\n          : currentStyle\n        : h.state?.selected\n          ? DEFAULT_SELECTED_STYLE\n          : DEFAULT_STYLE;\n\n      // Trigger the custom painter (if any) as a side-effect\n      const style = currentPainter ? currentPainter.paint(h, viewportBounds) || base : base;\n\n      // Offset annotation rects by current scroll position\n      const offsetRects = h.rects.map(({ x, y, width, height }) => ({\n        x: x + left,\n        y: y + top,\n        width,\n        height\n      }));\n\n      ctx.fillStyle = style.fill;\n      ctx.globalAlpha = style.fillOpacity || 1;\n\n      offsetRects.forEach(({ x, y, width, height }) =>\n        ctx.fillRect(x, y, width, height)\n      );\n\n      if (style.underlineColor) {\n        ctx.globalAlpha = 1;\n        ctx.strokeStyle = style.underlineColor;\n        ctx.lineWidth = style.underlineThickness ?? 1;\n\n        // Place the underline below the highlighted text + an optional offset\n        const underlineOffset = style.underlineOffset ?? 0;\n\n        offsetRects.forEach(({ x, y, width, height }) => {\n          ctx.beginPath();\n          ctx.moveTo(x, y + height + underlineOffset);\n          ctx.lineTo(x + width, y + height + underlineOffset);\n\n          // Draw the Path\n          ctx.stroke();\n        });\n      }\n    });\n  });\n\n  const onResize = debounce(() => {\n    resetCanvas(canvas);\n  });\n\n  window.addEventListener('resize', onResize);\n\n  const setVisible = (visible: boolean) => {\n    console.log('setVisible not implemented on Canvas renderer');\n  }\n\n  const destroy = () => {\n    canvas.remove();\n\n    window.removeEventListener('resize', onResize);\n  }\n\n  return {\n    destroy,\n    setVisible,\n    redraw\n  };\n\n};\n\nexport const createCanvasRenderer = (\n  container: HTMLElement,\n  state: TextAnnotatorState<TextAnnotation, unknown>,\n  viewport: ViewportState\n) => createBaseRenderer(container, state, viewport, createRenderer(container));\n","var r={grad:.9,turn:360,rad:360/(2*Math.PI)},t=function(r){return\"string\"==typeof r?r.length>0:\"number\"==typeof r},n=function(r,t,n){return void 0===t&&(t=0),void 0===n&&(n=Math.pow(10,t)),Math.round(n*r)/n+0},e=function(r,t,n){return void 0===t&&(t=0),void 0===n&&(n=1),r>n?n:r>t?r:t},u=function(r){return(r=isFinite(r)?r%360:0)>0?r:r+360},a=function(r){return{r:e(r.r,0,255),g:e(r.g,0,255),b:e(r.b,0,255),a:e(r.a)}},o=function(r){return{r:n(r.r),g:n(r.g),b:n(r.b),a:n(r.a,3)}},i=/^#([0-9a-f]{3,8})$/i,s=function(r){var t=r.toString(16);return t.length<2?\"0\"+t:t},h=function(r){var t=r.r,n=r.g,e=r.b,u=r.a,a=Math.max(t,n,e),o=a-Math.min(t,n,e),i=o?a===t?(n-e)/o:a===n?2+(e-t)/o:4+(t-n)/o:0;return{h:60*(i<0?i+6:i),s:a?o/a*100:0,v:a/255*100,a:u}},b=function(r){var t=r.h,n=r.s,e=r.v,u=r.a;t=t/360*6,n/=100,e/=100;var a=Math.floor(t),o=e*(1-n),i=e*(1-(t-a)*n),s=e*(1-(1-t+a)*n),h=a%6;return{r:255*[e,i,o,o,s,e][h],g:255*[s,e,e,i,o,o][h],b:255*[o,o,s,e,e,i][h],a:u}},g=function(r){return{h:u(r.h),s:e(r.s,0,100),l:e(r.l,0,100),a:e(r.a)}},d=function(r){return{h:n(r.h),s:n(r.s),l:n(r.l),a:n(r.a,3)}},f=function(r){return b((n=(t=r).s,{h:t.h,s:(n*=((e=t.l)<50?e:100-e)/100)>0?2*n/(e+n)*100:0,v:e+n,a:t.a}));var t,n,e},c=function(r){return{h:(t=h(r)).h,s:(u=(200-(n=t.s))*(e=t.v)/100)>0&&u<200?n*e/100/(u<=100?u:200-u)*100:0,l:u/2,a:t.a};var t,n,e,u},l=/^hsla?\\(\\s*([+-]?\\d*\\.?\\d+)(deg|rad|grad|turn)?\\s*,\\s*([+-]?\\d*\\.?\\d+)%\\s*,\\s*([+-]?\\d*\\.?\\d+)%\\s*(?:,\\s*([+-]?\\d*\\.?\\d+)(%)?\\s*)?\\)$/i,p=/^hsla?\\(\\s*([+-]?\\d*\\.?\\d+)(deg|rad|grad|turn)?\\s+([+-]?\\d*\\.?\\d+)%\\s+([+-]?\\d*\\.?\\d+)%\\s*(?:\\/\\s*([+-]?\\d*\\.?\\d+)(%)?\\s*)?\\)$/i,v=/^rgba?\\(\\s*([+-]?\\d*\\.?\\d+)(%)?\\s*,\\s*([+-]?\\d*\\.?\\d+)(%)?\\s*,\\s*([+-]?\\d*\\.?\\d+)(%)?\\s*(?:,\\s*([+-]?\\d*\\.?\\d+)(%)?\\s*)?\\)$/i,m=/^rgba?\\(\\s*([+-]?\\d*\\.?\\d+)(%)?\\s+([+-]?\\d*\\.?\\d+)(%)?\\s+([+-]?\\d*\\.?\\d+)(%)?\\s*(?:\\/\\s*([+-]?\\d*\\.?\\d+)(%)?\\s*)?\\)$/i,y={string:[[function(r){var t=i.exec(r);return t?(r=t[1]).length<=4?{r:parseInt(r[0]+r[0],16),g:parseInt(r[1]+r[1],16),b:parseInt(r[2]+r[2],16),a:4===r.length?n(parseInt(r[3]+r[3],16)/255,2):1}:6===r.length||8===r.length?{r:parseInt(r.substr(0,2),16),g:parseInt(r.substr(2,2),16),b:parseInt(r.substr(4,2),16),a:8===r.length?n(parseInt(r.substr(6,2),16)/255,2):1}:null:null},\"hex\"],[function(r){var t=v.exec(r)||m.exec(r);return t?t[2]!==t[4]||t[4]!==t[6]?null:a({r:Number(t[1])/(t[2]?100/255:1),g:Number(t[3])/(t[4]?100/255:1),b:Number(t[5])/(t[6]?100/255:1),a:void 0===t[7]?1:Number(t[7])/(t[8]?100:1)}):null},\"rgb\"],[function(t){var n=l.exec(t)||p.exec(t);if(!n)return null;var e,u,a=g({h:(e=n[1],u=n[2],void 0===u&&(u=\"deg\"),Number(e)*(r[u]||1)),s:Number(n[3]),l:Number(n[4]),a:void 0===n[5]?1:Number(n[5])/(n[6]?100:1)});return f(a)},\"hsl\"]],object:[[function(r){var n=r.r,e=r.g,u=r.b,o=r.a,i=void 0===o?1:o;return t(n)&&t(e)&&t(u)?a({r:Number(n),g:Number(e),b:Number(u),a:Number(i)}):null},\"rgb\"],[function(r){var n=r.h,e=r.s,u=r.l,a=r.a,o=void 0===a?1:a;if(!t(n)||!t(e)||!t(u))return null;var i=g({h:Number(n),s:Number(e),l:Number(u),a:Number(o)});return f(i)},\"hsl\"],[function(r){var n=r.h,a=r.s,o=r.v,i=r.a,s=void 0===i?1:i;if(!t(n)||!t(a)||!t(o))return null;var h=function(r){return{h:u(r.h),s:e(r.s,0,100),v:e(r.v,0,100),a:e(r.a)}}({h:Number(n),s:Number(a),v:Number(o),a:Number(s)});return b(h)},\"hsv\"]]},N=function(r,t){for(var n=0;n<t.length;n++){var e=t[n][0](r);if(e)return[e,t[n][1]]}return[null,void 0]},x=function(r){return\"string\"==typeof r?N(r.trim(),y.string):\"object\"==typeof r&&null!==r?N(r,y.object):[null,void 0]},I=function(r){return x(r)[1]},M=function(r,t){var n=c(r);return{h:n.h,s:e(n.s+100*t,0,100),l:n.l,a:n.a}},H=function(r){return(299*r.r+587*r.g+114*r.b)/1e3/255},$=function(r,t){var n=c(r);return{h:n.h,s:n.s,l:e(n.l+100*t,0,100),a:n.a}},j=function(){function r(r){this.parsed=x(r)[0],this.rgba=this.parsed||{r:0,g:0,b:0,a:1}}return r.prototype.isValid=function(){return null!==this.parsed},r.prototype.brightness=function(){return n(H(this.rgba),2)},r.prototype.isDark=function(){return H(this.rgba)<.5},r.prototype.isLight=function(){return H(this.rgba)>=.5},r.prototype.toHex=function(){return r=o(this.rgba),t=r.r,e=r.g,u=r.b,i=(a=r.a)<1?s(n(255*a)):\"\",\"#\"+s(t)+s(e)+s(u)+i;var r,t,e,u,a,i},r.prototype.toRgb=function(){return o(this.rgba)},r.prototype.toRgbString=function(){return r=o(this.rgba),t=r.r,n=r.g,e=r.b,(u=r.a)<1?\"rgba(\"+t+\", \"+n+\", \"+e+\", \"+u+\")\":\"rgb(\"+t+\", \"+n+\", \"+e+\")\";var r,t,n,e,u},r.prototype.toHsl=function(){return d(c(this.rgba))},r.prototype.toHslString=function(){return r=d(c(this.rgba)),t=r.h,n=r.s,e=r.l,(u=r.a)<1?\"hsla(\"+t+\", \"+n+\"%, \"+e+\"%, \"+u+\")\":\"hsl(\"+t+\", \"+n+\"%, \"+e+\"%)\";var r,t,n,e,u},r.prototype.toHsv=function(){return r=h(this.rgba),{h:n(r.h),s:n(r.s),v:n(r.v),a:n(r.a,3)};var r},r.prototype.invert=function(){return w({r:255-(r=this.rgba).r,g:255-r.g,b:255-r.b,a:r.a});var r},r.prototype.saturate=function(r){return void 0===r&&(r=.1),w(M(this.rgba,r))},r.prototype.desaturate=function(r){return void 0===r&&(r=.1),w(M(this.rgba,-r))},r.prototype.grayscale=function(){return w(M(this.rgba,-1))},r.prototype.lighten=function(r){return void 0===r&&(r=.1),w($(this.rgba,r))},r.prototype.darken=function(r){return void 0===r&&(r=.1),w($(this.rgba,-r))},r.prototype.rotate=function(r){return void 0===r&&(r=15),this.hue(this.hue()+r)},r.prototype.alpha=function(r){return\"number\"==typeof r?w({r:(t=this.rgba).r,g:t.g,b:t.b,a:r}):n(this.rgba.a,3);var t},r.prototype.hue=function(r){var t=c(this.rgba);return\"number\"==typeof r?w({h:r,s:t.s,l:t.l,a:t.a}):n(t.h)},r.prototype.isEqual=function(r){return this.toHex()===w(r).toHex()},r}(),w=function(r){return r instanceof j?r:new j(r)},S=[],k=function(r){r.forEach(function(r){S.indexOf(r)<0&&(r(j,y),S.push(r))})},E=function(){return new j({r:255*Math.random(),g:255*Math.random(),b:255*Math.random()})};export{j as Colord,w as colord,k as extend,I as getFormat,E as random};\n","import type { ViewportState } from '@annotorious/core';\nimport { colord } from 'colord';\nimport type { HighlightPainter } from '../HighlightPainter';\nimport type { TextAnnotatorState } from 'src/state';\nimport type { ViewportBounds } from '../viewport';\nimport { DEFAULT_SELECTED_STYLE, DEFAULT_STYLE } from '../HighlightStyle';\nimport type { HighlightStyle, HighlightStyleExpression } from '../HighlightStyle';\nimport { type RendererImplementation, createBaseRenderer } from '../baseRenderer';\nimport type { Highlight } from '../Highlight';\nimport type { TextAnnotation } from 'src/model';\n\nconst toCSS = (s?: HighlightStyle) => {\n  const backgroundColor = colord(s?.fill || DEFAULT_STYLE.fill)\n    .alpha(s?.fillOpacity === undefined ? DEFAULT_STYLE.fillOpacity : s.fillOpacity)\n    .toHex();\n\n  const rules = [\n    `background-color:${backgroundColor}`,\n    s?.underlineThickness ? `text-decoration:underline` : undefined,\n    s?.underlineColor ? `text-decoration-color:${s.underlineColor}` : undefined,\n    s?.underlineOffset ? `text-underline-offset:${s.underlineOffset}px` : undefined,\n    s?.underlineThickness ? `text-decoration-thickness:${s.underlineThickness}px` : undefined\n  ].filter(Boolean);\n\n  return rules.join(';');\n}\n\nexport const createRenderer = (): RendererImplementation => {\n  const elem = document.createElement('style');\n  document.getElementsByTagName('head')[0].appendChild(elem);\n\n  let currentRendered = new Set<string>();\n\n  const redraw = (\n    highlights: Highlight[],\n    viewportBounds: ViewportBounds,\n    currentStyle?: HighlightStyleExpression,\n    painter?: HighlightPainter\n  ) => {\n    if (painter)\n      painter.clear();\n\n    // Next set of rendered annotation IDs and selections\n    const nextRendered = new Set(highlights.map(h => h.annotation.id));\n\n    // Annotations currently in this stylesheet that no longer need rendering\n    const toRemove = Array.from(currentRendered).filter(id => !nextRendered.has(id));\n\n    // For simplicity, re-generate the whole stylesheet\n    const updatedCSS = highlights.map(h => {\n      const base = currentStyle\n        ? typeof currentStyle === 'function'\n          ? currentStyle(h.annotation, h.state)\n          : currentStyle\n        : h.state?.selected ? DEFAULT_SELECTED_STYLE : DEFAULT_STYLE;\n\n      // Trigger the custom painter (if any) as a side-effect\n      const style = painter ? painter.paint(h, viewportBounds) || base : base;\n\n      return `::highlight(_${h.annotation.id}) { ${toCSS(style)} }`;\n    });\n\n    elem.innerHTML = updatedCSS.join('\\n');\n\n    // After we have the styles, we need to update the Highlights.\n    // Note that the (experimental) CSS Custom Highlight API is not yet\n    // available in TypeScript!\n\n    // @ts-ignore\n    CSS.highlights.clear();\n    // toRemove.forEach(id => CSS.highlights.delete(`_${id}`));\n\n    // Could be improved further by (re-)setting only annotations that\n    // have changes.\n    highlights.forEach(({ annotation }) => {\n      const ranges = annotation.target.selector.map(s => s.range);\n\n      // @ts-ignore\n      const highlights = new Highlight(...ranges);\n\n      // @ts-ignore\n      CSS.highlights.set(`_${annotation.id}`, highlights);\n    });\n\n    currentRendered = nextRendered;\n  }\n\n  const setVisible = (visible: boolean) => {\n    console.log('setVisible not implemented on CSS Custom Highlights renderer');\n  }\n\n  const destroy = () => {\n    // Clear all highlights from the Highlight Registry\n    // @ts-ignore\n    CSS.highlights.clear();\n\n    // Remove the stylesheet\n    elem.remove();\n  }\n\n  return {\n    destroy,\n    setVisible,\n    redraw\n  };\n\n}\n\nexport const createHighlightsRenderer = (\n  container: HTMLElement,\n  state: TextAnnotatorState<TextAnnotation, unknown>,\n  viewport: ViewportState\n) => createBaseRenderer(container, state, viewport, createRenderer());\n","var has = Object.prototype.hasOwnProperty;\n\nexport function dequal(foo, bar) {\n\tvar ctor, len;\n\tif (foo === bar) return true;\n\n\tif (foo && bar && (ctor=foo.constructor) === bar.constructor) {\n\t\tif (ctor === Date) return foo.getTime() === bar.getTime();\n\t\tif (ctor === RegExp) return foo.toString() === bar.toString();\n\n\t\tif (ctor === Array) {\n\t\t\tif ((len=foo.length) === bar.length) {\n\t\t\t\twhile (len-- && dequal(foo[len], bar[len]));\n\t\t\t}\n\t\t\treturn len === -1;\n\t\t}\n\n\t\tif (!ctor || typeof foo === 'object') {\n\t\t\tlen = 0;\n\t\t\tfor (ctor in foo) {\n\t\t\t\tif (has.call(foo, ctor) && ++len && !has.call(bar, ctor)) return false;\n\t\t\t\tif (!(ctor in bar) || !dequal(foo[ctor], bar[ctor])) return false;\n\t\t\t}\n\t\t\treturn Object.keys(bar).length === len;\n\t\t}\n\t}\n\n\treturn foo !== foo && bar !== bar;\n}\n","import type { ViewportState } from '@annotorious/core';\nimport { colord } from 'colord';\nimport { dequal } from 'dequal/lite';\nimport type { Rect, TextAnnotatorState } from '../../state';\nimport { type HighlightPainter, paint } from '../HighlightPainter';\nimport type { ViewportBounds } from '../viewport';\nimport { createBaseRenderer, type RendererImplementation } from '../baseRenderer';\nimport type { Highlight } from '../Highlight';\nimport { DEFAULT_STYLE, type HighlightStyleExpression } from '../HighlightStyle';\nimport type { TextAnnotation } from 'src/model';\n\nimport './spansRenderer.css';\n\nconst computeZIndex = (rect: Rect, all: Highlight[]): number => {\n  const intersects = (a: Rect, b: Rect): boolean => (\n    a.x <= b.x + b.width && a.x + a.width >= b.x &&\n    a.y <= b.y + b.height && a.y + a.height >= b.y\n  )\n\n  const getLength = (h: Highlight) => \n    h.rects.reduce((total, rect) => total + rect.width, 0);\n\n  // Any highlights that intersect this rect, sorted by total length\n  const intersecting = all.filter(({ rects }) => rects.some(r => intersects(rect, r)));\n  intersecting.sort((a, b) => getLength(b) - getLength(a));\n\n  return intersecting.findIndex(h => h.rects.includes(rect));\n}\n\nconst createRenderer = (container: HTMLElement): RendererImplementation => {\n\n  container.classList.add('r6o-annotatable');\n\n  const highlightLayer = document.createElement('div');\n  highlightLayer.className = 'r6o-span-highlight-layer';\n\n  container.insertBefore(highlightLayer, container.firstChild);\n\n  // Currently rendered highlights\n  let currentRendered: Highlight[] = [];\n\n  const redraw = (\n    highlights: Highlight[],\n    viewportBounds: ViewportBounds,\n    currentStyle?: HighlightStyleExpression,\n    painter?: HighlightPainter,\n    lazy?: boolean\n  ) => {\n    const noChanges = dequal(currentRendered, highlights);\n\n    // If there are no changes and rendering is set to lazy\n    // Don't redraw the SPANs - but redraw the painter, if any!\n    const shouldRedraw = !(noChanges && lazy);\n\n    if (!painter && !shouldRedraw) return;\n\n    if (shouldRedraw)\n      highlightLayer.innerHTML = '';\n\n    /**\n     * Highlights rendering in the span highlight layer is an order-sensitive operation.\n     * The later the highlight is rendered, the higher it will be in the visual stack.\n     *\n     * By default, we should expect that the newer highlight\n     * will be rendered over the older one\n     */\n    const sorted = [...highlights].sort((highlightA, highlightB) => {\n      const { annotation: { target: { created: createdA } } } = highlightA;\n      const { annotation: { target: { created: createdB } } } = highlightB;\n      return createdA && createdB ? createdA.getTime() - createdB.getTime() : 0;\n    });\n\n    sorted.forEach(highlight => {\n      highlight.rects.map(rect => {\n        const zIndex = computeZIndex(rect, highlights);\n        const style = paint(highlight, viewportBounds, currentStyle, painter, zIndex);\n\n        if (shouldRedraw) {\n          const span = document.createElement('span');\n          span.className = 'r6o-annotation';\n          span.dataset.annotation = highlight.annotation.id;\n\n          span.style.left = `${rect.x}px`;\n          span.style.top = `${rect.y}px`;\n          span.style.width = `${rect.width}px`;\n          span.style.height = `${rect.height}px`;\n\n          span.style.backgroundColor = colord(style?.fill || DEFAULT_STYLE.fill)\n            .alpha(style?.fillOpacity === undefined ? DEFAULT_STYLE.fillOpacity : style.fillOpacity)\n            .toHex();\n\n          if (style.underlineStyle)\n            span.style.borderStyle = style.underlineStyle;\n\n          if (style.underlineColor)\n            span.style.borderColor = style.underlineColor;\n\n          if (style.underlineThickness)\n            span.style.borderBottomWidth = `${style.underlineThickness}px`;\n\n          if (style.underlineOffset)\n            span.style.paddingBottom = `${style.underlineOffset}px`;\n\n          highlightLayer.appendChild(span);\n        }\n      });\n    });\n\n    currentRendered = highlights;\n  }\n\n  const setVisible = (visible: boolean) => {\n    if (visible)\n      highlightLayer.classList.remove('hidden');\n    else\n      highlightLayer.classList.add('hidden');\n  }\n\n  const destroy = () => {\n    highlightLayer.remove();\n  }\n\n  return {\n    destroy,\n    redraw,\n    setVisible\n  };\n\n}\n\nexport const createSpansRenderer = (\n  container: HTMLElement,\n  state: TextAnnotatorState<TextAnnotation, unknown>,\n  viewport: ViewportState\n) => createBaseRenderer(container, state, viewport, createRenderer(container));\n","import validate from './validate.js';\nconst byteToHex = [];\nfor (let i = 0; i < 256; ++i) {\n    byteToHex.push((i + 0x100).toString(16).slice(1));\n}\nexport function unsafeStringify(arr, offset = 0) {\n    return (byteToHex[arr[offset + 0]] +\n        byteToHex[arr[offset + 1]] +\n        byteToHex[arr[offset + 2]] +\n        byteToHex[arr[offset + 3]] +\n        '-' +\n        byteToHex[arr[offset + 4]] +\n        byteToHex[arr[offset + 5]] +\n        '-' +\n        byteToHex[arr[offset + 6]] +\n        byteToHex[arr[offset + 7]] +\n        '-' +\n        byteToHex[arr[offset + 8]] +\n        byteToHex[arr[offset + 9]] +\n        '-' +\n        byteToHex[arr[offset + 10]] +\n        byteToHex[arr[offset + 11]] +\n        byteToHex[arr[offset + 12]] +\n        byteToHex[arr[offset + 13]] +\n        byteToHex[arr[offset + 14]] +\n        byteToHex[arr[offset + 15]]).toLowerCase();\n}\nfunction stringify(arr, offset = 0) {\n    const uuid = unsafeStringify(arr, offset);\n    if (!validate(uuid)) {\n        throw TypeError('Stringified UUID is invalid');\n    }\n    return uuid;\n}\nexport default stringify;\n","let getRandomValues;\nconst rnds8 = new Uint8Array(16);\nexport default function rng() {\n    if (!getRandomValues) {\n        if (typeof crypto === 'undefined' || !crypto.getRandomValues) {\n            throw new Error('crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported');\n        }\n        getRandomValues = crypto.getRandomValues.bind(crypto);\n    }\n    return getRandomValues(rnds8);\n}\n","const randomUUID = typeof crypto !== 'undefined' && crypto.randomUUID && crypto.randomUUID.bind(crypto);\nexport default { randomUUID };\n","import native from './native.js';\nimport rng from './rng.js';\nimport { unsafeStringify } from './stringify.js';\nfunction v4(options, buf, offset) {\n    if (native.randomUUID && !buf && !options) {\n        return native.randomUUID();\n    }\n    options = options || {};\n    const rnds = options.random || (options.rng || rng)();\n    rnds[6] = (rnds[6] & 0x0f) | 0x40;\n    rnds[8] = (rnds[8] & 0x3f) | 0x80;\n    if (buf) {\n        offset = offset || 0;\n        for (let i = 0; i < 16; ++i) {\n            buf[offset + i] = rnds[i];\n        }\n        return buf;\n    }\n    return unsafeStringify(rnds);\n}\nexport default v4;\n","var M = Object.prototype.hasOwnProperty;\nfunction k(e, t) {\n  var n, o;\n  if (e === t) return !0;\n  if (e && t && (n = e.constructor) === t.constructor) {\n    if (n === Date) return e.getTime() === t.getTime();\n    if (n === RegExp) return e.toString() === t.toString();\n    if (n === Array) {\n      if ((o = e.length) === t.length)\n        for (; o-- && k(e[o], t[o]); ) ;\n      return o === -1;\n    }\n    if (!n || typeof e == \"object\") {\n      o = 0;\n      for (n in e)\n        if (M.call(e, n) && ++o && !M.call(t, n) || !(n in t) || !k(e[n], t[n])) return !1;\n      return Object.keys(t).length === o;\n    }\n  }\n  return e !== e && t !== t;\n}\nfunction V() {\n}\nfunction X(e, t) {\n  return e != e ? t == t : e !== t || e && typeof e == \"object\" || typeof e == \"function\";\n}\nconst N = [];\nfunction j(e, t = V) {\n  let n;\n  const o = /* @__PURE__ */ new Set();\n  function s(b) {\n    if (X(e, b) && (e = b, n)) {\n      const w = !N.length;\n      for (const m of o)\n        m[1](), N.push(m, e);\n      if (w) {\n        for (let m = 0; m < N.length; m += 2)\n          N[m][0](N[m + 1]);\n        N.length = 0;\n      }\n    }\n  }\n  function f(b) {\n    s(b(e));\n  }\n  function A(b, w = V) {\n    const m = [b, w];\n    return o.add(m), o.size === 1 && (n = t(s, f) || V), b(e), () => {\n      o.delete(m), o.size === 0 && n && (n(), n = null);\n    };\n  }\n  return { set: s, update: f, subscribe: A };\n}\nconst Ue = (e) => {\n  const { subscribe: t, set: n } = j();\n  let o;\n  return t((s) => o = s), e.observe(({ changes: s }) => {\n    if (o) {\n      (s.deleted || []).some((b) => b.id === o) && n(void 0);\n      const A = (s.updated || []).find(({ oldValue: b }) => b.id === o);\n      A && n(A.newValue.id);\n    }\n  }), {\n    get current() {\n      return o;\n    },\n    subscribe: t,\n    set: n\n  };\n};\nvar Z = /* @__PURE__ */ ((e) => (e.EDIT = \"EDIT\", e.SELECT = \"SELECT\", e.NONE = \"NONE\", e))(Z || {});\nconst z = { selected: [] }, Se = (e, t, n) => {\n  const { subscribe: o, set: s } = j(z);\n  let f = t, A = z;\n  o((h) => A = h);\n  const b = () => {\n    k(A, z) || s(z);\n  }, w = () => {\n    var h;\n    return ((h = A.selected) == null ? void 0 : h.length) === 0;\n  }, m = (h) => {\n    if (w())\n      return !1;\n    const C = typeof h == \"string\" ? h : h.id;\n    return A.selected.some((D) => D.id === C);\n  }, U = (h, C) => {\n    let D;\n    if (Array.isArray(h)) {\n      if (D = h.map((i) => e.getAnnotation(i)).filter(Boolean), D.length < h.length) {\n        console.warn(\"Invalid selection: \" + h.filter((i) => !D.some((p) => p.id === i)));\n        return;\n      }\n    } else {\n      const i = e.getAnnotation(h);\n      if (!i) {\n        console.warn(\"Invalid selection: \" + h);\n        return;\n      }\n      D = [i];\n    }\n    const a = D.reduce((i, p) => {\n      const v = W(p, f, n);\n      return v === \"EDIT\" ? [...i, { id: p.id, editable: !0 }] : v === \"SELECT\" ? [...i, { id: p.id }] : i;\n    }, []);\n    s({ selected: a, event: C });\n  }, c = (h, C) => {\n    const D = Array.isArray(h) ? h : [h], a = D.map((i) => e.getAnnotation(i)).filter((i) => !!i);\n    s({\n      selected: a.map((i) => {\n        const p = C === void 0 ? W(i, f, n) === \"EDIT\" : C;\n        return { id: i.id, editable: p };\n      })\n    }), a.length !== D.length && console.warn(\"Invalid selection\", h);\n  }, E = (h) => {\n    if (w())\n      return !1;\n    const { selected: C } = A;\n    C.some(({ id: a }) => h.includes(a)) && s({ selected: C.filter(({ id: a }) => !h.includes(a)) });\n  }, T = (h) => f = h;\n  return e.observe(\n    ({ changes: h }) => E((h.deleted || []).map((C) => C.id))\n  ), {\n    get event() {\n      return A ? A.event : null;\n    },\n    get selected() {\n      return A ? [...A.selected] : null;\n    },\n    get userSelectAction() {\n      return f;\n    },\n    clear: b,\n    isEmpty: w,\n    isSelected: m,\n    setSelected: c,\n    setUserSelectAction: T,\n    subscribe: o,\n    userSelect: U\n  };\n}, W = (e, t, n) => {\n  const o = n ? n.serialize(e) : e;\n  return typeof t == \"function\" ? t(o) : t || \"EDIT\";\n}, R = [];\nfor (let e = 0; e < 256; ++e)\n  R.push((e + 256).toString(16).slice(1));\nfunction F(e, t = 0) {\n  return (R[e[t + 0]] + R[e[t + 1]] + R[e[t + 2]] + R[e[t + 3]] + \"-\" + R[e[t + 4]] + R[e[t + 5]] + \"-\" + R[e[t + 6]] + R[e[t + 7]] + \"-\" + R[e[t + 8]] + R[e[t + 9]] + \"-\" + R[e[t + 10]] + R[e[t + 11]] + R[e[t + 12]] + R[e[t + 13]] + R[e[t + 14]] + R[e[t + 15]]).toLowerCase();\n}\nlet _;\nconst K = new Uint8Array(16);\nfunction ee() {\n  if (!_) {\n    if (typeof crypto > \"u\" || !crypto.getRandomValues)\n      throw new Error(\"crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported\");\n    _ = crypto.getRandomValues.bind(crypto);\n  }\n  return _(K);\n}\nconst te = typeof crypto < \"u\" && crypto.randomUUID && crypto.randomUUID.bind(crypto), q = { randomUUID: te };\nfunction G(e, t, n) {\n  if (q.randomUUID && !t && !e)\n    return q.randomUUID();\n  e = e || {};\n  const o = e.random || (e.rng || ee)();\n  return o[6] = o[6] & 15 | 64, o[8] = o[8] & 63 | 128, F(o);\n}\nconst Te = (e) => {\n  const { creator: t, updatedBy: n } = e.target, o = e.bodies.reduce((s, f) => [...s, f.creator, f.updatedBy].filter(Boolean), []);\n  return [\n    t,\n    n,\n    ...o\n  ].filter((s) => s);\n}, Y = (e) => {\n  const t = (n) => {\n    const o = { ...n };\n    return n.created && typeof n.created == \"string\" && (o.created = new Date(n.created)), n.updated && typeof n.updated == \"string\" && (o.updated = new Date(n.updated)), o;\n  };\n  return {\n    ...e,\n    bodies: (e.bodies || []).map(t),\n    target: t(e.target)\n  };\n}, De = (e, t, n, o) => ({\n  id: G(),\n  annotation: typeof e == \"string\" ? e : e.id,\n  created: n || /* @__PURE__ */ new Date(),\n  creator: o,\n  ...t\n}), ne = (e, t) => {\n  const n = new Set(e.bodies.map((o) => o.id));\n  return t.bodies.filter((o) => !n.has(o.id));\n}, oe = (e, t) => {\n  const n = new Set(t.bodies.map((o) => o.id));\n  return e.bodies.filter((o) => !n.has(o.id));\n}, se = (e, t) => t.bodies.map((n) => {\n  const o = e.bodies.find((s) => s.id === n.id);\n  return { newBody: n, oldBody: o && !k(o, n) ? o : void 0 };\n}).filter(({ oldBody: n }) => n).map(({ oldBody: n, newBody: o }) => ({ oldBody: n, newBody: o })), ie = (e, t) => !k(e.target, t.target), J = (e, t) => {\n  const n = ne(e, t), o = oe(e, t), s = se(e, t);\n  return {\n    oldValue: e,\n    newValue: t,\n    bodiesCreated: n.length > 0 ? n : void 0,\n    bodiesDeleted: o.length > 0 ? o : void 0,\n    bodiesUpdated: s.length > 0 ? s : void 0,\n    targetUpdated: ie(e, t) ? { oldTarget: e.target, newTarget: t.target } : void 0\n  };\n};\nvar de = /* @__PURE__ */ ((e) => (e.BODY_ONLY = \"BODY_ONLY\", e.TARGET_ONLY = \"TARGET_ONLY\", e))(de || {}), O = /* @__PURE__ */ ((e) => (e.LOCAL = \"LOCAL\", e.REMOTE = \"REMOTE\", e.SILENT = \"SILENT\", e))(O || {});\nconst re = (e, t) => {\n  var f, A;\n  const { changes: n, origin: o } = t;\n  if (!(e.options.origin ? e.options.origin === o : o !== \"SILENT\"))\n    return !1;\n  if (e.options.ignore) {\n    const { ignore: b } = e.options, w = (U) => U && U.length > 0;\n    if (!(w(n.created) || w(n.deleted))) {\n      const U = (f = n.updated) == null ? void 0 : f.some((E) => w(E.bodiesCreated) || w(E.bodiesDeleted) || w(E.bodiesUpdated)), c = (A = n.updated) == null ? void 0 : A.some((E) => E.targetUpdated);\n      if (b === \"BODY_ONLY\" && U && !c || b === \"TARGET_ONLY\" && c && !U)\n        return !1;\n    }\n  }\n  if (e.options.annotations) {\n    const b = /* @__PURE__ */ new Set([\n      ...(n.created || []).map((m) => m.id),\n      ...(n.deleted || []).map((m) => m.id),\n      ...(n.updated || []).map(({ oldValue: m }) => m.id)\n    ]);\n    return !!(Array.isArray(e.options.annotations) ? e.options.annotations : [e.options.annotations]).find((m) => b.has(m));\n  } else\n    return !0;\n}, ae = (e, t) => {\n  const n = new Set((e.created || []).map((c) => c.id)), o = new Set((e.updated || []).map(({ newValue: c }) => c.id)), s = new Set((t.created || []).map((c) => c.id)), f = new Set((t.deleted || []).map((c) => c.id)), A = new Set((t.updated || []).map(({ oldValue: c }) => c.id)), b = new Set((t.updated || []).filter(({ oldValue: c }) => n.has(c.id) || o.has(c.id)).map(({ oldValue: c }) => c.id)), w = [\n    ...(e.created || []).filter((c) => !f.has(c.id)).map((c) => A.has(c.id) ? t.updated.find(({ oldValue: E }) => E.id === c.id).newValue : c),\n    ...t.created || []\n  ], m = [\n    ...(e.deleted || []).filter((c) => !s.has(c.id)),\n    ...(t.deleted || []).filter((c) => !n.has(c.id))\n  ], U = [\n    ...(e.updated || []).filter(({ newValue: c }) => !f.has(c.id)).map((c) => {\n      const { oldValue: E, newValue: T } = c;\n      if (A.has(T.id)) {\n        const h = t.updated.find((C) => C.oldValue.id === T.id).newValue;\n        return J(E, h);\n      } else\n        return c;\n    }),\n    ...(t.updated || []).filter(({ oldValue: c }) => !b.has(c.id))\n  ];\n  return { created: w, deleted: m, updated: U };\n}, $ = (e) => {\n  const t = e.id === void 0 ? G() : e.id;\n  return {\n    ...e,\n    id: t,\n    bodies: e.bodies === void 0 ? [] : e.bodies.map((n) => ({\n      ...n,\n      annotation: t\n    })),\n    target: {\n      ...e.target,\n      annotation: t\n    }\n  };\n}, ce = (e) => e.id !== void 0, Oe = () => {\n  const e = /* @__PURE__ */ new Map(), t = /* @__PURE__ */ new Map(), n = [], o = (d, l = {}) => {\n    n.push({ onChange: d, options: l });\n  }, s = (d) => {\n    const l = n.findIndex((u) => u.onChange == d);\n    l > -1 && n.splice(l, 1);\n  }, f = (d, l) => {\n    const u = {\n      origin: d,\n      changes: {\n        created: l.created || [],\n        updated: l.updated || [],\n        deleted: l.deleted || []\n      },\n      state: [...e.values()]\n    };\n    n.forEach((g) => {\n      re(g, u) && g.onChange(u);\n    });\n  }, A = (d, l = O.LOCAL) => {\n    if (d.id && e.get(d.id))\n      throw Error(`Cannot add annotation ${d.id} - exists already`);\n    {\n      const g = $(d);\n      e.set(g.id, g), g.bodies.forEach((S) => t.set(S.id, g.id)), f(l, { created: [g] });\n    }\n  }, b = (d, l) => {\n    const u = $(typeof d == \"string\" ? l : d), g = typeof d == \"string\" ? d : d.id, S = g && e.get(g);\n    if (S) {\n      const y = J(S, u);\n      return g === u.id ? e.set(g, u) : (e.delete(g), e.set(u.id, u)), S.bodies.forEach((x) => t.delete(x.id)), u.bodies.forEach((x) => t.set(x.id, u.id)), y;\n    } else\n      console.warn(`Cannot update annotation ${g} - does not exist`);\n  }, w = (d, l = O.LOCAL, u = O.LOCAL) => {\n    const g = ce(l) ? u : l, S = b(d, l);\n    S && f(g, { updated: [S] });\n  }, m = (d, l = O.LOCAL) => {\n    const u = d.reduce((g, S) => {\n      const y = b(S);\n      return y ? [...g, y] : g;\n    }, []);\n    u.length > 0 && f(l, { updated: u });\n  }, U = (d, l = O.LOCAL) => {\n    const u = e.get(d.annotation);\n    if (u) {\n      const g = {\n        ...u,\n        bodies: [...u.bodies, d]\n      };\n      e.set(u.id, g), t.set(d.id, g.id), f(l, { updated: [{\n        oldValue: u,\n        newValue: g,\n        bodiesCreated: [d]\n      }] });\n    } else\n      console.warn(`Attempt to add body to missing annotation: ${d.annotation}`);\n  }, c = () => [...e.values()], E = (d = O.LOCAL) => {\n    const l = [...e.values()];\n    e.clear(), t.clear(), f(d, { deleted: l });\n  }, T = (d, l = !0, u = O.LOCAL) => {\n    const g = d.map($);\n    if (l) {\n      const S = [...e.values()];\n      e.clear(), t.clear(), g.forEach((y) => {\n        e.set(y.id, y), y.bodies.forEach((x) => t.set(x.id, y.id));\n      }), f(u, { created: g, deleted: S });\n    } else {\n      const S = d.reduce((y, x) => {\n        const H = x.id && e.get(x.id);\n        return H ? [...y, H] : y;\n      }, []);\n      if (S.length > 0)\n        throw Error(`Bulk insert would overwrite the following annotations: ${S.map((y) => y.id).join(\", \")}`);\n      g.forEach((y) => {\n        e.set(y.id, y), y.bodies.forEach((x) => t.set(x.id, y.id));\n      }), f(u, { created: g });\n    }\n  }, h = (d) => {\n    const l = typeof d == \"string\" ? d : d.id, u = e.get(l);\n    if (u)\n      return e.delete(l), u.bodies.forEach((g) => t.delete(g.id)), u;\n    console.warn(`Attempt to delete missing annotation: ${l}`);\n  }, C = (d, l = O.LOCAL) => {\n    const u = h(d);\n    u && f(l, { deleted: [u] });\n  }, D = (d, l = O.LOCAL) => {\n    const u = d.reduce((g, S) => {\n      const y = h(S);\n      return y ? [...g, y] : g;\n    }, []);\n    u.length > 0 && f(l, { deleted: u });\n  }, a = (d) => {\n    const l = e.get(d.annotation);\n    if (l) {\n      const u = l.bodies.find((g) => g.id === d.id);\n      if (u) {\n        t.delete(u.id);\n        const g = {\n          ...l,\n          bodies: l.bodies.filter((y) => y.id !== d.id)\n        };\n        return e.set(l.id, g), {\n          oldValue: l,\n          newValue: g,\n          bodiesDeleted: [u]\n        };\n      } else\n        console.warn(`Attempt to delete missing body ${d.id} from annotation ${d.annotation}`);\n    } else\n      console.warn(`Attempt to delete body from missing annotation ${d.annotation}`);\n  }, i = (d, l = O.LOCAL) => {\n    const u = a(d);\n    u && f(l, { updated: [u] });\n  }, p = (d, l = O.LOCAL) => {\n    const u = d.map((g) => a(g)).filter(Boolean);\n    u.length > 0 && f(l, { updated: u });\n  }, v = (d) => {\n    const l = e.get(d);\n    return l ? { ...l } : void 0;\n  }, r = (d) => {\n    const l = t.get(d);\n    if (l) {\n      const g = v(l).bodies.find((S) => S.id === d);\n      if (g)\n        return g;\n      console.error(`Store integrity error: body ${d} in index, but not in annotation`);\n    } else\n      console.warn(`Attempt to retrieve missing body: ${d}`);\n  }, L = (d, l) => {\n    if (d.annotation !== l.annotation)\n      throw \"Annotation integrity violation: annotation ID must be the same when updating bodies\";\n    const u = e.get(d.annotation);\n    if (u) {\n      const g = u.bodies.find((y) => y.id === d.id), S = {\n        ...u,\n        bodies: u.bodies.map((y) => y.id === g.id ? l : y)\n      };\n      return e.set(u.id, S), g.id !== l.id && (t.delete(g.id), t.set(l.id, S.id)), {\n        oldValue: u,\n        newValue: S,\n        bodiesUpdated: [{ oldBody: g, newBody: l }]\n      };\n    } else\n      console.warn(`Attempt to add body to missing annotation ${d.annotation}`);\n  }, B = (d, l, u = O.LOCAL) => {\n    const g = L(d, l);\n    g && f(u, { updated: [g] });\n  }, I = (d, l = O.LOCAL) => {\n    const u = d.map((g) => L({ id: g.id, annotation: g.annotation }, g)).filter(Boolean);\n    f(l, { updated: u });\n  }, P = (d) => {\n    const l = e.get(d.annotation);\n    if (l) {\n      const u = {\n        ...l,\n        target: {\n          ...l.target,\n          ...d\n        }\n      };\n      return e.set(l.id, u), {\n        oldValue: l,\n        newValue: u,\n        targetUpdated: {\n          oldTarget: l.target,\n          newTarget: d\n        }\n      };\n    } else\n      console.warn(`Attempt to update target on missing annotation: ${d.annotation}`);\n  };\n  return {\n    addAnnotation: A,\n    addBody: U,\n    all: c,\n    bulkAddAnnotation: T,\n    bulkDeleteAnnotation: D,\n    bulkDeleteBodies: p,\n    bulkUpdateAnnotation: m,\n    bulkUpdateBodies: I,\n    bulkUpdateTargets: (d, l = O.LOCAL) => {\n      const u = d.map((g) => P(g)).filter(Boolean);\n      u.length > 0 && f(l, { updated: u });\n    },\n    clear: E,\n    deleteAnnotation: C,\n    deleteBody: i,\n    getAnnotation: v,\n    getBody: r,\n    observe: o,\n    unobserve: s,\n    updateAnnotation: w,\n    updateBody: B,\n    updateTarget: (d, l = O.LOCAL) => {\n      const u = P(d);\n      u && f(l, { updated: [u] });\n    }\n  };\n}, Re = (e) => ({\n  ...e,\n  subscribe: (n) => {\n    const o = (s) => n(s.state);\n    return e.observe(o), n(e.all()), () => e.unobserve(o);\n  }\n});\nlet Q = () => ({\n  emit(e, ...t) {\n    for (let n = this.events[e] || [], o = 0, s = n.length; o < s; o++)\n      n[o](...t);\n  },\n  events: {},\n  on(e, t) {\n    var n;\n    return ((n = this.events)[e] || (n[e] = [])).push(t), () => {\n      var o;\n      this.events[e] = (o = this.events[e]) == null ? void 0 : o.filter((s) => t !== s);\n    };\n  }\n});\nconst le = 250, Be = (e, t) => {\n  const n = Q(), o = (t == null ? void 0 : t.changes) || [];\n  let s = t ? t.pointer : -1, f = !1, A = 0;\n  const b = (r) => {\n    if (!f) {\n      const { changes: L } = r, B = performance.now();\n      if (B - A > le)\n        o.splice(s + 1), o.push(L), s = o.length - 1;\n      else {\n        const I = o.length - 1;\n        o[I] = ae(o[I], L);\n      }\n      A = B;\n    }\n    f = !1;\n  };\n  e.observe(b, { origin: O.LOCAL });\n  const w = (r) => r && r.length > 0 && e.bulkDeleteAnnotation(r), m = (r) => r && r.length > 0 && e.bulkAddAnnotation(r, !1), U = (r) => r && r.length > 0 && e.bulkUpdateAnnotation(r.map(({ oldValue: L }) => L)), c = (r) => r && r.length > 0 && e.bulkUpdateAnnotation(r.map(({ newValue: L }) => L)), E = (r) => r && r.length > 0 && e.bulkAddAnnotation(r, !1), T = (r) => r && r.length > 0 && e.bulkDeleteAnnotation(r);\n  return {\n    canRedo: () => o.length - 1 > s,\n    canUndo: () => s > -1,\n    destroy: () => e.unobserve(b),\n    getHistory: () => ({ changes: [...o], pointer: s }),\n    on: (r, L) => n.on(r, L),\n    redo: () => {\n      if (o.length - 1 > s) {\n        f = !0;\n        const { created: r, updated: L, deleted: B } = o[s + 1];\n        m(r), c(L), T(B), n.emit(\"redo\", o[s + 1]), s += 1;\n      }\n    },\n    undo: () => {\n      if (s > -1) {\n        f = !0;\n        const { created: r, updated: L, deleted: B } = o[s];\n        w(r), U(L), E(B), n.emit(\"undo\", o[s]), s -= 1;\n      }\n    }\n  };\n}, xe = () => {\n  const { subscribe: e, set: t } = j([]);\n  return {\n    subscribe: e,\n    set: t\n  };\n}, Ie = (e, t, n, o) => {\n  const { hover: s, selection: f, store: A, viewport: b } = e, w = /* @__PURE__ */ new Map();\n  let m = [], U, c;\n  const E = (a, i) => {\n    w.has(a) ? w.get(a).push(i) : w.set(a, [i]);\n  }, T = (a, i) => {\n    const p = w.get(a);\n    if (p) {\n      const v = p.indexOf(i);\n      v !== -1 && p.splice(v, 1);\n    }\n  }, h = (a, i, p) => {\n    w.has(a) && setTimeout(() => {\n      w.get(a).forEach((v) => {\n        if (n) {\n          const r = Array.isArray(i) ? i.map((B) => n.serialize(B)) : n.serialize(i), L = p ? p instanceof PointerEvent ? p : n.serialize(p) : void 0;\n          v(r, L);\n        } else\n          v(i, p);\n      });\n    }, 1);\n  }, C = () => {\n    const { selected: a } = f, i = (a || []).map(({ id: p }) => A.getAnnotation(p));\n    i.forEach((p) => {\n      const v = m.find((r) => r.id === p.id);\n      (!v || !k(v, p)) && h(\"updateAnnotation\", p, v);\n    }), m = m.map((p) => {\n      const v = i.find(({ id: r }) => r === p.id);\n      return v || p;\n    });\n  };\n  f.subscribe(({ selected: a }) => {\n    if (!(m.length === 0 && a.length === 0)) {\n      if (m.length === 0 && a.length > 0)\n        m = a.map(({ id: i }) => A.getAnnotation(i));\n      else if (m.length > 0 && a.length === 0)\n        m.forEach((i) => {\n          const p = A.getAnnotation(i.id);\n          p && !k(p, i) && h(\"updateAnnotation\", p, i);\n        }), m = [];\n      else {\n        const i = new Set(m.map((r) => r.id)), p = new Set(a.map(({ id: r }) => r));\n        m.filter((r) => !p.has(r.id)).forEach((r) => {\n          const L = A.getAnnotation(r.id);\n          L && !k(L, r) && h(\"updateAnnotation\", L, r);\n        }), m = [\n          // Remove annotations that were deselected\n          ...m.filter((r) => p.has(r.id)),\n          // Add editable annotations that were selected\n          ...a.filter(({ id: r }) => !i.has(r)).map(({ id: r }) => A.getAnnotation(r))\n        ];\n      }\n      h(\"selectionChanged\", m);\n    }\n  }), s.subscribe((a) => {\n    !U && a ? h(\"mouseEnterAnnotation\", A.getAnnotation(a)) : U && !a ? h(\"mouseLeaveAnnotation\", A.getAnnotation(U)) : U && a && (h(\"mouseLeaveAnnotation\", A.getAnnotation(U)), h(\"mouseEnterAnnotation\", A.getAnnotation(a))), U = a;\n  }), b == null || b.subscribe((a) => h(\"viewportIntersect\", a.map((i) => A.getAnnotation(i)))), A.observe((a) => {\n    o && (c && clearTimeout(c), c = setTimeout(C, 1e3));\n    const { created: i, deleted: p } = a.changes;\n    (i || []).forEach((r) => h(\"createAnnotation\", r)), (p || []).forEach((r) => h(\"deleteAnnotation\", r)), (a.changes.updated || []).filter((r) => [\n      ...r.bodiesCreated || [],\n      ...r.bodiesDeleted || [],\n      ...r.bodiesUpdated || []\n    ].length > 0).forEach(({ oldValue: r, newValue: L }) => {\n      const B = m.find((I) => I.id === r.id) || r;\n      m = m.map((I) => I.id === r.id ? L : I), h(\"updateAnnotation\", L, B);\n    });\n  }, { origin: O.LOCAL }), A.observe((a) => {\n    if (m) {\n      const i = new Set(m.map((v) => v.id)), p = (a.changes.updated || []).filter(({ newValue: v }) => i.has(v.id)).map(({ newValue: v }) => v);\n      p.length > 0 && (m = m.map((v) => {\n        const r = p.find((L) => L.id === v.id);\n        return r || v;\n      }));\n    }\n  }, { origin: O.REMOTE });\n  const D = (a) => (i) => {\n    const { updated: p } = i;\n    a ? (p || []).forEach((v) => h(\"updateAnnotation\", v.oldValue, v.newValue)) : (p || []).forEach((v) => h(\"updateAnnotation\", v.newValue, v.oldValue));\n  };\n  return t.on(\"undo\", D(!0)), t.on(\"redo\", D(!1)), { on: E, off: T, emit: h };\n}, ke = (e) => (t) => t.map((n) => e.serialize(n)), ue = (e) => (t) => t.reduce((n, o) => {\n  const { parsed: s, error: f } = e.parse(o);\n  return f ? {\n    parsed: n.parsed,\n    failed: [...n.failed, o]\n  } : s ? {\n    parsed: [...n.parsed, s],\n    failed: n.failed\n  } : {\n    ...n\n  };\n}, { parsed: [], failed: [] }), Ne = (e, t, n) => {\n  const { store: o, selection: s } = e, f = (a) => {\n    if (n) {\n      const { parsed: i, error: p } = n.parse(a);\n      i ? o.addAnnotation(i, O.REMOTE) : console.error(p);\n    } else\n      o.addAnnotation(Y(a), O.REMOTE);\n  }, A = () => s.clear(), b = () => o.clear(), w = (a) => {\n    const i = o.getAnnotation(a);\n    return n && i ? n.serialize(i) : i;\n  }, m = () => n ? o.all().map(n.serialize) : o.all(), U = () => {\n    var p;\n    const i = (((p = s.selected) == null ? void 0 : p.map((v) => v.id)) || []).map((v) => o.getAnnotation(v)).filter(Boolean);\n    return n ? i.map(n.serialize) : i;\n  }, c = (a, i = !0) => fetch(a).then((p) => p.json()).then((p) => (T(p, i), p)), E = (a) => {\n    if (typeof a == \"string\") {\n      const i = o.getAnnotation(a);\n      if (o.deleteAnnotation(a), i)\n        return n ? n.serialize(i) : i;\n    } else {\n      const i = n ? n.parse(a).parsed : a;\n      if (i)\n        return o.deleteAnnotation(i), a;\n    }\n  }, T = (a, i = !0) => {\n    if (n) {\n      const p = n.parseAll || ue(n), { parsed: v, failed: r } = p(a);\n      r.length > 0 && console.warn(`Discarded ${r.length} invalid annotations`, r), o.bulkAddAnnotation(v, i, O.REMOTE);\n    } else\n      o.bulkAddAnnotation(a.map(Y), i, O.REMOTE);\n  }, h = (a, i) => {\n    a ? s.setSelected(a, i) : s.clear();\n  }, C = (a) => {\n    s.clear(), s.setUserSelectAction(a);\n  }, D = (a) => {\n    if (n) {\n      const i = n.parse(a).parsed, p = n.serialize(o.getAnnotation(i.id));\n      return o.updateAnnotation(i), p;\n    } else {\n      const i = o.getAnnotation(a.id);\n      return o.updateAnnotation(Y(a)), i;\n    }\n  };\n  return {\n    addAnnotation: f,\n    cancelSelected: A,\n    canRedo: t.canRedo,\n    canUndo: t.canUndo,\n    clearAnnotations: b,\n    getAnnotationById: w,\n    getAnnotations: m,\n    getHistory: t.getHistory,\n    getSelected: U,\n    loadAnnotations: c,\n    redo: t.redo,\n    removeAnnotation: E,\n    setAnnotations: T,\n    setSelected: h,\n    setUserSelectAction: C,\n    undo: t.undo,\n    updateAnnotation: D\n  };\n}, ze = (e, t, n) => typeof t == \"function\" ? t(e, n) : t, $e = (e, t) => typeof e != \"function\" && typeof t != \"function\" ? {\n  ...e || {},\n  ...t || {}\n} : (n, o) => {\n  const s = typeof e == \"function\" ? e(n, o) : e, f = typeof t == \"function\" ? t(n, o) : t;\n  return {\n    ...s || {},\n    ...f || {}\n  };\n}, fe = \"useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict\";\nlet pe = (e) => crypto.getRandomValues(new Uint8Array(e)), ge = (e, t, n) => {\n  let o = (2 << Math.log2(e.length - 1)) - 1, s = -~(1.6 * o * t / e.length);\n  return (f = t) => {\n    let A = \"\";\n    for (; ; ) {\n      let b = n(s), w = s | 0;\n      for (; w--; )\n        if (A += e[b[w] & o] || \"\", A.length >= f) return A;\n    }\n  };\n}, he = (e, t = 21) => ge(e, t | 0, pe), me = (e = 21) => {\n  let t = \"\", n = crypto.getRandomValues(new Uint8Array(e |= 0));\n  for (; e--; )\n    t += fe[n[e] & 63];\n  return t;\n};\nconst Ve = () => ({ isGuest: !0, id: he(\"1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_\", 20)() }), Ae = (e) => {\n  const t = JSON.stringify(e);\n  let n = 0;\n  for (let o = 0, s = t.length; o < s; o++) {\n    let f = t.charCodeAt(o);\n    n = (n << 5) - n + f, n |= 0;\n  }\n  return `${n}`;\n}, be = (e) => e ? typeof e == \"object\" ? { ...e } : e : void 0, _e = (e, t) => (Array.isArray(e) ? e : [e]).map((n) => {\n  const { id: o, type: s, purpose: f, value: A, created: b, modified: w, creator: m, ...U } = n;\n  return {\n    id: o || `temp-${Ae(n)}`,\n    annotation: t,\n    type: s,\n    purpose: f,\n    value: A,\n    creator: be(m),\n    created: b ? new Date(b) : void 0,\n    updated: w ? new Date(w) : void 0,\n    ...U\n  };\n}), Ye = (e) => e.map((t) => {\n  var b;\n  const { annotation: n, created: o, updated: s, ...f } = t, A = {\n    ...f,\n    created: o == null ? void 0 : o.toISOString(),\n    modified: s == null ? void 0 : s.toISOString()\n  };\n  return (b = A.id) != null && b.startsWith(\"temp-\") && delete A.id, A;\n}), ve = [\n  \"#ff7c00\",\n  // orange\n  \"#1ac938\",\n  // green\n  \"#e8000b\",\n  // red\n  \"#8b2be2\",\n  // purple\n  \"#9f4800\",\n  // brown\n  \"#f14cc1\",\n  // pink\n  \"#ffc400\",\n  // khaki\n  \"#00d7ff\",\n  // cyan\n  \"#023eff\"\n  // blue\n], Ee = () => {\n  const e = [...ve];\n  return { assignRandomColor: () => {\n    const o = Math.floor(Math.random() * e.length), s = e[o];\n    return e.splice(o, 1), s;\n  }, releaseColor: (o) => e.push(o) };\n}, we = () => {\n  const e = Ee();\n  return { addUser: (o, s) => {\n    const f = e.assignRandomColor();\n    return {\n      label: s.name || s.id,\n      avatar: s.avatar,\n      color: f\n    };\n  }, removeUser: (o) => e.releaseColor(o.appearance.color) };\n}, Ce = (e, t) => e.every((n) => e.includes(n)) && t.every((n) => e.includes(n)), je = me(), Pe = (e = we()) => {\n  const t = Q(), n = /* @__PURE__ */ new Map(), o = /* @__PURE__ */ new Map(), s = (c, E) => {\n    if (n.has(c)) {\n      console.warn(\"Attempt to add user that is already present\", c, E);\n      return;\n    }\n    const T = e.addUser(c, E);\n    n.set(c, {\n      ...E,\n      presenceKey: c,\n      appearance: T\n    });\n  }, f = (c) => {\n    const E = n.get(c);\n    if (!E) {\n      console.warn(\"Attempt to remove user that is not present\", c);\n      return;\n    }\n    e.removeUser(E), n.delete(c);\n  }, A = (c) => {\n    const E = new Set(c.map((C) => C.presenceKey)), T = c.filter(({ presenceKey: C }) => !n.has(C)), h = Array.from(n.values()).filter((C) => !E.has(C.presenceKey));\n    T.forEach(({ presenceKey: C, user: D }) => s(C, D)), h.forEach((C) => {\n      const { presenceKey: D } = C;\n      o.has(D) && t.emit(\"selectionChange\", C, null), f(D);\n    }), (T.length > 0 || h.length > 0) && t.emit(\"presence\", m());\n  }, b = (c, E) => {\n    const T = n.get(c);\n    if (!T) {\n      console.warn(\"Activity notification from user that is not present\");\n      return;\n    }\n    const h = o.get(c);\n    (!h || !Ce(h, E)) && (o.set(c, E), t.emit(\"selectionChange\", T, E));\n  }, w = (c, E) => {\n    const T = n.get(c);\n    if (!T) {\n      console.warn(\"Selection change for user that is not present\", c);\n      return;\n    }\n    E ? o.set(c, E) : o.delete(c), t.emit(\"selectionChange\", T, E);\n  }, m = () => [...Array.from(n.values())];\n  return {\n    getPresentUsers: m,\n    notifyActivity: b,\n    on: (c, E) => t.on(c, E),\n    syncUsers: A,\n    updateSelection: w\n  };\n};\nexport {\n  de as Ignore,\n  O as Origin,\n  je as PRESENCE_KEY,\n  Z as UserSelectAction,\n  $e as chainStyles,\n  ze as computeStyle,\n  Ve as createAnonymousGuest,\n  Ne as createBaseAnnotator,\n  De as createBody,\n  we as createDefaultAppearanceProvider,\n  Ue as createHoverState,\n  Ie as createLifecycleObserver,\n  Pe as createPresenceState,\n  Se as createSelectionState,\n  Oe as createStore,\n  Be as createUndoStack,\n  xe as createViewportState,\n  Ee as defaultColorProvider,\n  J as diffAnnotations,\n  Te as getContributors,\n  ae as mergeChanges,\n  W as onUserSelect,\n  ue as parseAll,\n  _e as parseW3CBodies,\n  be as parseW3CUser,\n  Y as reviveDates,\n  ke as serializeAll,\n  Ye as serializeW3CBodies,\n  re as shouldNotify,\n  Re as toSvelteStore\n};\n//# sourceMappingURL=annotorious-core.es.js.map\n","import { v4 as uuidv4 } from 'uuid';\nimport {\n  type FormatAdapter,\n  type ParseResult,\n  parseW3CBodies,\n  parseW3CUser,\n  serializeW3CBodies\n} from '@annotorious/core';\nimport type { TextAnnotation, TextAnnotationTarget, TextSelector } from '../core';\nimport type { W3CTextAnnotation, W3CTextAnnotationTarget, W3CTextSelector } from '../w3c';\nimport { getQuoteContext } from '../../utils';\n\nexport type W3CTextFormatAdapter<I extends TextAnnotation = TextAnnotation, E extends W3CTextAnnotation = W3CTextAnnotation> = FormatAdapter<I, E>;\n\n/**\n * @param source - the IRI of the annotated content\n * @param container - the HTML container of the annotated content,\n *                    Required to locate the content's `range` within the DOM\n */\nexport const W3CTextFormat =<I extends TextAnnotation = TextAnnotation, E extends W3CTextAnnotation = W3CTextAnnotation>(\n  source: string,\n  container: HTMLElement\n): W3CTextFormatAdapter<I, E> => ({\n  parse: (serialized) => parseW3CTextAnnotation(serialized),\n  serialize: (annotation) => serializeW3CTextAnnotation(annotation, source, container)\n});\n\nconst isTextSelector = (selector: Partial<TextSelector>): selector is TextSelector =>\n  selector.quote !== undefined && selector.start !== undefined && selector.end !== undefined;\n\nconst parseW3CTextTargets = (annotation: W3CTextAnnotation) => {\n  const {\n    id: annotationId,\n    creator,\n    created,\n    modified,\n    target\n  } = annotation;\n\n  const w3cTargets = Array.isArray(target) ? target : [target];\n  if (w3cTargets.length === 0) {\n    return { error: Error(`No targets found for annotation: ${annotation.id}`) };\n  }\n\n  const parsed: TextAnnotationTarget = {\n    creator: parseW3CUser(creator),\n    created: created ? new Date(created) : undefined,\n    updated: modified ? new Date(modified) : undefined,\n    annotation: annotationId,\n    selector: [],\n    // @ts-expect-error: `styleClass` is not part of the core `TextAnnotationTarget` type\n    styleClass: 'styleClass' in w3cTargets[0] ? w3cTargets[0].styleClass : undefined\n  };\n\n  for (const w3cTarget of w3cTargets) {\n    const w3cSelectors = Array.isArray(w3cTarget.selector) ? w3cTarget.selector : [w3cTarget.selector];\n\n    const selector = w3cSelectors.reduce<Partial<TextSelector>>((s, w3cSelector) => {\n      switch (w3cSelector.type) {\n        case 'TextQuoteSelector':\n          s.quote = w3cSelector.exact;\n          break;\n        case 'TextPositionSelector':\n          s.start = w3cSelector.start;\n          s.end = w3cSelector.end;\n          break;\n      }\n      return s;\n    }, {});\n\n    if (isTextSelector(selector)) {\n      parsed.selector.push(\n        {\n          ...selector,\n          id: w3cTarget.id,\n          // @ts-expect-error: `scope` is not part of the core `TextSelector` type\n          scope: w3cTarget.scope\n        }\n      );\n    } else {\n      const missingTypes = [\n        !selector.start ? 'TextPositionSelector' : undefined,\n        !selector.quote ? 'TextQuoteSelector' : undefined\n      ].filter(Boolean);\n\n      return { error: Error(`Missing selector types: ${missingTypes.join(' and ')} for annotation: ${annotation.id}`) };\n    }\n  }\n\n  return { parsed };\n};\n\nexport const parseW3CTextAnnotation = <I extends TextAnnotation = TextAnnotation, E extends W3CTextAnnotation = W3CTextAnnotation>(\n  annotation: E\n): ParseResult<I> => {\n  const annotationId = annotation.id || uuidv4();\n\n  const {\n    creator,\n    created,\n    modified,\n    body,\n    ...rest\n  } = annotation;\n\n  const bodies = parseW3CBodies(body, annotationId);\n  const target = parseW3CTextTargets(annotation);\n\n  const parseResult = 'error' in target\n    ? { error: target.error }\n    : {\n      parsed: {\n        ...rest,\n        id: annotationId,\n        bodies,\n        target: target.parsed\n      }\n    };\n\n  return parseResult as ParseResult<I>;\n\n};\n\nexport const serializeW3CTextAnnotation = <I extends TextAnnotation = TextAnnotation, E extends W3CTextAnnotation = W3CTextAnnotation>(\n  annotation: I,\n  source: string,\n  container: HTMLElement\n): E => {\n  const { bodies, target, ...rest } = annotation;\n\n  const {\n    selector,\n    creator,\n    created,\n    updated,\n    ...targetRest\n  } = target;\n\n  const w3cTargets = selector.map((s): W3CTextAnnotationTarget => {\n    const { id, quote, start, end, range } = s;\n\n    const { prefix, suffix } = getQuoteContext(range, container);\n\n    const w3cSelectors: W3CTextSelector[] = [{\n      type: 'TextQuoteSelector',\n      exact: quote,\n      prefix,\n      suffix\n    }, {\n      type: 'TextPositionSelector',\n      start,\n      end\n    }];\n\n    return {\n      ...targetRest,\n      id,\n      // @ts-expect-error: `scope` is not part of the core `TextSelector` type\n      scope: 'scope' in s ? s.scope : undefined,\n      source,\n      selector: w3cSelectors\n    };\n  });\n\n\n  return {\n    ...rest,\n    '@context': 'http://www.w3.org/ns/anno.jsonld',\n    id: annotation.id,\n    type: 'Annotation',\n    body: serializeW3CBodies(annotation.bodies),\n    creator,\n    created: created?.toISOString(),\n    modified: updated?.toISOString(),\n    target: w3cTargets\n  } as unknown as E;\n\n};\n","\n/**\n * Rearranges items so that all items in the [left, k] are the smallest.\n * The k-th element will have the (k - left + 1)-th smallest value in [left, right].\n *\n * @template T\n * @param {T[]} arr the array to partially sort (in place)\n * @param {number} k middle index for partial sorting (as defined above)\n * @param {number} [left=0] left index of the range to sort\n * @param {number} [right=arr.length-1] right index\n * @param {(a: T, b: T) => number} [compare = (a, b) => a - b] compare function\n */\nexport default function quickselect(arr, k, left = 0, right = arr.length - 1, compare = defaultCompare) {\n\n    while (right > left) {\n        if (right - left > 600) {\n            const n = right - left + 1;\n            const m = k - left + 1;\n            const z = Math.log(n);\n            const s = 0.5 * Math.exp(2 * z / 3);\n            const sd = 0.5 * Math.sqrt(z * s * (n - s) / n) * (m - n / 2 < 0 ? -1 : 1);\n            const newLeft = Math.max(left, Math.floor(k - m * s / n + sd));\n            const newRight = Math.min(right, Math.floor(k + (n - m) * s / n + sd));\n            quickselect(arr, k, newLeft, newRight, compare);\n        }\n\n        const t = arr[k];\n        let i = left;\n        /** @type {number} */\n        let j = right;\n\n        swap(arr, left, k);\n        if (compare(arr[right], t) > 0) swap(arr, left, right);\n\n        while (i < j) {\n            swap(arr, i, j);\n            i++;\n            j--;\n            while (compare(arr[i], t) < 0) i++;\n            while (compare(arr[j], t) > 0) j--;\n        }\n\n        if (compare(arr[left], t) === 0) swap(arr, left, j);\n        else {\n            j++;\n            swap(arr, j, right);\n        }\n\n        if (j <= k) left = j + 1;\n        if (k <= j) right = j - 1;\n    }\n}\n\n/**\n * @template T\n * @param {T[]} arr\n * @param {number} i\n * @param {number} j\n */\nfunction swap(arr, i, j) {\n    const tmp = arr[i];\n    arr[i] = arr[j];\n    arr[j] = tmp;\n}\n\n/**\n * @template T\n * @param {T} a\n * @param {T} b\n * @returns {number}\n */\nfunction defaultCompare(a, b) {\n    return a < b ? -1 : a > b ? 1 : 0;\n}\n","import quickselect from 'quickselect';\n\nexport default class RBush {\n    constructor(maxEntries = 9) {\n        // max entries in a node is 9 by default; min node fill is 40% for best performance\n        this._maxEntries = Math.max(4, maxEntries);\n        this._minEntries = Math.max(2, Math.ceil(this._maxEntries * 0.4));\n        this.clear();\n    }\n\n    all() {\n        return this._all(this.data, []);\n    }\n\n    search(bbox) {\n        let node = this.data;\n        const result = [];\n\n        if (!intersects(bbox, node)) return result;\n\n        const toBBox = this.toBBox;\n        const nodesToSearch = [];\n\n        while (node) {\n            for (let i = 0; i < node.children.length; i++) {\n                const child = node.children[i];\n                const childBBox = node.leaf ? toBBox(child) : child;\n\n                if (intersects(bbox, childBBox)) {\n                    if (node.leaf) result.push(child);\n                    else if (contains(bbox, childBBox)) this._all(child, result);\n                    else nodesToSearch.push(child);\n                }\n            }\n            node = nodesToSearch.pop();\n        }\n\n        return result;\n    }\n\n    collides(bbox) {\n        let node = this.data;\n\n        if (!intersects(bbox, node)) return false;\n\n        const nodesToSearch = [];\n        while (node) {\n            for (let i = 0; i < node.children.length; i++) {\n                const child = node.children[i];\n                const childBBox = node.leaf ? this.toBBox(child) : child;\n\n                if (intersects(bbox, childBBox)) {\n                    if (node.leaf || contains(bbox, childBBox)) return true;\n                    nodesToSearch.push(child);\n                }\n            }\n            node = nodesToSearch.pop();\n        }\n\n        return false;\n    }\n\n    load(data) {\n        if (!(data && data.length)) return this;\n\n        if (data.length < this._minEntries) {\n            for (let i = 0; i < data.length; i++) {\n                this.insert(data[i]);\n            }\n            return this;\n        }\n\n        // recursively build the tree with the given data from scratch using OMT algorithm\n        let node = this._build(data.slice(), 0, data.length - 1, 0);\n\n        if (!this.data.children.length) {\n            // save as is if tree is empty\n            this.data = node;\n\n        } else if (this.data.height === node.height) {\n            // split root if trees have the same height\n            this._splitRoot(this.data, node);\n\n        } else {\n            if (this.data.height < node.height) {\n                // swap trees if inserted one is bigger\n                const tmpNode = this.data;\n                this.data = node;\n                node = tmpNode;\n            }\n\n            // insert the small tree into the large tree at appropriate level\n            this._insert(node, this.data.height - node.height - 1, true);\n        }\n\n        return this;\n    }\n\n    insert(item) {\n        if (item) this._insert(item, this.data.height - 1);\n        return this;\n    }\n\n    clear() {\n        this.data = createNode([]);\n        return this;\n    }\n\n    remove(item, equalsFn) {\n        if (!item) return this;\n\n        let node = this.data;\n        const bbox = this.toBBox(item);\n        const path = [];\n        const indexes = [];\n        let i, parent, goingUp;\n\n        // depth-first iterative tree traversal\n        while (node || path.length) {\n\n            if (!node) { // go up\n                node = path.pop();\n                parent = path[path.length - 1];\n                i = indexes.pop();\n                goingUp = true;\n            }\n\n            if (node.leaf) { // check current node\n                const index = findItem(item, node.children, equalsFn);\n\n                if (index !== -1) {\n                    // item found, remove the item and condense tree upwards\n                    node.children.splice(index, 1);\n                    path.push(node);\n                    this._condense(path);\n                    return this;\n                }\n            }\n\n            if (!goingUp && !node.leaf && contains(node, bbox)) { // go down\n                path.push(node);\n                indexes.push(i);\n                i = 0;\n                parent = node;\n                node = node.children[0];\n\n            } else if (parent) { // go right\n                i++;\n                node = parent.children[i];\n                goingUp = false;\n\n            } else node = null; // nothing found\n        }\n\n        return this;\n    }\n\n    toBBox(item) { return item; }\n\n    compareMinX(a, b) { return a.minX - b.minX; }\n    compareMinY(a, b) { return a.minY - b.minY; }\n\n    toJSON() { return this.data; }\n\n    fromJSON(data) {\n        this.data = data;\n        return this;\n    }\n\n    _all(node, result) {\n        const nodesToSearch = [];\n        while (node) {\n            if (node.leaf) result.push(...node.children);\n            else nodesToSearch.push(...node.children);\n\n            node = nodesToSearch.pop();\n        }\n        return result;\n    }\n\n    _build(items, left, right, height) {\n\n        const N = right - left + 1;\n        let M = this._maxEntries;\n        let node;\n\n        if (N <= M) {\n            // reached leaf level; return leaf\n            node = createNode(items.slice(left, right + 1));\n            calcBBox(node, this.toBBox);\n            return node;\n        }\n\n        if (!height) {\n            // target height of the bulk-loaded tree\n            height = Math.ceil(Math.log(N) / Math.log(M));\n\n            // target number of root entries to maximize storage utilization\n            M = Math.ceil(N / Math.pow(M, height - 1));\n        }\n\n        node = createNode([]);\n        node.leaf = false;\n        node.height = height;\n\n        // split the items into M mostly square tiles\n\n        const N2 = Math.ceil(N / M);\n        const N1 = N2 * Math.ceil(Math.sqrt(M));\n\n        multiSelect(items, left, right, N1, this.compareMinX);\n\n        for (let i = left; i <= right; i += N1) {\n\n            const right2 = Math.min(i + N1 - 1, right);\n\n            multiSelect(items, i, right2, N2, this.compareMinY);\n\n            for (let j = i; j <= right2; j += N2) {\n\n                const right3 = Math.min(j + N2 - 1, right2);\n\n                // pack each entry recursively\n                node.children.push(this._build(items, j, right3, height - 1));\n            }\n        }\n\n        calcBBox(node, this.toBBox);\n\n        return node;\n    }\n\n    _chooseSubtree(bbox, node, level, path) {\n        while (true) {\n            path.push(node);\n\n            if (node.leaf || path.length - 1 === level) break;\n\n            let minArea = Infinity;\n            let minEnlargement = Infinity;\n            let targetNode;\n\n            for (let i = 0; i < node.children.length; i++) {\n                const child = node.children[i];\n                const area = bboxArea(child);\n                const enlargement = enlargedArea(bbox, child) - area;\n\n                // choose entry with the least area enlargement\n                if (enlargement < minEnlargement) {\n                    minEnlargement = enlargement;\n                    minArea = area < minArea ? area : minArea;\n                    targetNode = child;\n\n                } else if (enlargement === minEnlargement) {\n                    // otherwise choose one with the smallest area\n                    if (area < minArea) {\n                        minArea = area;\n                        targetNode = child;\n                    }\n                }\n            }\n\n            node = targetNode || node.children[0];\n        }\n\n        return node;\n    }\n\n    _insert(item, level, isNode) {\n        const bbox = isNode ? item : this.toBBox(item);\n        const insertPath = [];\n\n        // find the best node for accommodating the item, saving all nodes along the path too\n        const node = this._chooseSubtree(bbox, this.data, level, insertPath);\n\n        // put the item into the node\n        node.children.push(item);\n        extend(node, bbox);\n\n        // split on node overflow; propagate upwards if necessary\n        while (level >= 0) {\n            if (insertPath[level].children.length > this._maxEntries) {\n                this._split(insertPath, level);\n                level--;\n            } else break;\n        }\n\n        // adjust bboxes along the insertion path\n        this._adjustParentBBoxes(bbox, insertPath, level);\n    }\n\n    // split overflowed node into two\n    _split(insertPath, level) {\n        const node = insertPath[level];\n        const M = node.children.length;\n        const m = this._minEntries;\n\n        this._chooseSplitAxis(node, m, M);\n\n        const splitIndex = this._chooseSplitIndex(node, m, M);\n\n        const newNode = createNode(node.children.splice(splitIndex, node.children.length - splitIndex));\n        newNode.height = node.height;\n        newNode.leaf = node.leaf;\n\n        calcBBox(node, this.toBBox);\n        calcBBox(newNode, this.toBBox);\n\n        if (level) insertPath[level - 1].children.push(newNode);\n        else this._splitRoot(node, newNode);\n    }\n\n    _splitRoot(node, newNode) {\n        // split root node\n        this.data = createNode([node, newNode]);\n        this.data.height = node.height + 1;\n        this.data.leaf = false;\n        calcBBox(this.data, this.toBBox);\n    }\n\n    _chooseSplitIndex(node, m, M) {\n        let index;\n        let minOverlap = Infinity;\n        let minArea = Infinity;\n\n        for (let i = m; i <= M - m; i++) {\n            const bbox1 = distBBox(node, 0, i, this.toBBox);\n            const bbox2 = distBBox(node, i, M, this.toBBox);\n\n            const overlap = intersectionArea(bbox1, bbox2);\n            const area = bboxArea(bbox1) + bboxArea(bbox2);\n\n            // choose distribution with minimum overlap\n            if (overlap < minOverlap) {\n                minOverlap = overlap;\n                index = i;\n\n                minArea = area < minArea ? area : minArea;\n\n            } else if (overlap === minOverlap) {\n                // otherwise choose distribution with minimum area\n                if (area < minArea) {\n                    minArea = area;\n                    index = i;\n                }\n            }\n        }\n\n        return index || M - m;\n    }\n\n    // sorts node children by the best axis for split\n    _chooseSplitAxis(node, m, M) {\n        const compareMinX = node.leaf ? this.compareMinX : compareNodeMinX;\n        const compareMinY = node.leaf ? this.compareMinY : compareNodeMinY;\n        const xMargin = this._allDistMargin(node, m, M, compareMinX);\n        const yMargin = this._allDistMargin(node, m, M, compareMinY);\n\n        // if total distributions margin value is minimal for x, sort by minX,\n        // otherwise it's already sorted by minY\n        if (xMargin < yMargin) node.children.sort(compareMinX);\n    }\n\n    // total margin of all possible split distributions where each node is at least m full\n    _allDistMargin(node, m, M, compare) {\n        node.children.sort(compare);\n\n        const toBBox = this.toBBox;\n        const leftBBox = distBBox(node, 0, m, toBBox);\n        const rightBBox = distBBox(node, M - m, M, toBBox);\n        let margin = bboxMargin(leftBBox) + bboxMargin(rightBBox);\n\n        for (let i = m; i < M - m; i++) {\n            const child = node.children[i];\n            extend(leftBBox, node.leaf ? toBBox(child) : child);\n            margin += bboxMargin(leftBBox);\n        }\n\n        for (let i = M - m - 1; i >= m; i--) {\n            const child = node.children[i];\n            extend(rightBBox, node.leaf ? toBBox(child) : child);\n            margin += bboxMargin(rightBBox);\n        }\n\n        return margin;\n    }\n\n    _adjustParentBBoxes(bbox, path, level) {\n        // adjust bboxes along the given tree path\n        for (let i = level; i >= 0; i--) {\n            extend(path[i], bbox);\n        }\n    }\n\n    _condense(path) {\n        // go through the path, removing empty nodes and updating bboxes\n        for (let i = path.length - 1, siblings; i >= 0; i--) {\n            if (path[i].children.length === 0) {\n                if (i > 0) {\n                    siblings = path[i - 1].children;\n                    siblings.splice(siblings.indexOf(path[i]), 1);\n\n                } else this.clear();\n\n            } else calcBBox(path[i], this.toBBox);\n        }\n    }\n}\n\nfunction findItem(item, items, equalsFn) {\n    if (!equalsFn) return items.indexOf(item);\n\n    for (let i = 0; i < items.length; i++) {\n        if (equalsFn(item, items[i])) return i;\n    }\n    return -1;\n}\n\n// calculate node's bbox from bboxes of its children\nfunction calcBBox(node, toBBox) {\n    distBBox(node, 0, node.children.length, toBBox, node);\n}\n\n// min bounding rectangle of node children from k to p-1\nfunction distBBox(node, k, p, toBBox, destNode) {\n    if (!destNode) destNode = createNode(null);\n    destNode.minX = Infinity;\n    destNode.minY = Infinity;\n    destNode.maxX = -Infinity;\n    destNode.maxY = -Infinity;\n\n    for (let i = k; i < p; i++) {\n        const child = node.children[i];\n        extend(destNode, node.leaf ? toBBox(child) : child);\n    }\n\n    return destNode;\n}\n\nfunction extend(a, b) {\n    a.minX = Math.min(a.minX, b.minX);\n    a.minY = Math.min(a.minY, b.minY);\n    a.maxX = Math.max(a.maxX, b.maxX);\n    a.maxY = Math.max(a.maxY, b.maxY);\n    return a;\n}\n\nfunction compareNodeMinX(a, b) { return a.minX - b.minX; }\nfunction compareNodeMinY(a, b) { return a.minY - b.minY; }\n\nfunction bboxArea(a)   { return (a.maxX - a.minX) * (a.maxY - a.minY); }\nfunction bboxMargin(a) { return (a.maxX - a.minX) + (a.maxY - a.minY); }\n\nfunction enlargedArea(a, b) {\n    return (Math.max(b.maxX, a.maxX) - Math.min(b.minX, a.minX)) *\n           (Math.max(b.maxY, a.maxY) - Math.min(b.minY, a.minY));\n}\n\nfunction intersectionArea(a, b) {\n    const minX = Math.max(a.minX, b.minX);\n    const minY = Math.max(a.minY, b.minY);\n    const maxX = Math.min(a.maxX, b.maxX);\n    const maxY = Math.min(a.maxY, b.maxY);\n\n    return Math.max(0, maxX - minX) *\n           Math.max(0, maxY - minY);\n}\n\nfunction contains(a, b) {\n    return a.minX <= b.minX &&\n           a.minY <= b.minY &&\n           b.maxX <= a.maxX &&\n           b.maxY <= a.maxY;\n}\n\nfunction intersects(a, b) {\n    return b.minX <= a.maxX &&\n           b.minY <= a.maxY &&\n           b.maxX >= a.minX &&\n           b.maxY >= a.minY;\n}\n\nfunction createNode(children) {\n    return {\n        children,\n        height: 1,\n        leaf: true,\n        minX: Infinity,\n        minY: Infinity,\n        maxX: -Infinity,\n        maxY: -Infinity\n    };\n}\n\n// sort an array so that items come in groups of n unsorted items, with groups sorted between each other;\n// combines selection algorithm with binary divide & conquer approach\n\nfunction multiSelect(arr, left, right, n, compare) {\n    const stack = [left, right];\n\n    while (stack.length) {\n        right = stack.pop();\n        left = stack.pop();\n\n        if (right - left <= n) continue;\n\n        const mid = left + Math.ceil((right - left) / n / 2) * n;\n        quickselect(arr, mid, left, right, compare);\n\n        stack.push(left, mid, mid, right);\n    }\n}\n","import RBush from 'rbush';\nimport type { Store } from '@annotorious/core';\nimport type { TextAnnotation, TextAnnotationTarget } from '../model';\nimport { isRevived, reviveSelector, mergeClientRects } from '../utils';\nimport type { AnnotationRects } from './TextAnnotationStore';\n\ninterface IndexedHighlightRect {\n\n  minX: number;\n\n  minY: number;\n\n  maxX: number;\n\n  maxY: number;\n\n  annotation: {\n    \n    id: string;\n\n    rects: DOMRect[];\n\n  }\n\n}\n\nexport const createSpatialTree = <T extends TextAnnotation>(store: Store<T>, container: HTMLElement) => {\n\n  const tree = new RBush<IndexedHighlightRect>();\n\n  const index = new Map<string, IndexedHighlightRect[]>();\n\n  // Helper: converts a single text annotation target to a list of hightlight rects\n  const toItems = (target: TextAnnotationTarget, offset: DOMRect): IndexedHighlightRect[] => {\n    const rects = target.selector.flatMap(s => {\n      const revivedRange = isRevived([s]) ? s.range : reviveSelector(s, container).range;\n      return Array.from(revivedRange.getClientRects());\n    });\n\n    const merged = mergeClientRects(rects)\n      // Offset the merged client rects so that coords\n      // are relative to the parent container\n      .map(({ left, top, right, bottom }) =>  \n        new DOMRect(left - offset.left, top - offset.top, right - left, bottom - top));\n\n    return merged.map(rect => {\n      const { x, y, width, height } = rect;\n\n      return {\n        minX: x,\n        minY: y,\n        maxX: x + width,\n        maxY: y + height,\n        annotation: {\n          id: target.annotation,\n          rects: merged\n        }\n      }\n    });\n  }\n\n  const all = () => [...index.values()];\n\n  const clear = () => {\n    tree.clear();\n    index.clear();\n  }\n\n  const insert = (target: TextAnnotationTarget) => {\n    const rects = toItems(target, container.getBoundingClientRect());\n    if (rects.length === 0) return;\n\n    rects.forEach(rect => tree.insert(rect));\n    index.set(target.annotation, rects);\n  }\n\n  const remove = (target: TextAnnotationTarget) => {\n    const rects = index.get(target.annotation);\n    if (rects) {\n      rects.forEach(rect => tree.remove(rect));\n      index.delete(target.annotation);\n    }\n  }\n\n  const update = (target: TextAnnotationTarget) => {\n    remove(target);\n    insert(target);\n  }\n\n  const set = (targets: TextAnnotationTarget[], replace: boolean = true) => {\n    if (replace)\n      clear();\n\n    const offset = container.getBoundingClientRect();\n\n    const rectsByTarget = targets.map(target => ({ target, rects: toItems(target, offset) }));\n    rectsByTarget.forEach(({ target, rects }) => {\n      if (rects.length > 0)\n        index.set(target.annotation, rects)\n    });\n\n    const allRects = rectsByTarget.flatMap(({ rects }) => rects);\n    tree.load(allRects);\n  }\n\n  const getAt = (x: number, y: number, all = false): string[] => {\n    const hits = tree.search({\n      minX: x,\n      minY: y,\n      maxX: x,\n      maxY: y\n    });\n\n    const area = (rect: IndexedHighlightRect) =>\n      rect.annotation.rects.reduce((area, r) =>\n        area + r.width * r.height, 0);\n    \n    // Get smallest rect\n    if (hits.length > 0) {\n      hits.sort((a, b) => area(a) - area(b));\n      return all ? hits.map(h => h.annotation.id) : [ hits[0].annotation.id ];\n    } else {\n      return [];\n    }\n  }\n\n  const getAnnotationBounds = (id: string): DOMRect => {\n    const rects = getAnnotationRects(id);\n\n    if (rects.length === 0)\n      return undefined;\n\n    let left = rects[0].left;\n    let top = rects[0].top;\n    let right = rects[0].right;\n    let bottom = rects[0].bottom;\n\n    for (let i = 1; i < rects.length; i++) {\n      const rect = rects[i];\n\n      left = Math.min(left, rect.left);\n      top = Math.min(top, rect.top);\n      right = Math.max(right, rect.right);\n      bottom = Math.max(bottom, rect.bottom);\n    }\n\n    return new DOMRect(left, top, right - left, bottom - top);\n  }\n\n  const getAnnotationRects = (id: string): DOMRect[] => {\n    const indexed = index.get(id);\n    if (indexed) {\n      // Reminder: *each* IndexedHighlightRect stores *all*\n      // DOMRects for the annotation for convenience\n      return indexed[0].annotation.rects;\n    } else {\n      return [];\n    }\n  }\n\n  const getIntersecting = (\n    minX: number, \n    minY: number, \n    maxX: number, \n    maxY: number,\n  ): AnnotationRects<T>[] => {\n    // All rects in this area, regardless of annotation\n    const rects = tree.search({ minX, minY, maxX, maxY });\n\n    // Distinct annotation IDs\n    const annotationIds = new Set(rects.map(rect => rect.annotation.id));\n\n    // Resolve annotation IDs. Note that the tree could be slightly out of sync (because \n    // it updates by listening to changes, just like anyone else)\n    return Array.from(annotationIds).map(annotationId => ({\n      annotation: store.getAnnotation(annotationId),\n      rects: getAnnotationRects(annotationId)\n    })).filter(t => Boolean(t.annotation));\n  }\n\n  const size = () => tree.all().length;\n\n  const recalculate = () =>\n    set(store.all().map(a => a.target), true);\n\n  return {\n    all,\n    clear,\n    getAt,\n    getAnnotationBounds,\n    getAnnotationRects,\n    getIntersecting,\n    insert,\n    recalculate,\n    remove,\n    set,\n    size,\n    update\n  }\n\n}\n","import type { Filter, Store, ViewportState, UserSelectActionExpression } from '@annotorious/core';\nimport { \n  createHoverState, \n  createSelectionState, \n  createStore, \n  Origin,\n  createViewportState\n} from '@annotorious/core';\nimport type { \n  AnnotatorState, \n  SelectionState, \n  HoverState, \n} from '@annotorious/core';\nimport { createSpatialTree } from './spatialTree';\nimport type { TextAnnotation, TextAnnotationTarget } from '../model';\nimport type { AnnotationRects, TextAnnotationStore } from './TextAnnotationStore';\nimport { isRevived, reviveAnnotation, reviveTarget } from '../utils';\n\nexport interface TextAnnotatorState<I extends TextAnnotation = TextAnnotation, E extends unknown = TextAnnotation> extends AnnotatorState<I, E> {\n\n  store: TextAnnotationStore<I>;\n\n  selection: SelectionState<I, E>;\n\n  hover: HoverState<I>;\n\n  viewport: ViewportState;\n\n}\n\nexport const createTextAnnotatorState = <I extends TextAnnotation = TextAnnotation, E extends unknown = TextAnnotation>(\n  container: HTMLElement,\n  defaultUserSelectAction?: UserSelectActionExpression<E>\n): TextAnnotatorState<I, E> => {\n\n  const store: Store<I> = createStore<I>();\n\n  const tree = createSpatialTree(store, container);\n\n  // Temporary\n  const selection = createSelectionState<I, E>(store)\n  selection.setUserSelectAction(defaultUserSelectAction);\n\n  const hover = createHoverState(store);\n\n  const viewport = createViewportState();\n\n  // Wrap store interface to intercept annotations and revive DOM ranges, if needed\n  const addAnnotation = (annotation: I, origin = Origin.LOCAL): boolean => {\n    const revived = reviveAnnotation(annotation, container);\n\n    const isValid = isRevived(revived.target.selector);\n    if (isValid)\n      store.addAnnotation(revived, origin); \n\n    return isValid;\n  }\n\n  const bulkAddAnnotation = (\n    annotations: I[], \n    replace = true, \n    origin = Origin.LOCAL\n  ): I[] => {\n    const revived = annotations.map(a => reviveAnnotation<I>(a, container));\n\n    // Initial page load might take some time. Retry for more robustness.\n    const couldNotRevive = revived.filter(a => !isRevived(a.target.selector));\n    store.bulkAddAnnotation(revived, replace, origin);\n\n    return couldNotRevive;\n  }\n  \n  const bulkUpsertAnnotations = (\n    annotations: I[], \n    origin = Origin.LOCAL\n  ): I[] => {\n    const revived = annotations.map(a => reviveAnnotation(a, container));\n\n    // Initial page load might take some time. Retry for more robustness.\n    const couldNotRevive = revived.filter(a => !isRevived(a.target.selector));\n    \n    revived.forEach(a => {\n      if (store.getAnnotation(a.id))\n        store.updateAnnotation(a, origin);\n      else \n        store.addAnnotation(a, origin);\n    })\n\n    return couldNotRevive;\n  }\n\n  const updateTarget = (target: TextAnnotationTarget, origin = Origin.LOCAL) => {\n    const revived = reviveTarget(target, container);\n    store.updateTarget(revived, origin);\n  }\n\n  const bulkUpdateTargets = (targets: TextAnnotationTarget[], origin = Origin.LOCAL) => {\n    const revived = targets.map(t => reviveTarget(t, container));\n    store.bulkUpdateTargets(revived, origin);\n  }\n\n  function getAt(x: number, y: number, all: true, filter?: Filter): I[] | undefined;\n  function getAt(x: number, y: number, all: false, filter?: Filter): I | undefined;\n  function getAt(x: number, y: number, all?: boolean, filter?: Filter): I | I[] | undefined {\n    const getAll = all || Boolean(filter);\n\n    const annotations = tree.getAt(x, y, getAll).map(id => store.getAnnotation(id));\n\n    const filtered = filter ? annotations.filter(filter) : annotations;\n\n    if (filtered.length === 0)\n      return undefined;\n\n    return all ? filtered : filtered[0];\n  }\n\n  const getAnnotationBounds = (id: string): DOMRect | undefined => {\n    const rects = tree.getAnnotationRects(id);\n    if (rects.length === 0) return;\n    return tree.getAnnotationBounds(id);\n  }\n\n  const getIntersecting = (\n    minX: number,\n    minY: number,\n    maxX: number,\n    maxY: number,\n  ): AnnotationRects<I>[] => tree.getIntersecting(minX, minY, maxX, maxY);\n\n  const getAnnotationRects = (id: string): DOMRect[] => tree.getAnnotationRects(id);\n\n  const recalculatePositions = () => tree.recalculate();\n\n  store.observe(({ changes }) => {\n    const deleted = (changes.deleted || []).filter(a => isRevived(a.target.selector));\n    const created = (changes.created || []).filter(a => isRevived(a.target.selector));\n    const updated = (changes.updated || []).filter(u => isRevived(u.newValue.target.selector));\n\n    if (deleted?.length > 0)\n      deleted.forEach(a => tree.remove(a.target));\n\n    if (created.length > 0)\n      tree.set(created.map(a => a.target), false);\n\n    if (updated?.length > 0)\n      updated.forEach(({ newValue }) => tree.update(newValue.target));\n  });\n\n  return {\n    store: {\n      ...store,\n      addAnnotation,\n      bulkAddAnnotation,\n      bulkUpdateTargets,\n      bulkUpsertAnnotations,\n      getAnnotationBounds,\n      getAnnotationRects,\n      getIntersecting,\n      getAt,\n      recalculatePositions,\n      updateTarget\n    },\n    selection,\n    hover,\n    viewport\n  }\n\n}\n","import type { Color, PresenceProvider, PresentUser } from '@annotorious/core';\nimport type { AnnotationRects } from '../state';\nimport type { HighlightStyle, HighlightPainter } from '../highlight';\nimport type { PresencePainterOptions } from '../presence';\nimport type { ViewportBounds } from '../highlight/viewport';\n\nimport './PresencePainter.css';\n\nconst createCanvas = () => {\n  const canvas = document.createElement('canvas');\n\n  // Retina resolution for crisp font rendering\n  canvas.width = 2 * window.innerWidth;\n  canvas.height = 2 * window.innerHeight;\n  canvas.className = 'r6o-presence-layer';\n\n  const context = canvas.getContext('2d');\n  context.scale(2, 2);\n  context.translate(0.5, 0.5);\n\n  return canvas;\n}\n\nexport const createPresencePainter = (\n  provider: PresenceProvider, \n  opts: PresencePainterOptions = {}\n): HighlightPainter => {\n\n  const canvas = createCanvas();\n\n  const ctx = canvas.getContext('2d');\n\n  document.body.appendChild(canvas);\n\n  const trackedAnnotations = new Map<string, PresentUser>();\n\n  const getAnnotationsForUser = (p: PresentUser) =>\n    Array.from(trackedAnnotations.entries())\n      .filter(([id, user]) => user.presenceKey === p.presenceKey)\n      .map(([id, _]) => id);\n\n  provider.on('selectionChange', (p: PresentUser, selection: string[] | null) => {\n    // Remove this user's previous selection\n    const currentIds = getAnnotationsForUser(p);\n    currentIds.forEach(id => trackedAnnotations.delete(id));\n\n    // Set new selection (if any)\n    if (selection)\n      selection.forEach(id => trackedAnnotations.set(id, p));\n  });  \n\n  const clear = () => {\n    const { width, height } = canvas;\n    ctx.clearRect(-0.5, -0.5, width + 1, height + 1);\n  }\n\n  const paint = (\n    highlight: AnnotationRects, \n    viewportBounds: ViewportBounds,\n    isSelected?: boolean\n  ): HighlightStyle | undefined => {\n    if (opts.font)\n      ctx.font = opts.font;\n\n    const user = trackedAnnotations.get(highlight.annotation.id);\n    if (user) {\n      // Draw cursor + label to the presence canvas\n      const { height } = highlight.rects[0];\n      const x = highlight.rects[0].x + viewportBounds.left;\n      const y = highlight.rects[0].y + viewportBounds.top;\n\n      // Draw presence indicator\n      ctx.fillStyle = user.appearance.color;\n      ctx.fillRect(x - 2, y - 2.5, 2, height + 5);\n\n      // Draw name label\n      const metrics = ctx.measureText(user.appearance.label);\n      const labelWidth = metrics.width + 6;\n      const labelHeight = metrics.actualBoundingBoxAscent + metrics.actualBoundingBoxDescent + 8;\n      \n      // Sigh... different between FF and Chrome\n      const paddingBottom = metrics.fontBoundingBoxAscent ? 8 : 6.5;\n\n      ctx.fillRect(x - 2, y - 2.5 - labelHeight, labelWidth, labelHeight);\n      \n      ctx.fillStyle = '#fff';\n      ctx.fillText(user.appearance.label, x + 1, y - paddingBottom);\n\n      // Return modfied style for the renderer\n      return { \n        fill: user.appearance.color as Color,\n        fillOpacity: isSelected ? 0.45 : 0.18\n      }\n    }\n  }\n  \n  const reset = () => {\n    canvas.width = 2 * window.innerWidth;\n    canvas.height = 2 * window.innerHeight;\n\n    // Note that resizing the canvas resets the context\n    const context = canvas.getContext('2d');\n    context.scale(2, 2);\n    context.translate(0.5, 0.5);\n  }\n\n  const destroy = () => {\n    canvas.remove();\n  }\n\n  return {\n    clear,\n    destroy,\n    paint,\n    reset\n  }\n  \n}\n","/**! \n * hotkeys-js v3.13.9 \n * A simple micro-library for defining and dispatching keyboard shortcuts. It has no dependencies. \n * \n * Copyright (c) 2024 kenny wong <wowohoo@qq.com> \n * https://github.com/jaywcjlove/hotkeys-js.git \n * \n * @website: https://jaywcjlove.github.io/hotkeys-js\n \n * Licensed under the MIT license \n */\n\nconst isff = typeof navigator !== 'undefined' ? navigator.userAgent.toLowerCase().indexOf('firefox') > 0 : false;\n\n// 绑定事件\nfunction addEvent(object, event, method, useCapture) {\n  if (object.addEventListener) {\n    object.addEventListener(event, method, useCapture);\n  } else if (object.attachEvent) {\n    object.attachEvent(\"on\".concat(event), method);\n  }\n}\nfunction removeEvent(object, event, method, useCapture) {\n  if (object.removeEventListener) {\n    object.removeEventListener(event, method, useCapture);\n  } else if (object.detachEvent) {\n    object.detachEvent(\"on\".concat(event), method);\n  }\n}\n\n// 修饰键转换成对应的键码\nfunction getMods(modifier, key) {\n  const mods = key.slice(0, key.length - 1);\n  for (let i = 0; i < mods.length; i++) mods[i] = modifier[mods[i].toLowerCase()];\n  return mods;\n}\n\n// 处理传的key字符串转换成数组\nfunction getKeys(key) {\n  if (typeof key !== 'string') key = '';\n  key = key.replace(/\\s/g, ''); // 匹配任何空白字符,包括空格、制表符、换页符等等\n  const keys = key.split(','); // 同时设置多个快捷键，以','分割\n  let index = keys.lastIndexOf('');\n\n  // 快捷键可能包含','，需特殊处理\n  for (; index >= 0;) {\n    keys[index - 1] += ',';\n    keys.splice(index, 1);\n    index = keys.lastIndexOf('');\n  }\n  return keys;\n}\n\n// 比较修饰键的数组\nfunction compareArray(a1, a2) {\n  const arr1 = a1.length >= a2.length ? a1 : a2;\n  const arr2 = a1.length >= a2.length ? a2 : a1;\n  let isIndex = true;\n  for (let i = 0; i < arr1.length; i++) {\n    if (arr2.indexOf(arr1[i]) === -1) isIndex = false;\n  }\n  return isIndex;\n}\n\n// Special Keys\nconst _keyMap = {\n  backspace: 8,\n  '⌫': 8,\n  tab: 9,\n  clear: 12,\n  enter: 13,\n  '↩': 13,\n  return: 13,\n  esc: 27,\n  escape: 27,\n  space: 32,\n  left: 37,\n  up: 38,\n  right: 39,\n  down: 40,\n  del: 46,\n  delete: 46,\n  ins: 45,\n  insert: 45,\n  home: 36,\n  end: 35,\n  pageup: 33,\n  pagedown: 34,\n  capslock: 20,\n  num_0: 96,\n  num_1: 97,\n  num_2: 98,\n  num_3: 99,\n  num_4: 100,\n  num_5: 101,\n  num_6: 102,\n  num_7: 103,\n  num_8: 104,\n  num_9: 105,\n  num_multiply: 106,\n  num_add: 107,\n  num_enter: 108,\n  num_subtract: 109,\n  num_decimal: 110,\n  num_divide: 111,\n  '⇪': 20,\n  ',': 188,\n  '.': 190,\n  '/': 191,\n  '`': 192,\n  '-': isff ? 173 : 189,\n  '=': isff ? 61 : 187,\n  ';': isff ? 59 : 186,\n  '\\'': 222,\n  '[': 219,\n  ']': 221,\n  '\\\\': 220\n};\n\n// Modifier Keys\nconst _modifier = {\n  // shiftKey\n  '⇧': 16,\n  shift: 16,\n  // altKey\n  '⌥': 18,\n  alt: 18,\n  option: 18,\n  // ctrlKey\n  '⌃': 17,\n  ctrl: 17,\n  control: 17,\n  // metaKey\n  '⌘': 91,\n  cmd: 91,\n  command: 91\n};\nconst modifierMap = {\n  16: 'shiftKey',\n  18: 'altKey',\n  17: 'ctrlKey',\n  91: 'metaKey',\n  shiftKey: 16,\n  ctrlKey: 17,\n  altKey: 18,\n  metaKey: 91\n};\nconst _mods = {\n  16: false,\n  18: false,\n  17: false,\n  91: false\n};\nconst _handlers = {};\n\n// F1~F12 special key\nfor (let k = 1; k < 20; k++) {\n  _keyMap[\"f\".concat(k)] = 111 + k;\n}\n\nlet _downKeys = []; // 记录摁下的绑定键\nlet winListendFocus = null; // window是否已经监听了focus事件\nlet _scope = 'all'; // 默认热键范围\nconst elementEventMap = new Map(); // 已绑定事件的节点记录\n\n// 返回键码\nconst code = x => _keyMap[x.toLowerCase()] || _modifier[x.toLowerCase()] || x.toUpperCase().charCodeAt(0);\nconst getKey = x => Object.keys(_keyMap).find(k => _keyMap[k] === x);\nconst getModifier = x => Object.keys(_modifier).find(k => _modifier[k] === x);\n\n// 设置获取当前范围（默认为'所有'）\nfunction setScope(scope) {\n  _scope = scope || 'all';\n}\n// 获取当前范围\nfunction getScope() {\n  return _scope || 'all';\n}\n// 获取摁下绑定键的键值\nfunction getPressedKeyCodes() {\n  return _downKeys.slice(0);\n}\nfunction getPressedKeyString() {\n  return _downKeys.map(c => getKey(c) || getModifier(c) || String.fromCharCode(c));\n}\nfunction getAllKeyCodes() {\n  const result = [];\n  Object.keys(_handlers).forEach(k => {\n    _handlers[k].forEach(_ref => {\n      let {\n        key,\n        scope,\n        mods,\n        shortcut\n      } = _ref;\n      result.push({\n        scope,\n        shortcut,\n        mods,\n        keys: key.split('+').map(v => code(v))\n      });\n    });\n  });\n  return result;\n}\n\n// 表单控件控件判断 返回 Boolean\n// hotkey is effective only when filter return true\nfunction filter(event) {\n  const target = event.target || event.srcElement;\n  const {\n    tagName\n  } = target;\n  let flag = true;\n  const isInput = tagName === 'INPUT' && !['checkbox', 'radio', 'range', 'button', 'file', 'reset', 'submit', 'color'].includes(target.type);\n  // ignore: isContentEditable === 'true', <input> and <textarea> when readOnly state is false, <select>\n  if (target.isContentEditable || (isInput || tagName === 'TEXTAREA' || tagName === 'SELECT') && !target.readOnly) {\n    flag = false;\n  }\n  return flag;\n}\n\n// 判断摁下的键是否为某个键，返回true或者false\nfunction isPressed(keyCode) {\n  if (typeof keyCode === 'string') {\n    keyCode = code(keyCode); // 转换成键码\n  }\n  return _downKeys.indexOf(keyCode) !== -1;\n}\n\n// 循环删除handlers中的所有 scope(范围)\nfunction deleteScope(scope, newScope) {\n  let handlers;\n  let i;\n\n  // 没有指定scope，获取scope\n  if (!scope) scope = getScope();\n  for (const key in _handlers) {\n    if (Object.prototype.hasOwnProperty.call(_handlers, key)) {\n      handlers = _handlers[key];\n      for (i = 0; i < handlers.length;) {\n        if (handlers[i].scope === scope) {\n          const deleteItems = handlers.splice(i, 1);\n          deleteItems.forEach(_ref2 => {\n            let {\n              element\n            } = _ref2;\n            return removeKeyEvent(element);\n          });\n        } else {\n          i++;\n        }\n      }\n    }\n  }\n\n  // 如果scope被删除，将scope重置为all\n  if (getScope() === scope) setScope(newScope || 'all');\n}\n\n// 清除修饰键\nfunction clearModifier(event) {\n  let key = event.keyCode || event.which || event.charCode;\n  const i = _downKeys.indexOf(key);\n\n  // 从列表中清除按压过的键\n  if (i >= 0) {\n    _downKeys.splice(i, 1);\n  }\n  // 特殊处理 cmmand 键，在 cmmand 组合快捷键 keyup 只执行一次的问题\n  if (event.key && event.key.toLowerCase() === 'meta') {\n    _downKeys.splice(0, _downKeys.length);\n  }\n\n  // 修饰键 shiftKey altKey ctrlKey (command||metaKey) 清除\n  if (key === 93 || key === 224) key = 91;\n  if (key in _mods) {\n    _mods[key] = false;\n\n    // 将修饰键重置为false\n    for (const k in _modifier) if (_modifier[k] === key) hotkeys[k] = false;\n  }\n}\nfunction unbind(keysInfo) {\n  // unbind(), unbind all keys\n  if (typeof keysInfo === 'undefined') {\n    Object.keys(_handlers).forEach(key => {\n      Array.isArray(_handlers[key]) && _handlers[key].forEach(info => eachUnbind(info));\n      delete _handlers[key];\n    });\n    removeKeyEvent(null);\n  } else if (Array.isArray(keysInfo)) {\n    // support like : unbind([{key: 'ctrl+a', scope: 's1'}, {key: 'ctrl-a', scope: 's2', splitKey: '-'}])\n    keysInfo.forEach(info => {\n      if (info.key) eachUnbind(info);\n    });\n  } else if (typeof keysInfo === 'object') {\n    // support like unbind({key: 'ctrl+a, ctrl+b', scope:'abc'})\n    if (keysInfo.key) eachUnbind(keysInfo);\n  } else if (typeof keysInfo === 'string') {\n    for (var _len = arguments.length, args = new Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {\n      args[_key - 1] = arguments[_key];\n    }\n    // support old method\n    // eslint-disable-line\n    let [scope, method] = args;\n    if (typeof scope === 'function') {\n      method = scope;\n      scope = '';\n    }\n    eachUnbind({\n      key: keysInfo,\n      scope,\n      method,\n      splitKey: '+'\n    });\n  }\n}\n\n// 解除绑定某个范围的快捷键\nconst eachUnbind = _ref3 => {\n  let {\n    key,\n    scope,\n    method,\n    splitKey = '+'\n  } = _ref3;\n  const multipleKeys = getKeys(key);\n  multipleKeys.forEach(originKey => {\n    const unbindKeys = originKey.split(splitKey);\n    const len = unbindKeys.length;\n    const lastKey = unbindKeys[len - 1];\n    const keyCode = lastKey === '*' ? '*' : code(lastKey);\n    if (!_handlers[keyCode]) return;\n    // 判断是否传入范围，没有就获取范围\n    if (!scope) scope = getScope();\n    const mods = len > 1 ? getMods(_modifier, unbindKeys) : [];\n    const unbindElements = [];\n    _handlers[keyCode] = _handlers[keyCode].filter(record => {\n      // 通过函数判断，是否解除绑定，函数相等直接返回\n      const isMatchingMethod = method ? record.method === method : true;\n      const isUnbind = isMatchingMethod && record.scope === scope && compareArray(record.mods, mods);\n      if (isUnbind) unbindElements.push(record.element);\n      return !isUnbind;\n    });\n    unbindElements.forEach(element => removeKeyEvent(element));\n  });\n};\n\n// 对监听对应快捷键的回调函数进行处理\nfunction eventHandler(event, handler, scope, element) {\n  if (handler.element !== element) {\n    return;\n  }\n  let modifiersMatch;\n\n  // 看它是否在当前范围\n  if (handler.scope === scope || handler.scope === 'all') {\n    // 检查是否匹配修饰符（如果有返回true）\n    modifiersMatch = handler.mods.length > 0;\n    for (const y in _mods) {\n      if (Object.prototype.hasOwnProperty.call(_mods, y)) {\n        if (!_mods[y] && handler.mods.indexOf(+y) > -1 || _mods[y] && handler.mods.indexOf(+y) === -1) {\n          modifiersMatch = false;\n        }\n      }\n    }\n\n    // 调用处理程序，如果是修饰键不做处理\n    if (handler.mods.length === 0 && !_mods[16] && !_mods[18] && !_mods[17] && !_mods[91] || modifiersMatch || handler.shortcut === '*') {\n      handler.keys = [];\n      handler.keys = handler.keys.concat(_downKeys);\n      if (handler.method(event, handler) === false) {\n        if (event.preventDefault) event.preventDefault();else event.returnValue = false;\n        if (event.stopPropagation) event.stopPropagation();\n        if (event.cancelBubble) event.cancelBubble = true;\n      }\n    }\n  }\n}\n\n// 处理keydown事件\nfunction dispatch(event, element) {\n  const asterisk = _handlers['*'];\n  let key = event.keyCode || event.which || event.charCode;\n\n  // 表单控件过滤 默认表单控件不触发快捷键\n  if (!hotkeys.filter.call(this, event)) return;\n\n  // Gecko(Firefox)的command键值224，在Webkit(Chrome)中保持一致\n  // Webkit左右 command 键值不一样\n  if (key === 93 || key === 224) key = 91;\n\n  /**\n   * Collect bound keys\n   * If an Input Method Editor is processing key input and the event is keydown, return 229.\n   * https://stackoverflow.com/questions/25043934/is-it-ok-to-ignore-keydown-events-with-keycode-229\n   * http://lists.w3.org/Archives/Public/www-dom/2010JulSep/att-0182/keyCode-spec.html\n   */\n  if (_downKeys.indexOf(key) === -1 && key !== 229) _downKeys.push(key);\n  /**\n   * Jest test cases are required.\n   * ===============================\n   */\n  ['metaKey', 'ctrlKey', 'altKey', 'shiftKey'].forEach(keyName => {\n    const keyNum = modifierMap[keyName];\n    if (event[keyName] && _downKeys.indexOf(keyNum) === -1) {\n      _downKeys.push(keyNum);\n    } else if (!event[keyName] && _downKeys.indexOf(keyNum) > -1) {\n      _downKeys.splice(_downKeys.indexOf(keyNum), 1);\n    } else if (keyName === 'metaKey' && event[keyName]) {\n      // 如果command被按下，那就清空所有除event按键外的非装饰键。\n      // 因为command被按下的情况下非装饰键的keyup永远都不会触发。这是已知的浏览器限制。\n      // If command key is pressed, clear all non-decorating keys except for key in event.\n      // This is because keyup for a non-decorating key will NEVER be triggered when command is pressed.\n      // This is a known browser limitation.\n      _downKeys = _downKeys.filter(k => k in modifierMap || k === key);\n    }\n  });\n  /**\n   * -------------------------------\n   */\n\n  if (key in _mods) {\n    _mods[key] = true;\n\n    // 将特殊字符的key注册到 hotkeys 上\n    for (const k in _modifier) {\n      if (_modifier[k] === key) hotkeys[k] = true;\n    }\n    if (!asterisk) return;\n  }\n\n  // 将 modifierMap 里面的修饰键绑定到 event 中\n  for (const e in _mods) {\n    if (Object.prototype.hasOwnProperty.call(_mods, e)) {\n      _mods[e] = event[modifierMap[e]];\n    }\n  }\n  /**\n   * https://github.com/jaywcjlove/hotkeys/pull/129\n   * This solves the issue in Firefox on Windows where hotkeys corresponding to special characters would not trigger.\n   * An example of this is ctrl+alt+m on a Swedish keyboard which is used to type μ.\n   * Browser support: https://caniuse.com/#feat=keyboardevent-getmodifierstate\n   */\n  if (event.getModifierState && !(event.altKey && !event.ctrlKey) && event.getModifierState('AltGraph')) {\n    if (_downKeys.indexOf(17) === -1) {\n      _downKeys.push(17);\n    }\n    if (_downKeys.indexOf(18) === -1) {\n      _downKeys.push(18);\n    }\n    _mods[17] = true;\n    _mods[18] = true;\n  }\n\n  // 获取范围 默认为 `all`\n  const scope = getScope();\n  // 对任何快捷键都需要做的处理\n  if (asterisk) {\n    for (let i = 0; i < asterisk.length; i++) {\n      if (asterisk[i].scope === scope && (event.type === 'keydown' && asterisk[i].keydown || event.type === 'keyup' && asterisk[i].keyup)) {\n        eventHandler(event, asterisk[i], scope, element);\n      }\n    }\n  }\n  // key 不在 _handlers 中返回\n  if (!(key in _handlers)) return;\n  const handlerKey = _handlers[key];\n  const keyLen = handlerKey.length;\n  for (let i = 0; i < keyLen; i++) {\n    if (event.type === 'keydown' && handlerKey[i].keydown || event.type === 'keyup' && handlerKey[i].keyup) {\n      if (handlerKey[i].key) {\n        const record = handlerKey[i];\n        const {\n          splitKey\n        } = record;\n        const keyShortcut = record.key.split(splitKey);\n        const _downKeysCurrent = []; // 记录当前按键键值\n        for (let a = 0; a < keyShortcut.length; a++) {\n          _downKeysCurrent.push(code(keyShortcut[a]));\n        }\n        if (_downKeysCurrent.sort().join('') === _downKeys.sort().join('')) {\n          // 找到处理内容\n          eventHandler(event, record, scope, element);\n        }\n      }\n    }\n  }\n}\nfunction hotkeys(key, option, method) {\n  _downKeys = [];\n  const keys = getKeys(key); // 需要处理的快捷键列表\n  let mods = [];\n  let scope = 'all'; // scope默认为all，所有范围都有效\n  let element = document; // 快捷键事件绑定节点\n  let i = 0;\n  let keyup = false;\n  let keydown = true;\n  let splitKey = '+';\n  let capture = false;\n  let single = false; // 单个callback\n\n  // 对为设定范围的判断\n  if (method === undefined && typeof option === 'function') {\n    method = option;\n  }\n  if (Object.prototype.toString.call(option) === '[object Object]') {\n    if (option.scope) scope = option.scope; // eslint-disable-line\n    if (option.element) element = option.element; // eslint-disable-line\n    if (option.keyup) keyup = option.keyup; // eslint-disable-line\n    if (option.keydown !== undefined) keydown = option.keydown; // eslint-disable-line\n    if (option.capture !== undefined) capture = option.capture; // eslint-disable-line\n    if (typeof option.splitKey === 'string') splitKey = option.splitKey; // eslint-disable-line\n    if (option.single === true) single = true; // eslint-disable-line\n  }\n  if (typeof option === 'string') scope = option;\n\n  // 如果只允许单个callback，先unbind\n  if (single) unbind(key, scope);\n\n  // 对于每个快捷键进行处理\n  for (; i < keys.length; i++) {\n    key = keys[i].split(splitKey); // 按键列表\n    mods = [];\n\n    // 如果是组合快捷键取得组合快捷键\n    if (key.length > 1) mods = getMods(_modifier, key);\n\n    // 将非修饰键转化为键码\n    key = key[key.length - 1];\n    key = key === '*' ? '*' : code(key); // *表示匹配所有快捷键\n\n    // 判断key是否在_handlers中，不在就赋一个空数组\n    if (!(key in _handlers)) _handlers[key] = [];\n    _handlers[key].push({\n      keyup,\n      keydown,\n      scope,\n      mods,\n      shortcut: keys[i],\n      method,\n      key: keys[i],\n      splitKey,\n      element\n    });\n  }\n  // 在全局document上设置快捷键\n  if (typeof element !== 'undefined' && window) {\n    if (!elementEventMap.has(element)) {\n      const keydownListener = function () {\n        let event = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : window.event;\n        return dispatch(event, element);\n      };\n      const keyupListenr = function () {\n        let event = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : window.event;\n        dispatch(event, element);\n        clearModifier(event);\n      };\n      elementEventMap.set(element, {\n        keydownListener,\n        keyupListenr,\n        capture\n      });\n      addEvent(element, 'keydown', keydownListener, capture);\n      addEvent(element, 'keyup', keyupListenr, capture);\n    }\n    if (!winListendFocus) {\n      const listener = () => {\n        _downKeys = [];\n      };\n      winListendFocus = {\n        listener,\n        capture\n      };\n      addEvent(window, 'focus', listener, capture);\n    }\n  }\n}\nfunction trigger(shortcut) {\n  let scope = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 'all';\n  Object.keys(_handlers).forEach(key => {\n    const dataList = _handlers[key].filter(item => item.scope === scope && item.shortcut === shortcut);\n    dataList.forEach(data => {\n      if (data && data.method) {\n        data.method();\n      }\n    });\n  });\n}\n\n// 销毁事件,unbind之后判断element上是否还有键盘快捷键，如果没有移除监听\nfunction removeKeyEvent(element) {\n  const values = Object.values(_handlers).flat();\n  const findindex = values.findIndex(_ref4 => {\n    let {\n      element: el\n    } = _ref4;\n    return el === element;\n  });\n  if (findindex < 0) {\n    const {\n      keydownListener,\n      keyupListenr,\n      capture\n    } = elementEventMap.get(element) || {};\n    if (keydownListener && keyupListenr) {\n      removeEvent(element, 'keyup', keyupListenr, capture);\n      removeEvent(element, 'keydown', keydownListener, capture);\n      elementEventMap.delete(element);\n    }\n  }\n  if (values.length <= 0 || elementEventMap.size <= 0) {\n    // 移除所有的元素上的监听\n    const eventKeys = Object.keys(elementEventMap);\n    eventKeys.forEach(el => {\n      const {\n        keydownListener,\n        keyupListenr,\n        capture\n      } = elementEventMap.get(el) || {};\n      if (keydownListener && keyupListenr) {\n        removeEvent(el, 'keyup', keyupListenr, capture);\n        removeEvent(el, 'keydown', keydownListener, capture);\n        elementEventMap.delete(el);\n      }\n    });\n    // 清空 elementEventMap\n    elementEventMap.clear();\n    // 清空 _handlers\n    Object.keys(_handlers).forEach(key => delete _handlers[key]);\n    // 移除window上的focus监听\n    if (winListendFocus) {\n      const {\n        listener,\n        capture\n      } = winListendFocus;\n      removeEvent(window, 'focus', listener, capture);\n      winListendFocus = null;\n    }\n  }\n}\nconst _api = {\n  getPressedKeyString,\n  setScope,\n  getScope,\n  deleteScope,\n  getPressedKeyCodes,\n  getAllKeyCodes,\n  isPressed,\n  filter,\n  trigger,\n  unbind,\n  keyMap: _keyMap,\n  modifier: _modifier,\n  modifierMap\n};\nfor (const a in _api) {\n  if (Object.prototype.hasOwnProperty.call(_api, a)) {\n    hotkeys[a] = _api[a];\n  }\n}\nif (typeof window !== 'undefined') {\n  const _hotkeys = window.hotkeys;\n  hotkeys.noConflict = deep => {\n    if (deep && window.hotkeys === hotkeys) {\n      window.hotkeys = _hotkeys;\n    }\n    return hotkeys;\n  };\n  window.hotkeys = hotkeys;\n}\n\nexport { hotkeys as default };\n","import { Origin } from '@annotorious/core';\nimport type { Filter, Selection, User } from '@annotorious/core';\nimport { v4 as uuidv4 } from 'uuid';\nimport hotkeys from 'hotkeys-js';\nimport type { TextAnnotatorState } from './state';\nimport type { TextAnnotation, TextAnnotationTarget } from './model';\nimport type { TextAnnotatorOptions } from './TextAnnotatorOptions';\nimport {\n  clonePointerEvent,\n  cloneKeyboardEvent,\n  debounce,\n  splitAnnotatableRanges,\n  rangeToSelector,\n  isMac,\n  isWhitespaceOrEmpty,\n  trimRangeToContainer,\n  isNotAnnotatable\n} from './utils';\n\nconst CLICK_TIMEOUT = 300;\n\nconst ARROW_KEYS = ['up', 'down', 'left', 'right'];\n\nconst SELECT_ALL = isMac ? '⌘+a' :  'ctrl+a';\n\nconst SELECTION_KEYS = [\n  ...ARROW_KEYS.map(key => `shift+${key}`),\n  SELECT_ALL\n];\n\nexport const SelectionHandler = (\n  container: HTMLElement,\n  state: TextAnnotatorState<TextAnnotation, unknown>,\n  options: TextAnnotatorOptions<TextAnnotation, unknown>\n) => {\n\n  let currentUser: User | undefined;\n\n  const { annotatingEnabled, offsetReferenceSelector, selectionMode } = options;\n\n  const setUser = (user?: User) => currentUser = user;\n\n  let currentFilter: Filter | undefined;\n\n  const setFilter = (filter?: Filter) => currentFilter = filter;\n\n  const { store, selection } = state;\n\n  let currentTarget: TextAnnotationTarget | undefined;\n\n  let isLeftClick: boolean | undefined;\n\n  let lastDownEvent: Selection['event'] | undefined;\n\n  const onSelectStart = (evt: Event) => {\n    if (isLeftClick === false)\n      return;\n\n    /**\n     * Make sure we don't listen to selection changes that were\n     * not started on the container, or which are not supposed to\n     * be annotatable (like a component popup).\n     * Note that Chrome/iOS will sometimes return the root doc as target!\n     */\n    currentTarget = isNotAnnotatable(evt.target as Node)\n      ? undefined\n      : {\n        annotation: uuidv4(),\n        selector: [],\n        creator: currentUser,\n        created: new Date()\n      };\n  };\n\n  const onSelectionChange = debounce((evt: Event) => {\n    const sel = document.getSelection();\n\n    /**\n     * In iOS when a user clicks on a button, the `selectionchange` event is fired.\n     * However, the generated selection is empty and the `anchorNode` is `null`.\n     * That doesn't give us information about whether the selection is in the annotatable area\n     * or whether the previously selected text was dismissed.\n     * Therefore - we should bail out from such a range processing.\n     *\n     * @see https://github.com/recogito/text-annotator-js/pull/164#issuecomment-2416961473\n     */\n    if (!sel?.anchorNode) {\n      return;\n    }\n\n    /**\n     * This is to handle cases where the selection is \"hijacked\"\n     * by another element in a not-annotatable area.\n     * A rare case in theory.\n     * But rich text editors will like Quill do it.\n     */\n    if (isNotAnnotatable(sel.anchorNode)) {\n      currentTarget = undefined;\n      return;\n    }\n\n    const timeDifference = evt.timeStamp - (lastDownEvent?.timeStamp || evt.timeStamp);\n\n    /**\n     * The selection start needs to be emulated only for the pointer events!\n     * The keyboard ones are consistently fired on desktops\n     * and the `timeDifference` will always be <10ms. between the `keydown` and `selectionchange`\n     */\n    if (lastDownEvent?.type === 'pointerdown') {\n      if (timeDifference < 1000 && !currentTarget) {\n\n        // Chrome/iOS does not reliably fire the 'selectstart' event!\n        onSelectStart(lastDownEvent || evt);\n      } else if (sel.isCollapsed && timeDifference < CLICK_TIMEOUT) {\n\n        // Firefox doesn't fire the 'selectstart' when user clicks\n        // over the text, which collapses the selection\n        onSelectStart(lastDownEvent || evt);\n      }\n    }\n\n    // The selection isn't active -> bail out from selection change processing\n    if (!currentTarget) return;\n\n    if (sel.isCollapsed) {\n      /**\n       * The selection range got collapsed during the selecting process.\n       * The previously created annotation isn't relevant anymore and can be discarded\n       *\n       * @see https://github.com/recogito/text-annotator-js/issues/139\n       */\n      if (store.getAnnotation(currentTarget.annotation)) {\n        selection.clear();\n        store.deleteAnnotation(currentTarget.annotation);\n      }\n\n      return;\n    }\n\n    const selectionRange = sel.getRangeAt(0);\n\n    // The selection should be captured only within the annotatable container\n    const containedRange = trimRangeToContainer(selectionRange, container);\n    if (isWhitespaceOrEmpty(containedRange)) return;\n\n    const annotatableRanges = splitAnnotatableRanges(containedRange.cloneRange());\n\n    const hasChanged =\n      annotatableRanges.length !== currentTarget.selector.length ||\n      annotatableRanges.some((r, i) => r.toString() !== currentTarget.selector[i]?.quote);\n    if (!hasChanged) return;\n\n    currentTarget = {\n      ...currentTarget,\n      selector: annotatableRanges.map(r => rangeToSelector(r, container, offsetReferenceSelector)),\n      updated: new Date()\n    };\n\n    /**\n     * During mouse selection on the desktop, the annotation won't usually exist while the selection is being edited.\n     * But it'll be typical during selection via the keyboard or mobile's handlebars.\n     */\n    if (store.getAnnotation(currentTarget.annotation)) {\n      store.updateTarget(currentTarget, Origin.LOCAL);\n    } else {\n      // Proper lifecycle management: clear the previous selection first...\n      selection.clear();\n    }\n  });\n\n  /**\n   * Select events don't carry information about the mouse button.\n   * Therefore, to prevent right-click selection, we need to listen\n   * to the initial pointerdown event and remember the button\n   */\n  const onPointerDown = (evt: PointerEvent) => {\n    if (isNotAnnotatable(evt.target as Node)) return;\n\n    /**\n     * Cloning the event to prevent it from accidentally being `undefined`\n     * @see https://github.com/recogito/text-annotator-js/commit/65d13f3108c429311cf8c2523f6babbbc946013d#r144033948\n     */\n    lastDownEvent = clonePointerEvent(evt);\n    isLeftClick = lastDownEvent.button === 0;\n  };\n\n  const onPointerUp = (evt: PointerEvent) => {\n    if (isNotAnnotatable(evt.target as Node) || !isLeftClick) return;\n\n    // Logic for selecting an existing annotation\n    const clickSelect = () => {\n      const { x, y } = container.getBoundingClientRect();\n\n      const hovered =\n        evt.target instanceof Node &&\n        container.contains(evt.target) &&\n        store.getAt(evt.clientX - x, evt.clientY - y, selectionMode === 'all', currentFilter);\n\n      if (hovered) {\n        const { selected } = selection;\n\n        const currentIds = new Set(selected.map(s => s.id));\n        const nextIds = Array.isArray(hovered) ? hovered.map(a => a.id) : [hovered.id];\n\n        const hasChanged =\n          currentIds.size !== nextIds.length ||\n          !nextIds.every(id => currentIds.has(id));\n\n        if (hasChanged)\n          selection.userSelect(nextIds, evt);\n      } else {\n        selection.clear();\n      }\n    };\n\n    const timeDifference = evt.timeStamp - lastDownEvent.timeStamp;\n\n    /**\n     * We must check the `isCollapsed` within the 0-timeout\n     * to handle the annotation dismissal after a click properly.\n     *\n     * Otherwise, the `isCollapsed` will return an obsolete `false` value,\n     * click won't be processed, and the annotation will get falsely re-selected.\n     *\n     * @see https://github.com/recogito/text-annotator-js/issues/136\n     */\n    setTimeout(() => {\n      const sel = document.getSelection();\n\n      // Just a click, not a selection\n      if (sel?.isCollapsed && timeDifference < CLICK_TIMEOUT) {\n        currentTarget = undefined;\n        clickSelect();\n      } else if (currentTarget && currentTarget.selector.length > 0) {\n        upsertCurrentTarget();\n        selection.userSelect(currentTarget.annotation, clonePointerEvent(evt));\n      }\n    });\n  }\n\n  const onContextMenu = (evt: PointerEvent) => {\n    const sel = document.getSelection();\n\n    if (sel?.isCollapsed) return;\n\n    // When selecting the initial word, Chrome Android fires `contextmenu` \n    // before selectionChanged.\n    if (!currentTarget || currentTarget.selector.length === 0) {\n      onSelectionChange(evt);\n    }\n    \n    upsertCurrentTarget();\n\n    selection.userSelect(currentTarget.annotation, clonePointerEvent(evt));\n  }\n\n  const onKeyup = (evt: KeyboardEvent) => {\n    if (evt.key === 'Shift' && currentTarget) {\n      const sel = document.getSelection();\n\n      if (!sel.isCollapsed) {\n        upsertCurrentTarget();\n        selection.userSelect(currentTarget.annotation, cloneKeyboardEvent(evt));\n      }\n    }\n  }\n\n  const onSelectAll = (evt: KeyboardEvent) => {\n\n    const onSelected = () => setTimeout(() => {\n      if (currentTarget?.selector.length > 0) {\n        selection.clear();\n\n        store.addAnnotation({\n          id: currentTarget.annotation,\n          bodies: [],\n          target: currentTarget\n        });\n\n        selection.userSelect(currentTarget.annotation, cloneKeyboardEvent(evt));\n      }\n\n      document.removeEventListener('selectionchange', onSelected);\n\n      // Sigh... this needs a delay to work. But doesn't seem reliable.\n    }, 100);\n\n    // Listen to the change event that follows\n    document.addEventListener('selectionchange', onSelected);\n\n    // Start selection!\n    onSelectStart(evt);\n  }\n\n  hotkeys(SELECTION_KEYS.join(','), { element: container, keydown: true, keyup: false }, evt => {\n    if (!evt.repeat)\n      lastDownEvent = cloneKeyboardEvent(evt);\n  });\n\n  hotkeys(SELECT_ALL, { keydown: true, keyup: false}, evt => {\n    lastDownEvent = cloneKeyboardEvent(evt);\n    onSelectAll(evt);\n  });\n\n  /**\n   * Free caret movement through the text resets the annotation selection.\n   *\n   * It should be handled only on:\n   * - the annotatable `container`, where the text is.\n   * - the `body`, where the focus goes when user closes the popup,\n   *   or clicks the button that gets unmounted, e.g. \"Close\"\n   */\n  const handleArrowKeyPress = (evt: KeyboardEvent) => {\n    if (\n      evt.repeat ||\n      evt.target !== container && evt.target !== document.body\n    ) {\n      return;\n    }\n\n    currentTarget = undefined;\n    selection.clear();\n  };\n\n  hotkeys(ARROW_KEYS.join(','), { keydown: true, keyup: false }, handleArrowKeyPress);\n\n  // Helper\n  const upsertCurrentTarget = () => {\n    const existingAnnotation = store.getAnnotation(currentTarget.annotation);\n    if (!existingAnnotation) {\n      store.addAnnotation({\n        id: currentTarget.annotation,\n        bodies: [],\n        target: currentTarget\n      });\n      return;\n    }\n\n    const { target: { updated: existingTargetUpdated } } = existingAnnotation;\n    const { updated: currentTargetUpdated } = currentTarget;\n    if (\n      !existingTargetUpdated ||\n      !currentTargetUpdated ||\n      existingTargetUpdated < currentTargetUpdated\n    ) {\n      store.updateTarget(currentTarget);\n    }\n  };\n\n  container.addEventListener('pointerdown', onPointerDown);\n  document.addEventListener('pointerup', onPointerUp);\n  document.addEventListener('contextmenu', onContextMenu);\n\n  if (annotatingEnabled) {\n    container.addEventListener('keyup', onKeyup);\n    container.addEventListener('selectstart', onSelectStart);\n    document.addEventListener('selectionchange', onSelectionChange);\n  }\n\n  const destroy = () => {\n    container.removeEventListener('pointerdown', onPointerDown);\n    document.removeEventListener('pointerup', onPointerUp);\n    document.removeEventListener('contextmenu', onContextMenu);\n\n    container.removeEventListener('keyup', onKeyup);\n    container.removeEventListener('selectstart', onSelectStart);\n    document.removeEventListener('selectionchange', onSelectionChange);\n\n    hotkeys.unbind();\n  };\n\n  return {\n    destroy,\n    setFilter,\n    setUser\n  }\n\n}\n\n","import type { FormatAdapter, UserSelectActionExpression, User, Annotation } from '@annotorious/core';\nimport type { PresencePainterOptions } from './presence';\nimport type { TextAnnotation } from './model';\nimport type { HighlightStyleExpression } from './highlight';\n\nexport interface TextAnnotatorOptions<I extends TextAnnotation = TextAnnotation, E extends unknown = TextAnnotation> {\n\n  adapter?: FormatAdapter<I, E> | null;\n\n  annotatingEnabled?: boolean;\n\n  renderer?: RendererType;\n\n  offsetReferenceSelector?: string;\n\n  userSelectAction?: UserSelectActionExpression<E>,\n\n  presence?: PresencePainterOptions;\n\n  selectionMode?: 'shortest' | 'all';\n\n  style?: HighlightStyleExpression;\n\n  user?: User;\n  \n}\n\nexport type RendererType = 'SPANS' | 'CANVAS' | 'CSS_HIGHLIGHTS';\n\nexport const fillDefaults = <I extends TextAnnotation = TextAnnotation, E extends unknown = TextAnnotation>(\n  opts: TextAnnotatorOptions<I, E>,\n  defaults: TextAnnotatorOptions<I, E>\n): TextAnnotatorOptions<I, E> => {\n\n  return {\n    ...opts,\n    annotatingEnabled: opts.annotatingEnabled ?? defaults.annotatingEnabled,\n    user: opts.user || defaults.user\n  };\n\n};\n","import { createAnonymousGuest, createLifecycleObserver, createBaseAnnotator, createUndoStack } from '@annotorious/core';\nimport type { Filter } from '@annotorious/core';\nimport type { Annotator, User, PresenceProvider } from '@annotorious/core';\nimport { createCanvasRenderer, createHighlightsRenderer, createSpansRenderer, type HighlightStyleExpression } from './highlight';\nimport { createPresencePainter } from './presence';\nimport { scrollIntoView } from './api';\nimport { type TextAnnotationStore, type TextAnnotatorState, createTextAnnotatorState } from './state';\nimport type { TextAnnotation } from './model';\nimport { cancelSingleClickEvents, programmaticallyFocusable } from './utils';\nimport { fillDefaults, type RendererType, type TextAnnotatorOptions } from './TextAnnotatorOptions';\nimport { SelectionHandler } from './SelectionHandler';\n\nimport './TextAnnotator.css';\n\nconst USE_DEFAULT_RENDERER: RendererType = 'SPANS';\n\nexport interface TextAnnotator<I extends TextAnnotation = TextAnnotation, E extends unknown = TextAnnotation> extends Annotator<I, E> {\n\n  element: HTMLElement;\n\n  setStyle(style: HighlightStyleExpression | undefined): void;\n\n  // Returns true if successful (or false if the annotation is not currently rendered)\n  scrollIntoView(annotationOrId: I | string): boolean;\n\n  state: TextAnnotatorState<I, E>;\n\n}\n\nexport const createTextAnnotator = <I extends TextAnnotation = TextAnnotation, E extends unknown = TextAnnotation>(\n  container: HTMLElement,\n  options: TextAnnotatorOptions<I, E> = {}\n): TextAnnotator<I, E> => {\n  // Prevent mobile browsers from triggering word selection on single click.\n  cancelSingleClickEvents(container);\n\n  // Make sure that the container is focusable and can receive both pointer and keyboard events\n  programmaticallyFocusable(container);\n\n  const opts = fillDefaults<I, E>(options, {\n    annotatingEnabled: true,\n    user: createAnonymousGuest()\n  });\n\n  const state: TextAnnotatorState<I, E> =\n    createTextAnnotatorState<I, E>(container, opts.userSelectAction);\n\n  const { selection, viewport } = state;\n\n  const store: TextAnnotationStore<I> = state.store;\n\n  const undoStack = createUndoStack<I>(store);\n\n  const lifecycle = createLifecycleObserver<I, E>(state, undoStack, opts.adapter);\n\n  let currentUser: User = opts.user;\n\n  // Use selected renderer, or fall back to default. If CSS_HIGHLIGHT is\n  // requested, check if CSS Custom Highlights are supported, and fall\n  // back to default renderer if not.\n  const useRenderer: RendererType =\n    opts.renderer === 'CSS_HIGHLIGHTS'\n      ? Boolean(CSS.highlights) ? 'CSS_HIGHLIGHTS' : USE_DEFAULT_RENDERER\n      : opts.renderer || USE_DEFAULT_RENDERER;\n\n  const highlightRenderer =\n    useRenderer === 'SPANS' ? createSpansRenderer(container, state, viewport) :\n    useRenderer === 'CSS_HIGHLIGHTS' ? createHighlightsRenderer(container, state, viewport) :\n    useRenderer === 'CANVAS' ? createCanvasRenderer(container, state, viewport) : undefined;\n\n  if (!highlightRenderer)\n    throw `Unknown renderer implementation: ${useRenderer}`;\n\n  console.debug(`Using ${useRenderer} renderer`);\n\n  if (opts.style)\n    highlightRenderer.setStyle(opts.style);\n\n  const selectionHandler = SelectionHandler(container, state, opts);\n  selectionHandler.setUser(currentUser);\n\n  /*************************/\n  /*      External API     */\n  /******++++++*************/\n\n  // Most of the external API functions are covered in the base annotator\n  const base = createBaseAnnotator<I, E>(state, undoStack, opts.adapter);\n\n  const getUser = () => currentUser;\n\n  const setFilter = (filter?: Filter<I>) => {\n    highlightRenderer.setFilter(filter);\n    selectionHandler.setFilter(filter);\n  }\n\n  const setStyle = (style: HighlightStyleExpression | undefined) =>\n    highlightRenderer.setStyle(style);\n\n  const setUser = (user: User) => {\n    currentUser = user;\n    selectionHandler.setUser(user);\n  }\n\n  const setPresenceProvider = (provider: PresenceProvider) => {\n    if (provider) {\n      highlightRenderer.setPainter(createPresencePainter(provider, opts.presence));\n      provider.on('selectionChange', () => highlightRenderer.redraw());\n    }\n  }\n\n  const setSelected = (arg?: string | string[]) => {\n    if (arg) {\n      selection.setSelected(arg);\n    } else {\n      selection.clear();\n    }\n  }\n\n  const setVisible = (visible: boolean) =>\n    highlightRenderer.setVisible(visible);\n\n  const destroy = () => {\n    highlightRenderer.destroy();\n    selectionHandler.destroy();\n\n    // Other cleanup actions\n    undoStack.destroy();\n  }\n\n  return {\n    ...base,\n    destroy,\n    element: container,\n    getUser,\n    setFilter,\n    setStyle,\n    setUser,\n    setSelected,\n    setPresenceProvider,\n    setVisible,\n    on: lifecycle.on,\n    off: lifecycle.off,\n    scrollIntoView: scrollIntoView(container, store),\n    state\n  }\n\n}\n"],"names":["NOT_ANNOTATABLE_CLASS","NOT_ANNOTATABLE_SELECTOR","isNotAnnotatable","node","_a","isRangeAnnotatable","range","ancestor","cancelSingleClickEvents","container","event","clonePointerEvent","cloneKeyboardEvent","isMac","programmaticallyFocusable","debounce","func","delay","timeoutId","args","iterateNotAnnotatableElements","notAnnotatableIterator","notAnnotatableNode","splitAnnotatableRanges","annotatableRanges","prevNotAnnotatable","notAnnotatable","subRange","lastRange","getRangeAnnotatableContents","contents","el","getQuoteContext","length","offsetReferenceSelector","offsetReference","rangeBefore","before","rangeAfter","after","isRevived","selector","s","whitespaceOrEmptyRegex","isWhitespaceOrEmpty","getRelation","rectA","rectB","round","num","a","b","union","left","right","top","bottom","mergeClientRects","rects","merged","next","wasMerged","relation","toDomRectList","index","i","rangeToSelector","quote","start","end","reviveSelector","_b","iterator","runningOffset","n","startCounting","len","reviveTarget","target","reviveAnnotation","annotation","trimRangeToContainer","trimmedRange","getScrollParent","overflowY","scrollIntoView","store","annotationOrId","id","scroll","parentBounds","scrollParent","parentHeight","parentWidth","annotationBounds","width","height","offsetTop","offsetLeft","scrollTop","scrollLeft","current","revived","DEFAULT_STYLE","DEFAULT_SELECTED_STYLE","paint","highlight","viewportBounds","style","painter","zIndex","base","getViewportBounds","innerWidth","innerHeight","minX","minY","maxX","maxY","trackViewport","viewport","visible","annotations","ids","createBaseRenderer","state","renderer","selection","hover","currentStyle","currentFilter","currentPainter","onDraw","onPointerMove","x","y","hit","redraw","lazy","bounds","annotationsInView","selectedIds","highlights","selected","hovered","setPainter","setStyle","setFilter","filter","onStoreChange","unsubscribeSelection","onScroll","onResize","resizeObserver","config","mutationObserver","records","record","createCanvas","canvas","resetCanvas","highres","createRenderer","ctx","highlightA","highlightB","createdA","createdB","h","offsetRects","underlineOffset","createCanvasRenderer","r","t","e","u","o","g","d","f","c","l","p","v","m","N","M","H","$","j","w","toCSS","colord","elem","currentRendered","nextRendered","updatedCSS","ranges","createHighlightsRenderer","has","dequal","foo","bar","ctor","computeZIndex","rect","all","intersects","getLength","total","intersecting","highlightLayer","shouldRedraw","span","createSpansRenderer","byteToHex","unsafeStringify","arr","offset","getRandomValues","rnds8","rng","randomUUID","native","v4","options","buf","rnds","k","V","X","A","Ue","Z","z","Se","C","D","U","W","E","T","R","F","_","K","ee","te","q","G","Y","De","ne","oe","se","ie","J","O","re","ae","ce","Oe","S","L","B","I","P","Q","le","Be","xe","Ie","ue","Ne","fe","pe","ge","he","me","Ve","Ae","be","_e","Ye","W3CTextFormat","source","serialized","parseW3CTextAnnotation","serializeW3CTextAnnotation","isTextSelector","parseW3CTextTargets","annotationId","creator","created","modified","w3cTargets","parsed","parseW3CUser","w3cTarget","w3cSelector","missingTypes","uuidv4","body","rest","bodies","parseW3CBodies","updated","targetRest","prefix","suffix","w3cSelectors","serializeW3CBodies","quickselect","compare","defaultCompare","sd","newLeft","newRight","swap","tmp","RBush","maxEntries","bbox","result","toBBox","nodesToSearch","child","childBBox","contains","data","tmpNode","item","createNode","equalsFn","path","indexes","parent","goingUp","findItem","items","calcBBox","N2","N1","multiSelect","right2","right3","level","minArea","minEnlargement","targetNode","area","bboxArea","enlargement","enlargedArea","isNode","insertPath","extend","splitIndex","newNode","minOverlap","bbox1","distBBox","bbox2","overlap","intersectionArea","compareMinX","compareNodeMinX","compareMinY","compareNodeMinY","xMargin","yMargin","leftBBox","rightBBox","margin","bboxMargin","siblings","destNode","children","stack","mid","createSpatialTree","tree","toItems","revivedRange","clear","insert","remove","update","set","targets","replace","rectsByTarget","allRects","getAt","hits","getAnnotationBounds","getAnnotationRects","indexed","annotationIds","createTextAnnotatorState","defaultUserSelectAction","createStore","createSelectionState","createHoverState","createViewportState","addAnnotation","origin","Origin","isValid","bulkAddAnnotation","couldNotRevive","bulkUpsertAnnotations","updateTarget","bulkUpdateTargets","getAll","filtered","getIntersecting","recalculatePositions","changes","deleted","newValue","context","createPresencePainter","provider","opts","trackedAnnotations","getAnnotationsForUser","user","isSelected","metrics","labelWidth","labelHeight","paddingBottom","isff","addEvent","object","method","useCapture","removeEvent","getMods","modifier","key","mods","getKeys","keys","compareArray","a1","a2","arr1","arr2","isIndex","_keyMap","_modifier","modifierMap","_mods","_handlers","_downKeys","winListendFocus","_scope","elementEventMap","code","getKey","getModifier","setScope","scope","getScope","getPressedKeyCodes","getPressedKeyString","getAllKeyCodes","_ref","shortcut","tagName","flag","isInput","isPressed","keyCode","deleteScope","newScope","handlers","_ref2","element","removeKeyEvent","clearModifier","hotkeys","unbind","keysInfo","info","eachUnbind","_len","_key","_ref3","splitKey","originKey","unbindKeys","lastKey","unbindElements","isUnbind","eventHandler","handler","modifiersMatch","dispatch","asterisk","keyName","keyNum","handlerKey","keyLen","keyShortcut","_downKeysCurrent","option","keyup","keydown","capture","single","keydownListener","keyupListenr","listener","trigger","values","_ref4","_api","_hotkeys","deep","CLICK_TIMEOUT","ARROW_KEYS","SELECT_ALL","SELECTION_KEYS","SelectionHandler","currentUser","annotatingEnabled","selectionMode","setUser","currentTarget","isLeftClick","lastDownEvent","onSelectStart","evt","onSelectionChange","sel","timeDifference","selectionRange","containedRange","onPointerDown","onPointerUp","clickSelect","currentIds","nextIds","upsertCurrentTarget","onContextMenu","onKeyup","onSelectAll","onSelected","handleArrowKeyPress","existingAnnotation","existingTargetUpdated","currentTargetUpdated","fillDefaults","defaults","USE_DEFAULT_RENDERER","createTextAnnotator","createAnonymousGuest","undoStack","createUndoStack","lifecycle","createLifecycleObserver","useRenderer","highlightRenderer","selectionHandler","createBaseAnnotator","arg"],"mappings":"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","x_google_ignoreList":[22,24,26,27,28,29,30,32,33,37]}
{"version":3,"file":"react-text-annotator.es5.js","sources":["../src/TextAnnotationPopup/TextAnnotationPopup.tsx"],"sourcesContent":["import { ReactNode, useEffect, useMemo, useRef, useState } from 'react';\nimport { useAnnotator, useSelection } from '@annotorious/react';\nimport {\n  NOT_ANNOTATABLE_CLASS,\n  toDomRectList,\n  type TextAnnotation,\n  type TextAnnotator,\n} from '@recogito/text-annotator';\n\nimport { isMobile } from './isMobile';\nimport {\n  arrow,\n  autoUpdate,\n  flip,\n  FloatingArrow,\n  FloatingArrowProps,\n  FloatingFocusManager,\n  FloatingPortal,\n  inline,\n  offset,\n  shift,\n  useDismiss,\n  useFloating,\n  useInteractions,\n  useRole\n} from '@floating-ui/react';\n\nimport './TextAnnotationPopup.css';\n\ninterface TextAnnotationPopupProps {\n\n  ariaCloseWarning?: string;\n\n  arrow?: boolean;\n\n  arrowProps?: Omit<FloatingArrowProps, 'context' | 'ref'>;\n\n  popup(props: TextAnnotationPopupContentProps): ReactNode;\n\n}\n\nexport interface TextAnnotationPopupContentProps {\n\n  annotation: TextAnnotation;\n\n  editable?: boolean;\n\n  event?: PointerEvent | KeyboardEvent;\n\n}\n\nconst toViewportBounds = (annotationBounds: DOMRect, container: HTMLElement): DOMRect => {\n  const { left, top, right, bottom } = annotationBounds;\n  const containerBounds = container.getBoundingClientRect();\n  return new DOMRect(left + containerBounds.left, top + containerBounds.top, right - left, bottom - top);\n}\n\nexport const TextAnnotationPopup = (props: TextAnnotationPopupProps) => {\n\n  const r = useAnnotator<TextAnnotator>();\n\n  const { selected, event } = useSelection<TextAnnotation>();\n\n  const annotation = selected[0]?.annotation;\n\n  const [isOpen, setOpen] = useState(selected?.length > 0);\n\n  const arrowRef = useRef(null);\n\n  const { refs, floatingStyles, update, context } = useFloating({\n    placement: isMobile() ? 'bottom' : 'top',\n    open: isOpen,\n    onOpenChange: (open, _event, reason) => {\n      if (!open && (reason === 'escape-key' || reason === 'focus-out')) {\n        setOpen(open);\n        r?.cancelSelected();\n      }\n    },\n    middleware: [\n      inline(),\n      offset(10),\n      flip({ crossAxis: true }),\n      shift({ crossAxis: true, padding: 10 }),\n      arrow({ element: arrowRef })\n    ],\n    whileElementsMounted: autoUpdate\n  });\n\n  const dismiss = useDismiss(context);\n\n  const role = useRole(context, { role: 'dialog' });\n\n  const { getFloatingProps } = useInteractions([dismiss, role]);\n\n  useEffect(() => {\n    if (annotation?.id) {\n      const bounds = r?.state.store.getAnnotationBounds(annotation.id);\n      setOpen(Boolean(bounds));\n    } else {\n      setOpen(false);\n    }\n  }, [annotation?.id, r?.state.store]);\n\n  useEffect(() => {\n    if (!r) return;\n\n    if (isOpen && annotation?.id) {\n      refs.setPositionReference({\n        getBoundingClientRect: () => {\n          // Annotation bounds are relative to the document element\n          const bounds = r.state.store.getAnnotationBounds(annotation.id);\n          return bounds\n            ? toViewportBounds(bounds, r.element)\n            : new DOMRect();\n        },\n        getClientRects: () => {\n          const rects = r.state.store.getAnnotationRects(annotation.id);\n          const viewportRects = rects.map(rect => toViewportBounds(rect, r.element));\n          return toDomRectList(viewportRects);\n        }\n      });\n    } else {\n      refs.setPositionReference(null);\n    }\n  }, [isOpen, annotation?.id, annotation?.target, r]);\n\n  useEffect(() => {\n    const config: MutationObserverInit = { attributes: true, childList: true, subtree: true };\n\n    const mutationObserver = new MutationObserver(() => update());\n    mutationObserver.observe(document.body, config);\n\n    window.document.addEventListener('scroll', update, true);\n\n    return () => {\n      mutationObserver.disconnect();\n      window.document.removeEventListener('scroll', update, true);\n    };\n  }, [update]);\n\n  // Don't shift focus to the floating element if selected via keyboard or on mobile.\n  const initialFocus = useMemo(() => {\n    return (event?.type === 'keyup' || event?.type === 'contextmenu' || isMobile()) ? -1 : 0;\n  }, [event]);\n\n  const onClose = () => r?.cancelSelected();\n\n  return isOpen && annotation ? (\n    <FloatingPortal>\n      <FloatingFocusManager\n        context={context}\n        modal={false}\n        closeOnFocusOut={true}\n        returnFocus={false}\n        initialFocus={initialFocus}>\n        <div\n          className={`a9s-popup r6o-popup annotation-popup r6o-text-popup ${NOT_ANNOTATABLE_CLASS}`}\n          ref={refs.setFloating}\n          style={floatingStyles}\n          {...getFloatingProps(getStopEventsPropagationProps())}>\n          {props.popup({\n            annotation: selected[0].annotation,\n            editable: selected[0].editable,\n            event\n          })}\n\n          {props.arrow && (\n            <FloatingArrow\n              ref={arrowRef}\n              context={context}\n              {...(props.arrowProps || {})} />\n          )}\n\n          <button className=\"r6o-popup-sr-only\" aria-live=\"assertive\" onClick={onClose}>\n            {props.ariaCloseWarning || 'Click or leave this dialog to close it.'}\n          </button>\n        </div>\n      </FloatingFocusManager>\n    </FloatingPortal>\n  ) : null;\n\n}\n\n/**\n * Prevent text-annotator from handling the irrelevant events\n * triggered from the popup/toolbar/dialog\n */\nconst getStopEventsPropagationProps = <T extends HTMLElement = HTMLElement>() => ({\n  onPointerUp: (event: React.PointerEvent<T>) => event.stopPropagation(),\n  onPointerDown: (event: React.PointerEvent<T>) => event.stopPropagation(),\n  onMouseDown: (event: React.MouseEvent<T>) => event.stopPropagation(),\n  onMouseUp: (event: React.MouseEvent<T>) => event.stopPropagation()\n});\n\n/** For backwards compatibility **/\n/** @deprecated Use TextAnnotationPopup instead */\nexport const TextAnnotatorPopup = (props: TextAnnotationPopupProps) => {\n\n  useEffect(() => {\n    console.warn('TextAnnotatorPopup is deprecated and will be removed in a future version. Please use TextAnnotationPopup instead.');\n  }, []);\n\n  return <TextAnnotationPopup {...props} />;\n};\n"],"names":["jsx","jsxs"],"mappings":"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"}